import { Klass } from "../../compiler/types/Class.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { voidPrimitiveType, stringPrimitiveType, booleanPrimitiveType, doublePrimitiveType, intPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { WorldHelper } from "./World.js";
export class Actor extends Klass {
    constructor(module) {
        super("Actor", module, "Abstrakte Klasse mit überschreibbaren Methoden act (zur Implementierung eines Timers) und onKeyTyped, onKeyUp usw. zur Entgegennahme von Tastaturereignissen");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.isAbstract = true;
        let methodSignatures = [
            { signature: "onKeyTyped(String)", actorListIdentifier: "keyPressedActors" },
            { signature: "onKeyUp(String)", actorListIdentifier: "keyUpActors" },
            { signature: "onKeyDown(String)", actorListIdentifier: "keyDownActors" },
            { signature: "act()", actorListIdentifier: "actActors" },
            { signature: "act(double)", actorListIdentifier: "actActors" },
        ];
        this.postConstructorCallbacks = [
            (r) => {
                for (let ms of methodSignatures) {
                    let method = r.class.getMethodBySignature(ms.signature);
                    if ((method === null || method === void 0 ? void 0 : method.program) != null
                    // || method?.invoke != null
                    ) {
                        let ah = r.intrinsicData['Actor'];
                        ah.worldHelper[ms.actorListIdentifier].push({
                            actorHelper: ah,
                            method: method
                        });
                    }
                }
            }
        ];
        this.addMethod(new Method("Actor", new Parameterlist([
        // { identifier: "deltaTimeInMs", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), this,
        ]), null, (parameters) => {
            let o = parameters[0].value;
            let actorHelper = new ActorHelper(module.main.getInterpreter(), o);
            o.intrinsicData["Actor"] = actorHelper;
            // return o;
        }, // no implementation!
        false, false, "Der Konstruktor registriert den Actor beim Grafikfenster", true));
        this.addMethod(new Method("destroy", new Parameterlist([]), null, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            sh.destroy();
        }, false, false, "Vernichtet das Grafikobjekt. Falls es in einem Group-Objekt enthalten ist, wird es vor dem Vernichten automatisch aus diesem entfernt.", false));
        this.addMethod(new Method("isKeyUp", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let key = parameters[1].value;
            let sh = o.intrinsicData["Actor"];
            return !sh.isKeyDown(key);
        }, false, false, "Gibt genau dann true zurück, wenn der Benutzer die gegebenen Taste gerade NICHT drückt. Als Taste kann auch bsw. [shift]+m angegeben werden. Die Angabe von Sondertasten (Enter, ArrowUp, ArrowLeft, ...) ist auch möglich.", false));
        this.addMethod(new Method("isKeyDown", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let key = parameters[1].value;
            let sh = o.intrinsicData["Actor"];
            return sh.isKeyDown(key);
        }, false, false, "Gibt genau dann true zurück, wenn der Benutzer die gegebenen Taste gerade drückt. Als Taste kann auch bsw. [shift]+m angegeben werden. Die Angabe von Sondertasten (Enter, ArrowUp, ArrowLeft, ...) ist auch möglich.", false));
        this.addMethod(new Method("isGamepadButtonDown", new Parameterlist([
            { identifier: "gamepadIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "buttonIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let gamepadIndex = parameters[1].value;
            let buttonIndex = parameters[2].value;
            return module.main.getInterpreter().gamepadTool.isGamepadButtonPressed(gamepadIndex, buttonIndex);
        }, false, false, "Gibt genau dann true zurück, wenn der Button buttonIndex des Gamepads GamepadIndex gedrückt ist.", false));
        this.addMethod(new Method("isGamepadConnected", new Parameterlist([
            { identifier: "gamepadIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let gamepadIndex = parameters[1].value;
            return module.main.getInterpreter().gamepadTool.isGamepadConnected(gamepadIndex);
        }, false, false, "Gibt true zurück, falls das Gamepad mit dem übergebenen Index angeschlossen ist. VORSICHT: Das erste Gamepad hat Index 0.", false));
        this.addMethod(new Method("getGamepadAxisValue", new Parameterlist([
            { identifier: "gamepadIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "axisIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), doublePrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let gamepadIndex = parameters[1].value;
            let axisIndex = parameters[2].value;
            return module.main.getInterpreter().gamepadTool.getGamepadAxisValue(gamepadIndex, axisIndex);
        }, false, false, "Gibt den Wert des Gamepad-Steuerknüppels mit Index axisIndex zurück.", false));
        this.addMethod(new Method("isDestroyed", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            return sh.isDestroyed;
        }, false, false, "Gibt true zurück, falls das Objekt bereits durch die Methode destroy() zerstört wurde.", false));
        this.addMethod(new Method("getWorld", new Parameterlist([]), module.typeStore.getType("World"), (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            let interpreter = module.main.getInterpreter();
            let worldHelper = interpreter.worldHelper;
            if (worldHelper == null) {
                let w = new RuntimeObject(interpreter.moduleStore.getType("World").type);
                worldHelper = new WorldHelper(800, 600, interpreter.moduleStore.getModule("Base Module"), w);
            }
            return worldHelper.world;
        }, false, false, "Gibt das Welt-Objekt zurück.", false));
        this.addMethod(new Method("stopActing", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let ah = o.intrinsicData["Actor"];
            // ah.timerPaused = true;
            ah.setTimerPaused(true);
            return;
        }, false, false, "Stoppt den 30-mal pro Sekunde erfolgenden Aufruf der Methode act für dieses Objekt.", false));
        this.addMethod(new Method("restartActing", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            // sh.timerPaused = false;
            sh.setTimerPaused(false);
        }, false, false, "Startet den 30-mal pro Sekunde erfolgenden Aufruf der Methode act für dieses Objekt erneut.", false));
        this.addMethod(new Method("isActing", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let sh = o.intrinsicData["Actor"];
            return !sh.timerPaused;
        }, false, false, "Gibt true zurück, wenn der periodische Aufruf der Methode act weiterhin erfolgt.", false));
        this.addMethod(new Method("act", new Parameterlist([
            { identifier: "deltaTime", type: doublePrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no statements!
        false, false, "Wird ca. 30-mal pro Sekunde aufgerufen", false));
        this.addMethod(new Method("act", new Parameterlist([]), voidPrimitiveType, null, false, false, "Wird ca. 30-mal pro Sekunde aufgerufen", false));
        this.addMethod(new Method("onKeyTyped", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, () => {
        }, false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste gedrückt und wieder losgelassen hat.", false));
        this.addMethod(new Method("onKeyDown", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, () => {
        }, false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste gedrückt hat.", false));
        this.addMethod(new Method("onKeyUp", new Parameterlist([
            { identifier: "key", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, () => {
        }, false, false, "Wird aufgerufen, nachdem der Benutzer eine Taste losgelassen hat.", false));
    }
    registerWorldType() {
        this.methods.filter(m => m.identifier == "getWorld")[0].returnType = this.module.typeStore.getType("World");
    }
}
export class ActorHelper {
    constructor(interpreter, runtimeObject) {
        this.runtimeObject = runtimeObject;
        this.isDestroyed = false;
        this.timerPaused = false;
        let worldHelper = interpreter.worldHelper;
        if (worldHelper == null) {
            let w = new RuntimeObject(interpreter.moduleStore.getType("World").type);
            worldHelper = new WorldHelper(800, 600, interpreter.moduleStore.getModule("Base Module"), w);
            // worldHelper = new WorldHelper(800, 600, interpreter.main.currentWorkspace.moduleStore.getModule("Base Module"), w);
            w.intrinsicData["World"] = worldHelper;
            if (runtimeObject.intrinsicData["isGNG"]) {
                worldHelper.setBackgroundColor("#e6e6e6");
            }
        }
        this.worldHelper = worldHelper;
    }
    setTimerPaused(tp) {
        this.timerPaused = tp;
    }
    isKeyDown(key) {
        return this.worldHelper.interpreter.keyboardTool.isPressed(key);
    }
    destroy() {
        this.isDestroyed = true;
        console.log("destroying", this);
        this.worldHelper.actorHelpersToDestroy.push(this);
    }
    testdestroyed(method) {
        if (this.isDestroyed) {
            this.worldHelper.interpreter.throwException("Es wurde die Methode " + method + " eines bereits mit destroy() zerstörten Grafikobjekts aufgerufen.");
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L3J1bnRpbWVsaWJyYXJ5L2dyYXBoaWNzL0FjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBRSxvQkFBb0IsRUFBRSxtQkFBbUIsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQzdKLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNuRSxPQUFPLEVBQUUsV0FBVyxFQUFjLE1BQU0sWUFBWSxDQUFDO0FBR3JELE1BQU0sT0FBTyxLQUFNLFNBQVEsS0FBSztJQUU1QixZQUFZLE1BQWM7UUFFdEIsS0FBSyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsOEpBQThKLENBQUMsQ0FBQztRQUV2TCxJQUFJLENBQUMsWUFBWSxDQUFRLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFFdkIsSUFBSSxnQkFBZ0IsR0FBeUQ7WUFDekUsRUFBRSxTQUFTLEVBQUUsb0JBQW9CLEVBQUUsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUU7WUFDNUUsRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQUUsYUFBYSxFQUFFO1lBQ3BFLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixFQUFFLG1CQUFtQixFQUFFLGVBQWUsRUFBRTtZQUN4RSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsV0FBVyxFQUFFO1lBQ3hELEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxt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c0hBQXNIO1lBQ3RILENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsV0FBVyxDQUFDO1lBQ3ZDLElBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBQztnQkFDcEMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzdDO1NBQ0o7UUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztJQUNuQyxDQUFDO0lBRUQsY0FBYyxDQUFDLEVBQVc7UUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdELFNBQVMsQ0FBQyxHQUFXO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxhQUFhLENBQUMsTUFBYztRQUN4QixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLHVCQUF1QixHQUFHLE1BQU0sR0FBRyxtRUFBbUUsQ0FBQyxDQUFDO1lBQ3BKLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnRlcmZhY2UsIEtsYXNzIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IE1vZHVsZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IE1ldGhvZCwgUGFyYW1ldGVybGlzdCB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9UeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyB2b2lkUHJpbWl0aXZlVHlwZSwgc3RyaW5nUHJpbWl0aXZlVHlwZSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsIGRvdWJsZVByaW1pdGl2ZVR5cGUsIGludFByaW1pdGl2ZVR5cGUgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvUHJpbWl0aXZlVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgUnVudGltZU9iamVjdCB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9SdW50aW1lT2JqZWN0LmpzXCI7XHJcbmltcG9ydCB7IFdvcmxkSGVscGVyLCBXb3JsZENsYXNzIH0gZnJvbSBcIi4vV29ybGQuanNcIjtcclxuaW1wb3J0IHsgSW50ZXJwcmV0ZXIgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvSW50ZXJwcmV0ZXIuanNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBBY3RvciBleHRlbmRzIEtsYXNzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSkge1xyXG5cclxuICAgICAgICBzdXBlcihcIkFjdG9yXCIsIG1vZHVsZSwgXCJBYnN0cmFrdGUgS2xhc3NlIG1pdCDDvGJlcnNjaHJlaWJiYXJlbiBNZXRob2RlbiBhY3QgKHp1ciBJbXBsZW1lbnRpZXJ1bmcgZWluZXMgVGltZXJzKSB1bmQgb25LZXlUeXBlZCwgb25LZXlVcCB1c3cuIHp1ciBFbnRnZWdlbm5haG1lIHZvbiBUYXN0YXR1cmVyZWlnbmlzc2VuXCIpO1xyXG5cclxuICAgICAgICB0aGlzLnNldEJhc2VDbGFzcyg8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiT2JqZWN0XCIpKTtcclxuICAgICAgICB0aGlzLmlzQWJzdHJhY3QgPSB0cnVlO1xyXG5cclxuICAgICAgICBsZXQgbWV0aG9kU2lnbmF0dXJlczogeyBzaWduYXR1cmU6IHN0cmluZywgYWN0b3JMaXN0SWRlbnRpZmllcjogc3RyaW5nIH1bXSA9IFtcclxuICAgICAgICAgICAgeyBzaWduYXR1cmU6IFwib25LZXlUeXBlZChTdHJpbmcpXCIsIGFjdG9yTGlzdElkZW50aWZpZXI6IFwia2V5UHJlc3NlZEFjdG9yc1wiIH0sXHJcbiAgICAgICAgICAgIHsgc2lnbmF0dXJlOiBcIm9uS2V5VXAoU3RyaW5nKVwiLCBhY3Rvckxpc3RJZGVudGlmaWVyOiBcImtleVVwQWN0b3JzXCIgfSxcclxuICAgICAgICAgICAgeyBzaWduYXR1cmU6IFwib25LZXlEb3duKFN0cmluZylcIiwgYWN0b3JMaXN0SWRlbnRpZmllcjogXCJrZXlEb3duQWN0b3JzXCIgfSxcclxuICAgICAgICAgICAgeyBzaWduYXR1cmU6IFwiYWN0KClcIiwgYWN0b3JMaXN0SWRlbnRpZmllcjogXCJhY3RBY3RvcnNcIiB9LFxyXG4gICAgICAgICAgICB7IHNpZ25hdHVyZTogXCJhY3QoZG91YmxlKVwiLCBhY3Rvckxpc3RJZGVudGlmaWVyOiBcImFjdEFjdG9yc1wiIH0sXHJcbiAgICAgICAgXTtcclxuXHJcbiAgICAgICAgdGhpcy5wb3N0Q29uc3RydWN0b3JDYWxsYmFja3MgPSBbXHJcbiAgICAgICAgICAgIChyOiBSdW50aW1lT2JqZWN0KSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbXMgb2YgbWV0aG9kU2lnbmF0dXJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBtZXRob2Q6IE1ldGhvZCA9ICg8S2xhc3M+ci5jbGFzcykuZ2V0TWV0aG9kQnlTaWduYXR1cmUobXMuc2lnbmF0dXJlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZD8ucHJvZ3JhbSAhPSBudWxsIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB8fCBtZXRob2Q/Lmludm9rZSAhPSBudWxsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYWg6IEFjdG9ySGVscGVyID0gPEFjdG9ySGVscGVyPnIuaW50cmluc2ljRGF0YVsnQWN0b3InXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWgud29ybGRIZWxwZXJbbXMuYWN0b3JMaXN0SWRlbnRpZmllcl0ucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RvckhlbHBlcjogYWgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiQWN0b3JcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICAvLyB7IGlkZW50aWZpZXI6IFwiZGVsdGFUaW1lSW5Nc1wiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIC8vIF0pLCB0aGlzLFxyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgYWN0b3JIZWxwZXIgPSBuZXcgQWN0b3JIZWxwZXIobW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKSwgbyk7XHJcblxyXG4gICAgICAgICAgICAgICAgby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl0gPSBhY3RvckhlbHBlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gbztcclxuXHJcbiAgICAgICAgICAgIH0sICAvLyBubyBpbXBsZW1lbnRhdGlvbiFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIkRlciBLb25zdHJ1a3RvciByZWdpc3RyaWVydCBkZW4gQWN0b3IgYmVpbSBHcmFmaWtmZW5zdGVyXCIsIHRydWUpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImRlc3Ryb3lcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBzaDogQWN0b3JIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcclxuICAgICAgICAgICAgICAgIHNoLmRlc3Ryb3koKTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJWZXJuaWNodGV0IGRhcyBHcmFmaWtvYmpla3QuIEZhbGxzIGVzIGluIGVpbmVtIEdyb3VwLU9iamVrdCBlbnRoYWx0ZW4gaXN0LCB3aXJkIGVzIHZvciBkZW0gVmVybmljaHRlbiBhdXRvbWF0aXNjaCBhdXMgZGllc2VtIGVudGZlcm50LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiaXNLZXlVcFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJrZXlcIiwgdHlwZTogc3RyaW5nUHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IGtleTogc3RyaW5nID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBzaDogQWN0b3JIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIXNoLmlzS2V5RG93bihrZXkpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgZ2VuYXUgZGFubiB0cnVlIHp1csO8Y2ssIHdlbm4gZGVyIEJlbnV0emVyIGRpZSBnZWdlYmVuZW4gVGFzdGUgZ2VyYWRlIE5JQ0hUIGRyw7xja3QuIEFscyBUYXN0ZSBrYW5uIGF1Y2ggYnN3LiBbc2hpZnRdK20gYW5nZWdlYmVuIHdlcmRlbi4gRGllIEFuZ2FiZSB2b24gU29uZGVydGFzdGVuIChFbnRlciwgQXJyb3dVcCwgQXJyb3dMZWZ0LCAuLi4pIGlzdCBhdWNoIG3DtmdsaWNoLlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiaXNLZXlEb3duXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCBib29sZWFuUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5OiBzdHJpbmcgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBzaC5pc0tleURvd24oa2V5KTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJHaWJ0IGdlbmF1IGRhbm4gdHJ1ZSB6dXLDvGNrLCB3ZW5uIGRlciBCZW51dHplciBkaWUgZ2VnZWJlbmVuIFRhc3RlIGdlcmFkZSBkcsO8Y2t0LiBBbHMgVGFzdGUga2FubiBhdWNoIGJzdy4gW3NoaWZ0XSttIGFuZ2VnZWJlbiB3ZXJkZW4uIERpZSBBbmdhYmUgdm9uIFNvbmRlcnRhc3RlbiAoRW50ZXIsIEFycm93VXAsIEFycm93TGVmdCwgLi4uKSBpc3QgYXVjaCBtw7ZnbGljaC5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImlzR2FtZXBhZEJ1dHRvbkRvd25cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiZ2FtZXBhZEluZGV4XCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiYnV0dG9uSW5kZXhcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IGdhbWVwYWRJbmRleDogbnVtYmVyID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBidXR0b25JbmRleDogbnVtYmVyID0gcGFyYW1ldGVyc1syXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKS5nYW1lcGFkVG9vbC5pc0dhbWVwYWRCdXR0b25QcmVzc2VkKGdhbWVwYWRJbmRleCwgYnV0dG9uSW5kZXgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgZ2VuYXUgZGFubiB0cnVlIHp1csO8Y2ssIHdlbm4gZGVyIEJ1dHRvbiBidXR0b25JbmRleCBkZXMgR2FtZXBhZHMgR2FtZXBhZEluZGV4IGdlZHLDvGNrdCBpc3QuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJpc0dhbWVwYWRDb25uZWN0ZWRcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiZ2FtZXBhZEluZGV4XCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIGJvb2xlYW5QcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBnYW1lcGFkSW5kZXg6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCkuZ2FtZXBhZFRvb2wuaXNHYW1lcGFkQ29ubmVjdGVkKGdhbWVwYWRJbmRleCk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiR2lidCB0cnVlIHp1csO8Y2ssIGZhbGxzIGRhcyBHYW1lcGFkIG1pdCBkZW0gw7xiZXJnZWJlbmVuIEluZGV4IGFuZ2VzY2hsb3NzZW4gaXN0LiBWT1JTSUNIVDogRGFzIGVyc3RlIEdhbWVwYWQgaGF0IEluZGV4IDAuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJnZXRHYW1lcGFkQXhpc1ZhbHVlXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImdhbWVwYWRJbmRleFwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImF4aXNJbmRleFwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCBkb3VibGVQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBnYW1lcGFkSW5kZXg6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgYXhpc0luZGV4OiBudW1iZXIgPSBwYXJhbWV0ZXJzWzJdLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLmdhbWVwYWRUb29sLmdldEdhbWVwYWRBeGlzVmFsdWUoZ2FtZXBhZEluZGV4LCBheGlzSW5kZXgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgZGVuIFdlcnQgZGVzIEdhbWVwYWQtU3RldWVya27DvHBwZWxzIG1pdCBJbmRleCBheGlzSW5kZXggenVyw7xjay5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImlzRGVzdHJveWVkXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBzaC5pc0Rlc3Ryb3llZDtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJHaWJ0IHRydWUgenVyw7xjaywgZmFsbHMgZGFzIE9iamVrdCBiZXJlaXRzIGR1cmNoIGRpZSBNZXRob2RlIGRlc3Ryb3koKSB6ZXJzdMO2cnQgd3VyZGUuXCIsIGZhbHNlKSk7XHJcblxyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiZ2V0V29ybGRcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBtb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJXb3JsZFwiKSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2g6IEFjdG9ySGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiQWN0b3JcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGludGVycHJldGVyID0gbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICAgICAgICAgIGxldCB3b3JsZEhlbHBlciA9IGludGVycHJldGVyLndvcmxkSGVscGVyO1xyXG4gICAgICAgICAgICAgICAgaWYgKHdvcmxkSGVscGVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdzogUnVudGltZU9iamVjdCA9IG5ldyBSdW50aW1lT2JqZWN0KDxLbGFzcz5pbnRlcnByZXRlci5tb2R1bGVTdG9yZS5nZXRUeXBlKFwiV29ybGRcIikudHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgd29ybGRIZWxwZXIgPSBuZXcgV29ybGRIZWxwZXIoODAwLCA2MDAsIGludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldE1vZHVsZShcIkJhc2UgTW9kdWxlXCIpLCB3KTtcclxuICAgICAgICAgICAgICAgIH0gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHdvcmxkSGVscGVyLndvcmxkO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgZGFzIFdlbHQtT2JqZWt0IHp1csO8Y2suXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJzdG9wQWN0aW5nXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IGFoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGFoLnRpbWVyUGF1c2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGFoLnNldFRpbWVyUGF1c2VkKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJTdG9wcHQgZGVuIDMwLW1hbCBwcm8gU2VrdW5kZSBlcmZvbGdlbmRlbiBBdWZydWYgZGVyIE1ldGhvZGUgYWN0IGbDvHIgZGllc2VzIE9iamVrdC5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJyZXN0YXJ0QWN0aW5nXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHNoOiBBY3RvckhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHNoLnRpbWVyUGF1c2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBzaC5zZXRUaW1lclBhdXNlZChmYWxzZSk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiU3RhcnRldCBkZW4gMzAtbWFsIHBybyBTZWt1bmRlIGVyZm9sZ2VuZGVuIEF1ZnJ1ZiBkZXIgTWV0aG9kZSBhY3QgZsO8ciBkaWVzZXMgT2JqZWt0IGVybmV1dC5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJpc0FjdGluZ1wiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIGJvb2xlYW5QcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBzaDogQWN0b3JIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIXNoLnRpbWVyUGF1c2VkO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIkdpYnQgdHJ1ZSB6dXLDvGNrLCB3ZW5uIGRlciBwZXJpb2Rpc2NoZSBBdWZydWYgZGVyIE1ldGhvZGUgYWN0IHdlaXRlcmhpbiBlcmZvbGd0LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiYWN0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImRlbHRhVGltZVwiLCB0eXBlOiBkb3VibGVQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCwgLy8gbm8gc3RhdGVtZW50cyFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgY2EuIDMwLW1hbCBwcm8gU2VrdW5kZSBhdWZnZXJ1ZmVuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJhY3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgY2EuIDMwLW1hbCBwcm8gU2VrdW5kZSBhdWZnZXJ1ZmVuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJvbktleVR5cGVkXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIG5hY2hkZW0gZGVyIEJlbnV0emVyIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IHVuZCB3aWVkZXIgbG9zZ2VsYXNzZW4gaGF0LlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwib25LZXlEb3duXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImtleVwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIG5hY2hkZW0gZGVyIEJlbnV0emVyIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IGhhdC5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIm9uS2V5VXBcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwia2V5XCIsIHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgYXVmZ2VydWZlbiwgbmFjaGRlbSBkZXIgQmVudXR6ZXIgZWluZSBUYXN0ZSBsb3NnZWxhc3NlbiBoYXQuXCIsIGZhbHNlKSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZWdpc3RlcldvcmxkVHlwZSgpIHtcclxuICAgICAgICB0aGlzLm1ldGhvZHMuZmlsdGVyKG0gPT4gbS5pZGVudGlmaWVyID09IFwiZ2V0V29ybGRcIilbMF0ucmV0dXJuVHlwZSA9IHRoaXMubW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiV29ybGRcIik7XHJcbiAgICB9XHJcblxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEFjdG9ySGVscGVyIHtcclxuXHJcbiAgICB3b3JsZEhlbHBlcjogV29ybGRIZWxwZXI7XHJcbiAgICBpc0Rlc3Ryb3llZDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIHRpbWVyUGF1c2VkOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoaW50ZXJwcmV0ZXI6IEludGVycHJldGVyLCBwdWJsaWMgcnVudGltZU9iamVjdDogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCB3b3JsZEhlbHBlciA9IGludGVycHJldGVyLndvcmxkSGVscGVyO1xyXG4gICAgICAgIGlmICh3b3JsZEhlbHBlciA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxldCB3OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QoPEtsYXNzPmludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldFR5cGUoXCJXb3JsZFwiKS50eXBlKTtcclxuICAgICAgICAgICAgd29ybGRIZWxwZXIgPSBuZXcgV29ybGRIZWxwZXIoODAwLCA2MDAsIGludGVycHJldGVyLm1vZHVsZVN0b3JlLmdldE1vZHVsZShcIkJhc2UgTW9kdWxlXCIpLCB3KTtcclxuICAgICAgICAgICAgLy8gd29ybGRIZWxwZXIgPSBuZXcgV29ybGRIZWxwZXIoODAwLCA2MDAsIGludGVycHJldGVyLm1haW4uY3VycmVudFdvcmtzcGFjZS5tb2R1bGVTdG9yZS5nZXRNb2R1bGUoXCJCYXNlIE1vZHVsZVwiKSwgdyk7XHJcbiAgICAgICAgICAgIHcuaW50cmluc2ljRGF0YVtcIldvcmxkXCJdID0gd29ybGRIZWxwZXI7XHJcbiAgICAgICAgICAgIGlmKHJ1bnRpbWVPYmplY3QuaW50cmluc2ljRGF0YVtcImlzR05HXCJdKXtcclxuICAgICAgICAgICAgICAgIHdvcmxkSGVscGVyLnNldEJhY2tncm91bmRDb2xvcihcIiNlNmU2ZTZcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy53b3JsZEhlbHBlciA9IHdvcmxkSGVscGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVyUGF1c2VkKHRwOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy50aW1lclBhdXNlZCA9IHRwO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBpc0tleURvd24oa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JsZEhlbHBlci5pbnRlcnByZXRlci5rZXlib2FyZFRvb2wuaXNQcmVzc2VkKGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTtcclxuICAgICAgICBjb25zb2xlLmxvZyhcImRlc3Ryb3lpbmdcIiwgdGhpcyk7XHJcbiAgICAgICAgdGhpcy53b3JsZEhlbHBlci5hY3RvckhlbHBlcnNUb0Rlc3Ryb3kucHVzaCh0aGlzKTtcclxuICAgIH1cclxuXHJcbiAgICB0ZXN0ZGVzdHJveWVkKG1ldGhvZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgdGhpcy53b3JsZEhlbHBlci5pbnRlcnByZXRlci50aHJvd0V4Y2VwdGlvbihcIkVzIHd1cmRlIGRpZSBNZXRob2RlIFwiICsgbWV0aG9kICsgXCIgZWluZXMgYmVyZWl0cyBtaXQgZGVzdHJveSgpIHplcnN0w7ZydGVuIEdyYWZpa29iamVrdHMgYXVmZ2VydWZlbi5cIik7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG5cclxufVxyXG5cclxuIl19