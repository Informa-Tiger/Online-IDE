import { Klass } from "../../compiler/types/Class.js";
import { charPrimitiveType, intPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
export class GNGEreignisbehandlung extends Klass {
    constructor(module, moduleStore) {
        super("Ereignisbehandlung", module, "Zugriff auf Ereignisse einschließlich Taktgeber (Graphics'n Games-Bibliothek (Cornelsen-Verlag))");
        this.moduleStore = moduleStore;
        this.addMethod(new Method("Ereignisbehandlung", new Parameterlist([]), null, (parameters) => {
            let o = parameters[0].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.registerEvents(o);
        }, false, false, 'Instanziert ein neues Ereignisbehandlungs-Objekt.', true));
        // this.addMethod(new Method("GrößeSetzen", new Parameterlist([
        //     { identifier: "größe", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), null,
        //     (parameters) => {
        //         let o: RuntimeObject = parameters[0].value;
        //         let sh: GroupHelper = o.intrinsicData["Actor"];
        //         let groesse: number = parameters[1].value;
        //     }, false, false, "Setzt die Größe der Figur.", false));
        this.addMethod(new Method("Starten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).startTimer();
        }, false, false, "Zeitgeber starten.", false));
        this.addMethod(new Method("Anhalten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).stopTimer();
        }, false, false, "Zeitgeber anhalten.", false));
        this.addMethod(new Method("TaktdauerSetzen", new Parameterlist([
            { identifier: "dauer", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let dauer = parameters[1].value;
            GNGEreignisbehandlung.getHelper(module).taktdauer = dauer;
        }, false, true, 'Setzt die Taktdauer des Zeitgebers in Millisekunden', false));
        this.addMethod(new Method("TaktImpulsAusführen", new Parameterlist([]), voidPrimitiveType, null, // no implementation!
        false, false, "Diese Methode wird vom Taktgeber aufgerufen."));
        this.addMethod(new Method("TasteGedrückt", new Parameterlist([
            { identifier: "taste", type: charPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Taste gedrückt wird."));
        this.addMethod(new Method("SonderTasteGedrückt", new Parameterlist([
            { identifier: "taste", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Sondertaste gedrückt wird."));
        this.addMethod(new Method("MausGeklickt", new Parameterlist([
            { identifier: "x", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "y", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "anzahl", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine die linke Maustaste gedrückt wird."));
    }
    static getHelper(module) {
        let interpreter = module.main.getInterpreter();
        if (interpreter.gngEreignisbehandlungHelper == null) {
            interpreter.gngEreignisbehandlungHelper = new GNGEreignisbehandlungHelper(module);
            interpreter.gngEreignisbehandlungHelper.bindEvents();
        }
        return interpreter.gngEreignisbehandlungHelper;
    }
}
export class GNGEreignisbehandlungHelper {
    constructor(module) {
        this.module = module;
        this.aktionsempfaengerTypes = ["ausführen", "taste", "sondertaste", "geklickt"];
        this.methodSignatureList = ["TaktImpulsAusführen()", "Ausführen()", "AktionAusführen()", "MausGeklickt(int, int, int)", "Taste(char)", "TasteGedrückt(char)",
            "SonderTaste(int)", "SonderTasteGedrückt(int)"];
        this.methodToAktionsempfaengerTypeMap = {
            "TaktImpulsAusführen()": "ausführen",
            "Ausführen()": "ausführen",
            "AktionAusführen()": "ausführen",
            "MausGeklickt(int, int, int)": "geklickt",
            "Taste(char)": "taste",
            "TasteGedrückt(char)": "taste",
            "SonderTaste(int)": "sondertaste",
            "SonderTasteGedrückt(int)": "sondertaste"
        };
        // see https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/
        this.keyToKeyCodeMap = {
            "Enter": 13,
            "ArrowLeft": 37,
            "ArrowRight": 39,
            "ArrowUp": 38,
            "ArrowDown": 40,
            "F1": 112,
            "F2": 113,
            "F3": 114,
            "F4": 115,
            "F5": 116,
            "F6": 117,
            "F7": 118,
            "F8": 119,
            "F9": 120,
            "F10": 121,
            "F11": 122,
            "F12": 123,
            "PageUp": 33,
            "PageDown": 34,
            "Insert": 155
        };
        // For gng library (Cornelsen-Verlag):
        this.aktionsempfaengerMap = {};
        this.timerRunning = false;
        this.taktdauer = 300;
        this.remainingTime = 0;
        for (let type of this.aktionsempfaengerTypes) {
            this.aktionsempfaengerMap[type] = [];
        }
    }
    hasAktionsEmpfaenger() {
        for (let type of this.aktionsempfaengerTypes) {
            if (this.aktionsempfaengerMap[type].length > 0) {
                return true;
            }
        }
        return false;
    }
    registerEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let method = klass.getMethodBySignature(ms);
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            if ((method === null || method === void 0 ? void 0 : method.program) != null || (method === null || method === void 0 ? void 0 : method.invoke) != null) {
                this.aktionsempfaengerMap[type].push({
                    type: type,
                    method: method,
                    runtimeObject: o
                });
            }
        }
    }
    unregisterEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            this.aktionsempfaengerMap[type] =
                this.aktionsempfaengerMap[type].filter(ae => ae.runtimeObject != o);
        }
    }
    bindEvents() {
        let interpreter = this.module.main.getInterpreter();
        this.onKeyDownMethod = (key) => {
            if (key.length == 1) {
                for (let ae of this.aktionsempfaengerMap["taste"]) {
                    this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: key }]);
                }
            }
            else {
                let keyCode = this.keyToKeyCodeMap[key];
                if (keyCode != null) {
                    for (let ae of this.aktionsempfaengerMap["sondertaste"]) {
                        this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: keyCode }]);
                    }
                }
            }
        };
        interpreter.keyboardTool.keyDownCallbacks.push(this.onKeyDownMethod);
        // this.startTimer();
    }
    detachEvents() {
        let interpreter = this.module.main.getInterpreter();
        let index = interpreter.keyboardTool.keyDownCallbacks.indexOf(this.onKeyDownMethod);
        if (index >= 0)
            interpreter.keyboardTool.keyDownCallbacks.splice(index, 1);
        this.stopTimer();
    }
    invokeMethod(method, runtimeObject, parameters = [], callback) {
        let program = method.program;
        let invoke = method.invoke;
        parameters = parameters.slice(0);
        parameters.unshift({ type: runtimeObject.class, value: runtimeObject });
        if (program != null) {
            this.module.main.getInterpreter().runTimer(method, parameters, callback, false);
        }
        else if (invoke != null) {
            invoke(parameters);
        }
    }
    stopTimer() {
        this.timerRunning = false;
    }
    startTimer() {
        if (!this.timerRunning) {
            this.timerRunning = true;
            this.processTimerEntries();
        }
    }
    processTimerEntries() {
        if (!this.timerRunning)
            return;
        let dt = 10;
        this.remainingTime += dt;
        if (this.remainingTime > this.taktdauer) {
            this.remainingTime -= this.taktdauer;
            let liste = this.aktionsempfaengerMap["ausführen"];
            for (let ae of liste) {
                this.invokeMethod(ae.method, ae.runtimeObject, []);
            }
        }
        let that = this;
        setTimeout(() => {
            that.processTimerEntries();
        }, dt);
    }
    handleMouseClickedEvent(x, y) {
        let parameters = [
            { type: intPrimitiveType, value: Math.round(x) },
            { type: intPrimitiveType, value: Math.round(y) },
            { type: intPrimitiveType, value: 1 }
        ];
        let liste = this.aktionsempfaengerMap["geklickt"];
        for (let ae of liste) {
            this.invokeMethod(ae.method, ae.runtimeObject, parameters);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR05HRXJlaWduaXNiZWhhbmRsdW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9nbmcvR05HRXJlaWduaXNiZWhhbmRsdW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNoSCxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBUyxNQUFNLCtCQUErQixDQUFDO0FBWTdFLE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxLQUFLO0lBRTVDLFlBQVksTUFBYyxFQUFVLFdBQXdCO1FBRXhELEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsa0dBQWtHLENBQUMsQ0FBQztRQUZ4RyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUt4RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLG9CQUFvQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFDdkUsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRTNDLElBQUksTUFBTSxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVyRCxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTdCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLG1EQUFtRCxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFakYsK0RBQStEO1FBQy9ELDhHQUE4RztRQUM5RyxZQUFZO1FBQ1osd0JBQXdCO1FBRXhCLHNEQUFzRDtRQUN0RCwwREFBMEQ7UUFDMUQscURBQXFEO1FB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QUFJLEtBQUssR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbEQsS0FBSyxJQUFJLEVBQUUsSUFBSSxLQUFLLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FFOUQ7SUFFTCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2R1bGUsIE1vZHVsZVN0b3JlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgY2hhclByaW1pdGl2ZVR5cGUsIGludFByaW1pdGl2ZVR5cGUsIHZvaWRQcmltaXRpdmVUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XHJcbmltcG9ydCB7IE1ldGhvZCwgUGFyYW1ldGVybGlzdCwgVmFsdWUgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgUnVudGltZU9iamVjdCB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9SdW50aW1lT2JqZWN0LmpzXCI7XHJcblxyXG5cclxuZXhwb3J0IHR5cGUgR05HQWt0aW9uc2VtcGZhZW5nZXJUeXBlID0gXCJhdXNmw7xocmVuXCIgfCBcInRhc3RlXCIgfCBcInNvbmRlcnRhc3RlXCIgfCBcImdla2xpY2t0XCI7XHJcblxyXG5leHBvcnQgdHlwZSBHTkdBa3Rpb25zZW1wZmFlbmdlckRhdGEgPSB7XHJcbiAgICB0eXBlOiBHTkdBa3Rpb25zZW1wZmFlbmdlclR5cGUsXHJcbiAgICBtZXRob2Q6IE1ldGhvZCxcclxuICAgIHJ1bnRpbWVPYmplY3Q6IFJ1bnRpbWVPYmplY3RcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEdOR0VyZWlnbmlzYmVoYW5kbHVuZyBleHRlbmRzIEtsYXNzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSwgcHJpdmF0ZSBtb2R1bGVTdG9yZTogTW9kdWxlU3RvcmUpIHtcclxuXHJcbiAgICAgICAgc3VwZXIoXCJFcmVpZ25pc2JlaGFuZGx1bmdcIiwgbW9kdWxlLCBcIlp1Z3JpZmYgYXVmIEVyZWlnbmlzc2UgZWluc2NobGllw59saWNoIFRha3RnZWJlciAoR3JhcGhpY3MnbiBHYW1lcy1CaWJsaW90aGVrIChDb3JuZWxzZW4tVmVybGFnKSlcIik7XHJcblxyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiRXJlaWduaXNiZWhhbmRsdW5nXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgbnVsbCxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGhlbHBlciA9IEdOR0VyZWlnbmlzYmVoYW5kbHVuZy5nZXRIZWxwZXIobW9kdWxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBoZWxwZXIucmVnaXN0ZXJFdmVudHMobyk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdJbnN0YW56aWVydCBlaW4gbmV1ZXMgRXJlaWduaXNiZWhhbmRsdW5ncy1PYmpla3QuJywgdHJ1ZSkpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiR3LDtsOfZVNldHplblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgLy8gICAgIHsgaWRlbnRpZmllcjogXCJncsO2w59lXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgLy8gXSksIG51bGwsXHJcbiAgICAgICAgLy8gICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgIC8vICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgIC8vICAgICAgICAgbGV0IHNoOiBHcm91cEhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkFjdG9yXCJdO1xyXG4gICAgICAgIC8vICAgICAgICAgbGV0IGdyb2Vzc2U6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcblxyXG5cclxuICAgICAgICAvLyAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlNldHp0IGRpZSBHcsO2w59lIGRlciBGaWd1ci5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlN0YXJ0ZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgIEdOR0VyZWlnbmlzYmVoYW5kbHVuZy5nZXRIZWxwZXIobW9kdWxlKS5zdGFydFRpbWVyKCk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiWmVpdGdlYmVyIHN0YXJ0ZW4uXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJBbmhhbHRlblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIG51bGwsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSkuc3RvcFRpbWVyKCk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsIFwiWmVpdGdlYmVyIGFuaGFsdGVuLlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFrdGRhdWVyU2V0emVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImRhdWVyXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZGF1ZXI6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSkudGFrdGRhdWVyID0gZGF1ZXI7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgdHJ1ZSwgJ1NldHp0IGRpZSBUYWt0ZGF1ZXIgZGVzIFplaXRnZWJlcnMgaW4gTWlsbGlzZWt1bmRlbicsIGZhbHNlKSk7XHJcblxyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFrdEltcHVsc0F1c2bDvGhyZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW10pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiRGllc2UgTWV0aG9kZSB3aXJkIHZvbSBUYWt0Z2ViZXIgYXVmZ2VydWZlbi5cIikpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiVGFzdGVHZWRyw7xja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwidGFzdGVcIiwgdHlwZTogY2hhclByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICBudWxsLCAgLy8gbm8gaW1wbGVtZW50YXRpb24hXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIHdlbm4gZWluZSBUYXN0ZSBnZWRyw7xja3Qgd2lyZC5cIikpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiU29uZGVyVGFzdGVHZWRyw7xja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwidGFzdGVcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIG51bGwsICAvLyBubyBpbXBsZW1lbnRhdGlvbiFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIldpcmQgYXVmZ2VydWZlbiwgd2VubiBlaW5lIFNvbmRlcnRhc3RlIGdlZHLDvGNrdCB3aXJkLlwiKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJNYXVzR2VrbGlja3RcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwieFwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInlcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJhbnphaGxcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICBudWxsLCAgLy8gbm8gaW1wbGVtZW50YXRpb24hXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIHdlbm4gZWluZSBkaWUgbGlua2UgTWF1c3Rhc3RlIGdlZHLDvGNrdCB3aXJkLlwiKSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBnZXRIZWxwZXIobW9kdWxlOiBNb2R1bGUpOkdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcntcclxuICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpO1xyXG4gICAgICAgIGlmIChpbnRlcnByZXRlci5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlci5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIgPSBuZXcgR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyKG1vZHVsZSk7XHJcbiAgICAgICAgICAgIGludGVycHJldGVyLmduZ0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlci5iaW5kRXZlbnRzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaW50ZXJwcmV0ZXIuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyO1xyXG5cclxuICAgIH1cclxuXHJcbn1cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyIHtcclxuXHJcbiAgICBha3Rpb25zZW1wZmFlbmdlclR5cGVzOiBzdHJpbmdbXSA9IFtcImF1c2bDvGhyZW5cIiwgXCJ0YXN0ZVwiLCBcInNvbmRlcnRhc3RlXCIsIFwiZ2VrbGlja3RcIl07XHJcbiAgICBtZXRob2RTaWduYXR1cmVMaXN0OiBzdHJpbmdbXSA9IFtcIlRha3RJbXB1bHNBdXNmw7xocmVuKClcIiwgXCJBdXNmw7xocmVuKClcIiwgXCJBa3Rpb25BdXNmw7xocmVuKClcIiwgXCJNYXVzR2VrbGlja3QoaW50LCBpbnQsIGludClcIiwgXCJUYXN0ZShjaGFyKVwiLCBcIlRhc3RlR2VkcsO8Y2t0KGNoYXIpXCIsIFxyXG4gICAgXCJTb25kZXJUYXN0ZShpbnQpXCIsIFwiU29uZGVyVGFzdGVHZWRyw7xja3QoaW50KVwiXTtcclxuICAgIG1ldGhvZFRvQWt0aW9uc2VtcGZhZW5nZXJUeXBlTWFwOiB7IFtzaWduYXR1cmU6IHN0cmluZ106IHN0cmluZyB9ID0ge1xyXG4gICAgICAgIFwiVGFrdEltcHVsc0F1c2bDvGhyZW4oKVwiOiBcImF1c2bDvGhyZW5cIixcclxuICAgICAgICBcIkF1c2bDvGhyZW4oKVwiOiBcImF1c2bDvGhyZW5cIixcclxuICAgICAgICBcIkFrdGlvbkF1c2bDvGhyZW4oKVwiOiBcImF1c2bDvGhyZW5cIixcclxuICAgICAgICBcIk1hdXNHZWtsaWNrdChpbnQsIGludCwgaW50KVwiOiBcImdla2xpY2t0XCIsXHJcbiAgICAgICAgXCJUYXN0ZShjaGFyKVwiOiBcInRhc3RlXCIsXHJcbiAgICAgICAgXCJUYXN0ZUdlZHLDvGNrdChjaGFyKVwiOiBcInRhc3RlXCIsXHJcbiAgICAgICAgXCJTb25kZXJUYXN0ZShpbnQpXCI6IFwic29uZGVydGFzdGVcIixcclxuICAgICAgICBcIlNvbmRlclRhc3RlR2VkcsO8Y2t0KGludClcIjogXCJzb25kZXJ0YXN0ZVwiXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHNlZSBodHRwczovL3d3dy5mcmVlY29kZWNhbXAub3JnL25ld3MvamF2YXNjcmlwdC1rZXljb2RlLWxpc3Qta2V5cHJlc3MtZXZlbnQta2V5LWNvZGVzL1xyXG4gICAga2V5VG9LZXlDb2RlTWFwOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge1xyXG4gICAgICAgIFwiRW50ZXJcIjogMTMsXHJcbiAgICAgICAgXCJBcnJvd0xlZnRcIjogMzcsXHJcbiAgICAgICAgXCJBcnJvd1JpZ2h0XCI6IDM5LFxyXG4gICAgICAgIFwiQXJyb3dVcFwiOiAzOCxcclxuICAgICAgICBcIkFycm93RG93blwiOiA0MCxcclxuICAgICAgICBcIkYxXCI6IDExMixcclxuICAgICAgICBcIkYyXCI6IDExMyxcclxuICAgICAgICBcIkYzXCI6IDExNCxcclxuICAgICAgICBcIkY0XCI6IDExNSxcclxuICAgICAgICBcIkY1XCI6IDExNixcclxuICAgICAgICBcIkY2XCI6IDExNyxcclxuICAgICAgICBcIkY3XCI6IDExOCxcclxuICAgICAgICBcIkY4XCI6IDExOSxcclxuICAgICAgICBcIkY5XCI6IDEyMCxcclxuICAgICAgICBcIkYxMFwiOiAxMjEsXHJcbiAgICAgICAgXCJGMTFcIjogMTIyLFxyXG4gICAgICAgIFwiRjEyXCI6IDEyMyxcclxuICAgICAgICBcIlBhZ2VVcFwiOiAzMyxcclxuICAgICAgICBcIlBhZ2VEb3duXCI6IDM0LFxyXG4gICAgICAgIFwiSW5zZXJ0XCI6IDE1NVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvciBnbmcgbGlicmFyeSAoQ29ybmVsc2VuLVZlcmxhZyk6XHJcbiAgICBha3Rpb25zZW1wZmFlbmdlck1hcDogeyBbYWt0aW9uc2VtcGZhZW5nZXJUeXBlOiBzdHJpbmddOiBHTkdBa3Rpb25zZW1wZmFlbmdlckRhdGFbXSB9ID0ge307XHJcblxyXG4gICAgdGltZXJSdW5uaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICB0YWt0ZGF1ZXI6IG51bWJlciA9IDMwMDtcclxuICAgIHJlbWFpbmluZ1RpbWU6IG51bWJlciA9IDA7XHJcblxyXG4gICAgb25LZXlEb3duTWV0aG9kOiAoa2V5OiBzdHJpbmcpID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtb2R1bGU6TW9kdWxlKXtcclxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJUeXBlcykge1xyXG4gICAgICAgICAgICB0aGlzLmFrdGlvbnNlbXBmYWVuZ2VyTWFwW3R5cGVdID0gW107XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBoYXNBa3Rpb25zRW1wZmFlbmdlcigpOiBib29sZWFuIHtcclxuXHJcbiAgICAgICAgZm9yKGxldCB0eXBlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJUeXBlcyl7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbdHlwZV0ubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVnaXN0ZXJFdmVudHMobzogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCBrbGFzcyA9IDxLbGFzcz5vLmNsYXNzOyAgIC8vIFRoaXMgbWlnaHQgYmUgYSBjaGlsZCBjbGFzcyBvZiBFcmVpZ25pc2JlaGFuZGx1bmchXHJcblxyXG4gICAgICAgIGZvciAobGV0IG1zIG9mIHRoaXMubWV0aG9kU2lnbmF0dXJlTGlzdCkge1xyXG4gICAgICAgICAgICBsZXQgbWV0aG9kOiBNZXRob2QgPSBrbGFzcy5nZXRNZXRob2RCeVNpZ25hdHVyZShtcyk7XHJcbiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5tZXRob2RUb0FrdGlvbnNlbXBmYWVuZ2VyVHlwZU1hcFttc107XHJcblxyXG4gICAgICAgICAgICBpZiAobWV0aG9kPy5wcm9ncmFtICE9IG51bGwgfHwgbWV0aG9kPy5pbnZva2UgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiA8R05HQWt0aW9uc2VtcGZhZW5nZXJUeXBlPnR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXHJcbiAgICAgICAgICAgICAgICAgICAgcnVudGltZU9iamVjdDogb1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHVucmVnaXN0ZXJFdmVudHMobzogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCBrbGFzcyA9IDxLbGFzcz5vLmNsYXNzOyAgIC8vIFRoaXMgbWlnaHQgYmUgYSBjaGlsZCBjbGFzcyBvZiBFcmVpZ25pc2JlaGFuZGx1bmchXHJcblxyXG4gICAgICAgIGZvciAobGV0IG1zIG9mIHRoaXMubWV0aG9kU2lnbmF0dXJlTGlzdCkge1xyXG4gICAgICAgICAgICBsZXQgdHlwZSA9IHRoaXMubWV0aG9kVG9Ba3Rpb25zZW1wZmFlbmdlclR5cGVNYXBbbXNdO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXSA9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFrdGlvbnNlbXBmYWVuZ2VyTWFwW3R5cGVdLmZpbHRlcihhZSA9PiBhZS5ydW50aW1lT2JqZWN0ICE9IG8pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgYmluZEV2ZW50cygpIHtcclxuICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSB0aGlzLm1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCk7XHJcblxyXG4gICAgICAgIHRoaXMub25LZXlEb3duTWV0aG9kID0gKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChrZXkubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJ0YXN0ZVwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2tlTWV0aG9kKGFlLm1ldGhvZCwgYWUucnVudGltZU9iamVjdCwgW3sgdHlwZTogY2hhclByaW1pdGl2ZVR5cGUsIHZhbHVlOiBrZXkgfV0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IGtleUNvZGUgPSB0aGlzLmtleVRvS2V5Q29kZU1hcFtrZXldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGtleUNvZGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJzb25kZXJ0YXN0ZVwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9rZU1ldGhvZChhZS5tZXRob2QsIGFlLnJ1bnRpbWVPYmplY3QsIFt7IHR5cGU6IGNoYXJQcmltaXRpdmVUeXBlLCB2YWx1ZToga2V5Q29kZSB9XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGludGVycHJldGVyLmtleWJvYXJkVG9vbC5rZXlEb3duQ2FsbGJhY2tzLnB1c2godGhpcy5vbktleURvd25NZXRob2QpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLnN0YXJ0VGltZXIoKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZGV0YWNoRXZlbnRzKCkge1xyXG4gICAgICAgIGxldCBpbnRlcnByZXRlciA9IHRoaXMubW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICBsZXQgaW5kZXggPSBpbnRlcnByZXRlci5rZXlib2FyZFRvb2wua2V5RG93bkNhbGxiYWNrcy5pbmRleE9mKHRoaXMub25LZXlEb3duTWV0aG9kKTtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCkgaW50ZXJwcmV0ZXIua2V5Ym9hcmRUb29sLmtleURvd25DYWxsYmFja3Muc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB0aGlzLnN0b3BUaW1lcigpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBpbnZva2VNZXRob2QobWV0aG9kOiBNZXRob2QsIHJ1bnRpbWVPYmplY3Q6IFJ1bnRpbWVPYmplY3QsIHBhcmFtZXRlcnM6IFZhbHVlW10gPSBbXSwgY2FsbGJhY2s/OiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgbGV0IHByb2dyYW0gPSBtZXRob2QucHJvZ3JhbTtcclxuICAgICAgICBsZXQgaW52b2tlID0gbWV0aG9kLmludm9rZTtcclxuXHJcbiAgICAgICAgcGFyYW1ldGVycyA9IHBhcmFtZXRlcnMuc2xpY2UoMCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy51bnNoaWZ0KHsgdHlwZTogcnVudGltZU9iamVjdC5jbGFzcywgdmFsdWU6IHJ1bnRpbWVPYmplY3QgfSk7XHJcblxyXG4gICAgICAgIGlmIChwcm9ncmFtICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5tb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJ1blRpbWVyKG1ldGhvZCwgcGFyYW1ldGVycywgY2FsbGJhY2ssIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGludm9rZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGludm9rZShwYXJhbWV0ZXJzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHN0b3BUaW1lcigpIHtcclxuICAgICAgICB0aGlzLnRpbWVyUnVubmluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0VGltZXIoKSB7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy50aW1lclJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgdGhpcy50aW1lclJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NUaW1lckVudHJpZXMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3NUaW1lckVudHJpZXMoKSB7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy50aW1lclJ1bm5pbmcpIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0IGR0ID0gMTA7XHJcblxyXG4gICAgICAgIHRoaXMucmVtYWluaW5nVGltZSArPSBkdDtcclxuICAgICAgICBpZiAodGhpcy5yZW1haW5pbmdUaW1lID4gdGhpcy50YWt0ZGF1ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdUaW1lIC09IHRoaXMudGFrdGRhdWVyO1xyXG5cclxuICAgICAgICAgICAgbGV0IGxpc3RlID0gdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFtcImF1c2bDvGhyZW5cIl07XHJcbiAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIGxpc3RlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnZva2VNZXRob2QoYWUubWV0aG9kLCBhZS5ydW50aW1lT2JqZWN0LCBbXSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LnByb2Nlc3NUaW1lckVudHJpZXMoKTtcclxuICAgICAgICB9LCBkdCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGhhbmRsZU1vdXNlQ2xpY2tlZEV2ZW50KHg6IG51bWJlciwgeTogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHBhcmFtZXRlcnM6IFZhbHVlW10gPSBbXHJcbiAgICAgICAgICAgIHsgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgdmFsdWU6IE1hdGgucm91bmQoeCkgfSxcclxuICAgICAgICAgICAgeyB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCB2YWx1ZTogTWF0aC5yb3VuZCh5KSB9LFxyXG4gICAgICAgICAgICB7IHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIHZhbHVlOiAxIH1cclxuICAgICAgICBdXHJcblxyXG4gICAgICAgIGxldCBsaXN0ZSA9IHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJnZWtsaWNrdFwiXTtcclxuICAgICAgICBmb3IgKGxldCBhZSBvZiBsaXN0ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmludm9rZU1ldGhvZChhZS5tZXRob2QsIGFlLnJ1bnRpbWVPYmplY3QsIHBhcmFtZXRlcnMpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuXHJcbiJdfQ==