import { Klass } from "../../compiler/types/Class.js";
import { charPrimitiveType, intPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
export class GNGEreignisbehandlung extends Klass {
    constructor(module, moduleStore) {
        super("Ereignisbehandlung", module, "Zugriff auf Ereignisse einschließlich Taktgeber (Graphics'n Games-Bibliothek (Cornelsen-Verlag))");
        this.moduleStore = moduleStore;
        this.addMethod(new Method("Ereignisbehandlung", new Parameterlist([]), null, (parameters) => {
            let o = parameters[0].value;
            let helper = GNGEreignisbehandlung.getHelper(module);
            helper.registerEvents(o);
        }, false, false, 'Instanziert ein neues Ereignisbehandlungs-Objekt.', true));
        // this.addMethod(new Method("GrößeSetzen", new Parameterlist([
        //     { identifier: "größe", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        // ]), null,
        //     (parameters) => {
        //         let o: RuntimeObject = parameters[0].value;
        //         let sh: GroupHelper = o.intrinsicData["Actor"];
        //         let groesse: number = parameters[1].value;
        //     }, false, false, "Setzt die Größe der Figur.", false));
        this.addMethod(new Method("Starten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).startTimer();
        }, false, false, "Zeitgeber starten.", false));
        this.addMethod(new Method("Anhalten", new Parameterlist([]), null, (parameters) => {
            GNGEreignisbehandlung.getHelper(module).stopTimer();
        }, false, false, "Zeitgeber anhalten.", false));
        this.addMethod(new Method("TaktdauerSetzen", new Parameterlist([
            { identifier: "dauer", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, (parameters) => {
            let dauer = parameters[1].value;
            GNGEreignisbehandlung.getHelper(module).taktdauer = dauer;
        }, false, true, 'Setzt die Taktdauer des Zeitgebers in Millisekunden', false));
        this.addMethod(new Method("TaktImpulsAusführen", new Parameterlist([]), voidPrimitiveType, null, // no implementation!
        false, false, "Diese Methode wird vom Taktgeber aufgerufen."));
        this.addMethod(new Method("TasteGedrückt", new Parameterlist([
            { identifier: "taste", type: charPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Taste gedrückt wird."));
        this.addMethod(new Method("SonderTasteGedrückt", new Parameterlist([
            { identifier: "taste", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine Sondertaste gedrückt wird."));
        this.addMethod(new Method("MausGeklickt", new Parameterlist([
            { identifier: "x", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "y", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            { identifier: "anzahl", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
        ]), voidPrimitiveType, null, // no implementation!
        false, false, "Wird aufgerufen, wenn eine die linke Maustaste gedrückt wird."));
    }
    static getHelper(module) {
        let interpreter = module.main.getInterpreter();
        if (interpreter.gngEreignisbehandlungHelper == null) {
            interpreter.gngEreignisbehandlungHelper = new GNGEreignisbehandlungHelper(module);
            interpreter.gngEreignisbehandlungHelper.bindEvents();
        }
        return interpreter.gngEreignisbehandlungHelper;
    }
}
export class GNGEreignisbehandlungHelper {
    constructor(module) {
        this.module = module;
        this.aktionsempfaengerTypes = ["ausführen", "taste", "sondertaste", "geklickt"];
        this.methodSignatureList = ["TaktImpulsAusführen()", "AktionAusführen()", "MausGeklickt(int, int, int)", "TasteGedrückt(char)", "SonderTasteGedrückt(int)"];
        this.methodToAktionsempfaengerTypeMap = {
            "TaktImpulsAusführen()": "ausführen",
            "AktionAusführen()": "ausführen",
            "MausGeklickt(int, int, int)": "geklickt",
            "TasteGedrückt(char)": "taste",
            "SonderTasteGedrückt(int)": "sondertaste"
        };
        // see https://www.freecodecamp.org/news/javascript-keycode-list-keypress-event-key-codes/
        this.keyToKeyCodeMap = {
            "Enter": 13,
            "ArrowLeft": 37,
            "ArrowRight": 39,
            "ArrowUp": 38,
            "ArrowDown": 40,
            "F1": 112,
            "F2": 113,
            "F3": 114,
            "F4": 115,
            "F5": 116,
            "F6": 117,
            "F7": 118,
            "F8": 119,
            "F9": 120,
            "F10": 121,
            "F11": 122,
            "F12": 123,
            "PageUp": 33,
            "PageDown": 34,
            "Insert": 155
        };
        // For gng library (Cornelsen-Verlag):
        this.aktionsempfaengerMap = {};
        this.timerRunning = false;
        this.taktdauer = 300;
        this.remainingTime = 0;
        for (let type of this.aktionsempfaengerTypes) {
            this.aktionsempfaengerMap[type] = [];
        }
    }
    hasAktionsEmpfaenger() {
        for (let type of this.aktionsempfaengerTypes) {
            if (this.aktionsempfaengerMap[type].length > 0) {
                return true;
            }
        }
        return false;
    }
    registerEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let method = klass.getMethodBySignature(ms);
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            if ((method === null || method === void 0 ? void 0 : method.program) != null || (method === null || method === void 0 ? void 0 : method.invoke) != null) {
                this.aktionsempfaengerMap[type].push({
                    type: type,
                    method: method,
                    runtimeObject: o
                });
            }
        }
    }
    unregisterEvents(o) {
        let klass = o.class; // This might be a child class of Ereignisbehandlung!
        for (let ms of this.methodSignatureList) {
            let type = this.methodToAktionsempfaengerTypeMap[ms];
            this.aktionsempfaengerMap[type] =
                this.aktionsempfaengerMap[type].filter(ae => ae.runtimeObject != o);
        }
    }
    bindEvents() {
        let interpreter = this.module.main.getInterpreter();
        this.onKeyDownMethod = (key) => {
            if (key.length == 1) {
                for (let ae of this.aktionsempfaengerMap["taste"]) {
                    this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: key }]);
                }
            }
            else {
                let keyCode = this.keyToKeyCodeMap[key];
                if (keyCode != null) {
                    for (let ae of this.aktionsempfaengerMap["sondertaste"]) {
                        this.invokeMethod(ae.method, ae.runtimeObject, [{ type: charPrimitiveType, value: keyCode }]);
                    }
                }
            }
        };
        interpreter.keyboardTool.keyDownCallbacks.push(this.onKeyDownMethod);
        // this.startTimer();
    }
    detachEvents() {
        let interpreter = this.module.main.getInterpreter();
        let index = interpreter.keyboardTool.keyDownCallbacks.indexOf(this.onKeyDownMethod);
        if (index >= 0)
            interpreter.keyboardTool.keyDownCallbacks.splice(index, 1);
        this.stopTimer();
    }
    invokeMethod(method, runtimeObject, parameters = [], callback) {
        let program = method.program;
        let invoke = method.invoke;
        parameters = parameters.slice(0);
        parameters.unshift({ type: runtimeObject.class, value: runtimeObject });
        if (program != null) {
            this.module.main.getInterpreter().runTimer(method, parameters, callback, false);
        }
        else if (invoke != null) {
            invoke(parameters);
        }
    }
    stopTimer() {
        this.timerRunning = false;
    }
    startTimer() {
        if (!this.timerRunning) {
            this.timerRunning = true;
            this.processTimerEntries();
        }
    }
    processTimerEntries() {
        if (!this.timerRunning)
            return;
        let dt = 10;
        this.remainingTime += dt;
        if (this.remainingTime > this.taktdauer) {
            this.remainingTime -= this.taktdauer;
            let liste = this.aktionsempfaengerMap["ausführen"];
            for (let ae of liste) {
                this.invokeMethod(ae.method, ae.runtimeObject, []);
            }
        }
        let that = this;
        setTimeout(() => {
            that.processTimerEntries();
        }, dt);
    }
    handleMouseClickedEvent(x, y) {
        let parameters = [
            { type: intPrimitiveType, value: Math.round(x) },
            { type: intPrimitiveType, value: Math.round(y) },
            { type: intPrimitiveType, value: 1 }
        ];
        let liste = this.aktionsempfaengerMap["geklickt"];
        for (let ae of liste) {
            this.invokeMethod(ae.method, ae.runtimeObject, parameters);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR05HRXJlaWduaXNiZWhhbmRsdW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9nbmcvR05HRXJlaWduaXNiZWhhbmRsdW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNoSCxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBUyxNQUFNLCtCQUErQixDQUFDO0FBWTdFLE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxLQUFLO0lBRTVDLFlBQVksTUFBYyxFQUFVLFdBQXdCO1FBRXhELEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsa0dBQWtHLENBQUMsQ0FBQztRQUZ4RyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUt4RCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLG9CQUFvQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFDdkUsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBRTNDLElBQUksTUFBTSxHQUFHLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVyRCxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTdCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLG1EQUFtRCxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFakYsK0RBQStEO1FBQy9ELDhHQUE4RztRQUM5RyxZQUFZO1FBQ1osd0JBQXdCO1FBRXhCLHNEQUFzRDtRQUN0RCwwREFBMEQ7UUFDMUQscURBQXFEO1FB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Q0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsYUFBYSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBRTlEO0lBRUwsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kdWxlLCBNb2R1bGVTdG9yZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IEtsYXNzIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IGNoYXJQcmltaXRpdmVUeXBlLCBpbnRQcmltaXRpdmVUeXBlLCB2b2lkUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBNZXRob2QsIFBhcmFtZXRlcmxpc3QsIFZhbHVlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5cclxuXHJcbmV4cG9ydCB0eXBlIEdOR0FrdGlvbnNlbXBmYWVuZ2VyVHlwZSA9IFwiYXVzZsO8aHJlblwiIHwgXCJ0YXN0ZVwiIHwgXCJzb25kZXJ0YXN0ZVwiIHwgXCJnZWtsaWNrdFwiO1xyXG5cclxuZXhwb3J0IHR5cGUgR05HQWt0aW9uc2VtcGZhZW5nZXJEYXRhID0ge1xyXG4gICAgdHlwZTogR05HQWt0aW9uc2VtcGZhZW5nZXJUeXBlLFxyXG4gICAgbWV0aG9kOiBNZXRob2QsXHJcbiAgICBydW50aW1lT2JqZWN0OiBSdW50aW1lT2JqZWN0XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBHTkdFcmVpZ25pc2JlaGFuZGx1bmcgZXh0ZW5kcyBLbGFzcyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IobW9kdWxlOiBNb2R1bGUsIHByaXZhdGUgbW9kdWxlU3RvcmU6IE1vZHVsZVN0b3JlKSB7XHJcblxyXG4gICAgICAgIHN1cGVyKFwiRXJlaWduaXNiZWhhbmRsdW5nXCIsIG1vZHVsZSwgXCJadWdyaWZmIGF1ZiBFcmVpZ25pc3NlIGVpbnNjaGxpZcOfbGljaCBUYWt0Z2ViZXIgKEdyYXBoaWNzJ24gR2FtZXMtQmlibGlvdGhlayAoQ29ybmVsc2VuLVZlcmxhZykpXCIpO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIkVyZWlnbmlzYmVoYW5kbHVuZ1wiLCBuZXcgUGFyYW1ldGVybGlzdChbXSksIG51bGwsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBoZWxwZXIgPSBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaGVscGVyLnJlZ2lzdGVyRXZlbnRzKG8pO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnSW5zdGFuemllcnQgZWluIG5ldWVzIEVyZWlnbmlzYmVoYW5kbHVuZ3MtT2JqZWt0LicsIHRydWUpKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIkdyw7bDn2VTZXR6ZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIC8vICAgICB7IGlkZW50aWZpZXI6IFwiZ3LDtsOfZVwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIC8vIF0pLCBudWxsLFxyXG4gICAgICAgIC8vICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAvLyAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAvLyAgICAgICAgIGxldCBzaDogR3JvdXBIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJBY3RvclwiXTtcclxuICAgICAgICAvLyAgICAgICAgIGxldCBncm9lc3NlOiBudW1iZXIgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG5cclxuXHJcbiAgICAgICAgLy8gICAgIH0sIGZhbHNlLCBmYWxzZSwgXCJTZXR6dCBkaWUgR3LDtsOfZSBkZXIgRmlndXIuXCIsIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJTdGFydGVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgbnVsbCxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuICAgICAgICAgICAgICAgICBHTkdFcmVpZ25pc2JlaGFuZGx1bmcuZ2V0SGVscGVyKG1vZHVsZSkuc3RhcnRUaW1lcigpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlplaXRnZWJlciBzdGFydGVuLlwiLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiQW5oYWx0ZW5cIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBudWxsLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgR05HRXJlaWduaXNiZWhhbmRsdW5nLmdldEhlbHBlcihtb2R1bGUpLnN0b3BUaW1lcigpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCBcIlplaXRnZWJlciBhbmhhbHRlbi5cIiwgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRha3RkYXVlclNldHplblwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJkYXVlclwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICBdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGRhdWVyOiBudW1iZXIgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgR05HRXJlaWduaXNiZWhhbmRsdW5nLmdldEhlbHBlcihtb2R1bGUpLnRha3RkYXVlciA9IGRhdWVyO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIHRydWUsICdTZXR6dCBkaWUgVGFrdGRhdWVyIGRlcyBaZWl0Z2ViZXJzIGluIE1pbGxpc2VrdW5kZW4nLCBmYWxzZSkpO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRha3RJbXB1bHNBdXNmw7xocmVuXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtdKSwgdm9pZFByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIG51bGwsICAvLyBubyBpbXBsZW1lbnRhdGlvbiFcclxuICAgICAgICAgICAgZmFsc2UsIGZhbHNlLCBcIkRpZXNlIE1ldGhvZGUgd2lyZCB2b20gVGFrdGdlYmVyIGF1ZmdlcnVmZW4uXCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlRhc3RlR2VkcsO8Y2t0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInRhc3RlXCIsIHR5cGU6IGNoYXJQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfVxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiV2lyZCBhdWZnZXJ1ZmVuLCB3ZW5uIGVpbmUgVGFzdGUgZ2VkcsO8Y2t0IHdpcmQuXCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIlNvbmRlclRhc3RlR2VkcsO8Y2t0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInRhc3RlXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICBudWxsLCAgLy8gbm8gaW1wbGVtZW50YXRpb24hXHJcbiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSwgXCJXaXJkIGF1ZmdlcnVmZW4sIHdlbm4gZWluZSBTb25kZXJ0YXN0ZSBnZWRyw7xja3Qgd2lyZC5cIikpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiTWF1c0dla2xpY2t0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInhcIiwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJ5XCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiYW56YWhsXCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgbnVsbCwgIC8vIG5vIGltcGxlbWVudGF0aW9uIVxyXG4gICAgICAgICAgICBmYWxzZSwgZmFsc2UsIFwiV2lyZCBhdWZnZXJ1ZmVuLCB3ZW5uIGVpbmUgZGllIGxpbmtlIE1hdXN0YXN0ZSBnZWRyw7xja3Qgd2lyZC5cIikpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZ2V0SGVscGVyKG1vZHVsZTogTW9kdWxlKTpHTkdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXJ7XHJcbiAgICAgICAgbGV0IGludGVycHJldGVyID0gbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICBpZiAoaW50ZXJwcmV0ZXIuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgaW50ZXJwcmV0ZXIuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gbmV3IEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcihtb2R1bGUpO1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlci5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXIuYmluZEV2ZW50cygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGludGVycHJldGVyLmduZ0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcjtcclxuXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEdOR0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlciB7XHJcblxyXG4gICAgYWt0aW9uc2VtcGZhZW5nZXJUeXBlczogc3RyaW5nW10gPSBbXCJhdXNmw7xocmVuXCIsIFwidGFzdGVcIiwgXCJzb25kZXJ0YXN0ZVwiLCBcImdla2xpY2t0XCJdO1xyXG4gICAgbWV0aG9kU2lnbmF0dXJlTGlzdDogc3RyaW5nW10gPSBbXCJUYWt0SW1wdWxzQXVzZsO8aHJlbigpXCIsIFwiQWt0aW9uQXVzZsO8aHJlbigpXCIsIFwiTWF1c0dla2xpY2t0KGludCwgaW50LCBpbnQpXCIsIFwiVGFzdGVHZWRyw7xja3QoY2hhcilcIiwgXCJTb25kZXJUYXN0ZUdlZHLDvGNrdChpbnQpXCJdO1xyXG4gICAgbWV0aG9kVG9Ba3Rpb25zZW1wZmFlbmdlclR5cGVNYXA6IHsgW3NpZ25hdHVyZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XHJcbiAgICAgICAgXCJUYWt0SW1wdWxzQXVzZsO8aHJlbigpXCI6IFwiYXVzZsO8aHJlblwiLFxyXG4gICAgICAgIFwiQWt0aW9uQXVzZsO8aHJlbigpXCI6IFwiYXVzZsO8aHJlblwiLFxyXG4gICAgICAgIFwiTWF1c0dla2xpY2t0KGludCwgaW50LCBpbnQpXCI6IFwiZ2VrbGlja3RcIixcclxuICAgICAgICBcIlRhc3RlR2VkcsO8Y2t0KGNoYXIpXCI6IFwidGFzdGVcIixcclxuICAgICAgICBcIlNvbmRlclRhc3RlR2VkcsO8Y2t0KGludClcIjogXCJzb25kZXJ0YXN0ZVwiXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHNlZSBodHRwczovL3d3dy5mcmVlY29kZWNhbXAub3JnL25ld3MvamF2YXNjcmlwdC1rZXljb2RlLWxpc3Qta2V5cHJlc3MtZXZlbnQta2V5LWNvZGVzL1xyXG4gICAga2V5VG9LZXlDb2RlTWFwOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge1xyXG4gICAgICAgIFwiRW50ZXJcIjogMTMsXHJcbiAgICAgICAgXCJBcnJvd0xlZnRcIjogMzcsXHJcbiAgICAgICAgXCJBcnJvd1JpZ2h0XCI6IDM5LFxyXG4gICAgICAgIFwiQXJyb3dVcFwiOiAzOCxcclxuICAgICAgICBcIkFycm93RG93blwiOiA0MCxcclxuICAgICAgICBcIkYxXCI6IDExMixcclxuICAgICAgICBcIkYyXCI6IDExMyxcclxuICAgICAgICBcIkYzXCI6IDExNCxcclxuICAgICAgICBcIkY0XCI6IDExNSxcclxuICAgICAgICBcIkY1XCI6IDExNixcclxuICAgICAgICBcIkY2XCI6IDExNyxcclxuICAgICAgICBcIkY3XCI6IDExOCxcclxuICAgICAgICBcIkY4XCI6IDExOSxcclxuICAgICAgICBcIkY5XCI6IDEyMCxcclxuICAgICAgICBcIkYxMFwiOiAxMjEsXHJcbiAgICAgICAgXCJGMTFcIjogMTIyLFxyXG4gICAgICAgIFwiRjEyXCI6IDEyMyxcclxuICAgICAgICBcIlBhZ2VVcFwiOiAzMyxcclxuICAgICAgICBcIlBhZ2VEb3duXCI6IDM0LFxyXG4gICAgICAgIFwiSW5zZXJ0XCI6IDE1NVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvciBnbmcgbGlicmFyeSAoQ29ybmVsc2VuLVZlcmxhZyk6XHJcbiAgICBha3Rpb25zZW1wZmFlbmdlck1hcDogeyBbYWt0aW9uc2VtcGZhZW5nZXJUeXBlOiBzdHJpbmddOiBHTkdBa3Rpb25zZW1wZmFlbmdlckRhdGFbXSB9ID0ge307XHJcblxyXG4gICAgdGltZXJSdW5uaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICB0YWt0ZGF1ZXI6IG51bWJlciA9IDMwMDtcclxuICAgIHJlbWFpbmluZ1RpbWU6IG51bWJlciA9IDA7XHJcblxyXG4gICAgb25LZXlEb3duTWV0aG9kOiAoa2V5OiBzdHJpbmcpID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtb2R1bGU6TW9kdWxlKXtcclxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJUeXBlcykge1xyXG4gICAgICAgICAgICB0aGlzLmFrdGlvbnNlbXBmYWVuZ2VyTWFwW3R5cGVdID0gW107XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBoYXNBa3Rpb25zRW1wZmFlbmdlcigpOiBib29sZWFuIHtcclxuXHJcbiAgICAgICAgZm9yKGxldCB0eXBlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJUeXBlcyl7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbdHlwZV0ubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVnaXN0ZXJFdmVudHMobzogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCBrbGFzcyA9IDxLbGFzcz5vLmNsYXNzOyAgIC8vIFRoaXMgbWlnaHQgYmUgYSBjaGlsZCBjbGFzcyBvZiBFcmVpZ25pc2JlaGFuZGx1bmchXHJcblxyXG4gICAgICAgIGZvciAobGV0IG1zIG9mIHRoaXMubWV0aG9kU2lnbmF0dXJlTGlzdCkge1xyXG4gICAgICAgICAgICBsZXQgbWV0aG9kOiBNZXRob2QgPSBrbGFzcy5nZXRNZXRob2RCeVNpZ25hdHVyZShtcyk7XHJcbiAgICAgICAgICAgIGxldCB0eXBlID0gdGhpcy5tZXRob2RUb0FrdGlvbnNlbXBmYWVuZ2VyVHlwZU1hcFttc107XHJcblxyXG4gICAgICAgICAgICBpZiAobWV0aG9kPy5wcm9ncmFtICE9IG51bGwgfHwgbWV0aG9kPy5pbnZva2UgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiA8R05HQWt0aW9uc2VtcGZhZW5nZXJUeXBlPnR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXHJcbiAgICAgICAgICAgICAgICAgICAgcnVudGltZU9iamVjdDogb1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHVucmVnaXN0ZXJFdmVudHMobzogUnVudGltZU9iamVjdCkge1xyXG4gICAgICAgIGxldCBrbGFzcyA9IDxLbGFzcz5vLmNsYXNzOyAgIC8vIFRoaXMgbWlnaHQgYmUgYSBjaGlsZCBjbGFzcyBvZiBFcmVpZ25pc2JlaGFuZGx1bmchXHJcblxyXG4gICAgICAgIGZvciAobGV0IG1zIG9mIHRoaXMubWV0aG9kU2lnbmF0dXJlTGlzdCkge1xyXG4gICAgICAgICAgICBsZXQgdHlwZSA9IHRoaXMubWV0aG9kVG9Ba3Rpb25zZW1wZmFlbmdlclR5cGVNYXBbbXNdO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFt0eXBlXSA9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFrdGlvbnNlbXBmYWVuZ2VyTWFwW3R5cGVdLmZpbHRlcihhZSA9PiBhZS5ydW50aW1lT2JqZWN0ICE9IG8pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgYmluZEV2ZW50cygpIHtcclxuICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSB0aGlzLm1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCk7XHJcblxyXG4gICAgICAgIHRoaXMub25LZXlEb3duTWV0aG9kID0gKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChrZXkubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJ0YXN0ZVwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW52b2tlTWV0aG9kKGFlLm1ldGhvZCwgYWUucnVudGltZU9iamVjdCwgW3sgdHlwZTogY2hhclByaW1pdGl2ZVR5cGUsIHZhbHVlOiBrZXkgfV0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IGtleUNvZGUgPSB0aGlzLmtleVRvS2V5Q29kZU1hcFtrZXldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGtleUNvZGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJzb25kZXJ0YXN0ZVwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludm9rZU1ldGhvZChhZS5tZXRob2QsIGFlLnJ1bnRpbWVPYmplY3QsIFt7IHR5cGU6IGNoYXJQcmltaXRpdmVUeXBlLCB2YWx1ZToga2V5Q29kZSB9XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGludGVycHJldGVyLmtleWJvYXJkVG9vbC5rZXlEb3duQ2FsbGJhY2tzLnB1c2godGhpcy5vbktleURvd25NZXRob2QpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLnN0YXJ0VGltZXIoKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZGV0YWNoRXZlbnRzKCkge1xyXG4gICAgICAgIGxldCBpbnRlcnByZXRlciA9IHRoaXMubW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICBsZXQgaW5kZXggPSBpbnRlcnByZXRlci5rZXlib2FyZFRvb2wua2V5RG93bkNhbGxiYWNrcy5pbmRleE9mKHRoaXMub25LZXlEb3duTWV0aG9kKTtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCkgaW50ZXJwcmV0ZXIua2V5Ym9hcmRUb29sLmtleURvd25DYWxsYmFja3Muc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB0aGlzLnN0b3BUaW1lcigpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBpbnZva2VNZXRob2QobWV0aG9kOiBNZXRob2QsIHJ1bnRpbWVPYmplY3Q6IFJ1bnRpbWVPYmplY3QsIHBhcmFtZXRlcnM6IFZhbHVlW10gPSBbXSwgY2FsbGJhY2s/OiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgbGV0IHByb2dyYW0gPSBtZXRob2QucHJvZ3JhbTtcclxuICAgICAgICBsZXQgaW52b2tlID0gbWV0aG9kLmludm9rZTtcclxuXHJcbiAgICAgICAgcGFyYW1ldGVycyA9IHBhcmFtZXRlcnMuc2xpY2UoMCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy51bnNoaWZ0KHsgdHlwZTogcnVudGltZU9iamVjdC5jbGFzcywgdmFsdWU6IHJ1bnRpbWVPYmplY3QgfSk7XHJcblxyXG4gICAgICAgIGlmIChwcm9ncmFtICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5tb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJ1blRpbWVyKG1ldGhvZCwgcGFyYW1ldGVycywgY2FsbGJhY2ssIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGludm9rZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGludm9rZShwYXJhbWV0ZXJzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHN0b3BUaW1lcigpIHtcclxuICAgICAgICB0aGlzLnRpbWVyUnVubmluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0VGltZXIoKSB7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy50aW1lclJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgdGhpcy50aW1lclJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NUaW1lckVudHJpZXMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3NUaW1lckVudHJpZXMoKSB7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy50aW1lclJ1bm5pbmcpIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0IGR0ID0gMTA7XHJcblxyXG4gICAgICAgIHRoaXMucmVtYWluaW5nVGltZSArPSBkdDtcclxuICAgICAgICBpZiAodGhpcy5yZW1haW5pbmdUaW1lID4gdGhpcy50YWt0ZGF1ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdUaW1lIC09IHRoaXMudGFrdGRhdWVyO1xyXG5cclxuICAgICAgICAgICAgbGV0IGxpc3RlID0gdGhpcy5ha3Rpb25zZW1wZmFlbmdlck1hcFtcImF1c2bDvGhyZW5cIl07XHJcbiAgICAgICAgICAgIGZvciAobGV0IGFlIG9mIGxpc3RlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnZva2VNZXRob2QoYWUubWV0aG9kLCBhZS5ydW50aW1lT2JqZWN0LCBbXSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGF0LnByb2Nlc3NUaW1lckVudHJpZXMoKTtcclxuICAgICAgICB9LCBkdCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGhhbmRsZU1vdXNlQ2xpY2tlZEV2ZW50KHg6IG51bWJlciwgeTogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHBhcmFtZXRlcnM6IFZhbHVlW10gPSBbXHJcbiAgICAgICAgICAgIHsgdHlwZTogaW50UHJpbWl0aXZlVHlwZSwgdmFsdWU6IE1hdGgucm91bmQoeCkgfSxcclxuICAgICAgICAgICAgeyB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCB2YWx1ZTogTWF0aC5yb3VuZCh5KSB9LFxyXG4gICAgICAgICAgICB7IHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIHZhbHVlOiAxIH1cclxuICAgICAgICBdXHJcblxyXG4gICAgICAgIGxldCBsaXN0ZSA9IHRoaXMuYWt0aW9uc2VtcGZhZW5nZXJNYXBbXCJnZWtsaWNrdFwiXTtcclxuICAgICAgICBmb3IgKGxldCBhZSBvZiBsaXN0ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmludm9rZU1ldGhvZChhZS5tZXRob2QsIGFlLnJ1bnRpbWVPYmplY3QsIHBhcmFtZXRlcnMpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuXHJcbiJdfQ==