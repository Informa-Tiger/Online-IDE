import { Klass } from "../../compiler/types/Class.js";
import { booleanPrimitiveType, doublePrimitiveType, floatPrimitiveType, intPrimitiveType, stringPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
export class ResultSetClass extends Klass {
    constructor(module) {
        super("ResultSet", module, "Ein ResultSet-Objekt speichert das Ergebnis einer Abfrage an die Datenbank.");
        let resultSetType = module.typeStore.getType("ResultSet");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.addMethod(new Method("next", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let rsh = o.intrinsicData["Helper"];
            return rsh.next();
        }, false, false, 'F端hrt ein SQL-Statement aus.', false));
        this.addMethod(new Method("wasNull", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let rsh = o.intrinsicData["Helper"];
            return rsh.wasNull;
        }, false, false, 'Gibt genau dann true zur端ck, wenn der zuletzt gelesene Wert null war.', false));
        let types = [booleanPrimitiveType, intPrimitiveType, floatPrimitiveType, doublePrimitiveType, stringPrimitiveType];
        for (let type of types) {
            let typeIdFirstUppercase = type.identifier.charAt(0).toUpperCase() + type.identifier.substring(1);
            this.addMethod(new Method("get" + typeIdFirstUppercase, new Parameterlist([
                { identifier: "columnIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            ]), type, (parameters) => {
                let o = parameters[0].value;
                let columnIndex = parameters[1].value;
                let rsh = o.intrinsicData["Helper"];
                let interpreter = module.main.getInterpreter();
                if (columnIndex < 1 || columnIndex > rsh.columnCount()) {
                    interpreter.throwException("Das Ergebnis hat keine Spalte " + columnIndex + ".");
                    return;
                }
                if (rsh.isAfterLast()) {
                    interpreter.throwException("Der Cursor befindet sich hinter dem letzten Datensatz des ResultSet.");
                }
                return rsh.getValue(type, columnIndex);
            }, false, false, 'Gibt den Wert der Spalte mit dem angegebenen Spaltenindex als ' + type.identifier + " zur端ck.", false));
            this.addMethod(new Method("get" + typeIdFirstUppercase, new Parameterlist([
                { identifier: "columnLabel", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            ]), type, (parameters) => {
                let o = parameters[0].value;
                let columnLabel = parameters[1].value;
                let rsh = o.intrinsicData["Helper"];
                let interpreter = module.main.getInterpreter();
                if (rsh.isAfterLast()) {
                    interpreter.throwException("Der Cursor befindet sich hinter dem letzten Datensatz des ResultSet.");
                }
                let columnIndex = rsh.getColumnIndex(columnLabel);
                if (columnIndex < 0) {
                    interpreter.throwException("Das Ergebnis hat keine Spalte mit dem Bezeichner " + columnLabel + ".");
                    return;
                }
                return rsh.getValue(type, columnIndex);
            }, false, false, 'Gibt den Wert der Spalte mit dem angegebenen Spaltenindex als ' + type.identifier + " zur端ck.", false));
        }
    }
}
export class ResultsetHelper {
    constructor(result) {
        this.result = result;
        this.cursor = -1;
        this.wasNull = false;
    }
    getColumnIndex(columnLabel) {
        columnLabel = columnLabel.toLocaleLowerCase();
        let index = this.result.columns.findIndex((value, index) => { return value.toLocaleLowerCase() == columnLabel; });
        if (index < 0)
            return index;
        return index + 1;
    }
    next() {
        this.cursor++;
        return this.cursor < this.result.values.length;
    }
    columnCount() {
        return this.result.columns.length;
    }
    getValue(type, columnIndex) {
        let value = this.result.values[this.cursor][columnIndex - 1];
        this.wasNull = value == null;
        if (type == stringPrimitiveType) {
            return value == null ? null : "" + value;
        }
        if (type == intPrimitiveType) {
            if (value == null || !(typeof value == "number")) {
                return 0;
            }
            return Math.floor(value);
        }
        if (type == floatPrimitiveType || type == doublePrimitiveType) {
            if (value == null || !(typeof value == "number")) {
                return 0;
            }
            return value;
        }
        if (type == booleanPrimitiveType) {
            if (value == null)
                return false;
            return (value + "").indexOf("1") >= 0;
        }
    }
    isAfterLast() {
        return this.cursor > this.result.values.length - 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzdWx0U2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9kYXRhYmFzZS9SZXN1bHRTZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxvQkFBb0IsRUFBcUIsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQXVCLG1CQUFtQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDdE0sT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQVEsTUFBTSwrQkFBK0IsQ0FBQztBQUc1RSxNQUFNLE9BQU8sY0FBZSxTQUFRLEtBQUs7SUFFckMsWUFBWSxNQUFjO1FBQ3RCLEtBQUssQ0FBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLDZFQUE2RSxDQUFDLENBQUM7UUFFMUcsSUFBSSxhQUFhLEdBQVUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksYUFBYSxDQUFDLEVBQ25ELENBQUMsRUFBRSxvQkFBb0IsRUFDcEIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksR0FBRyxHQUFvQixDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JELE9BQU8sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXRCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLDhCQUE4QixFQUMvQyxLQUFLLENB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Q0FBQyxDQUFDO2FBQ1o7WUFDRCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUVELElBQUcsSUFBSSxJQUFJLG9CQUFvQixFQUFDO1lBQzVCLElBQUcsS0FBSyxJQUFJLElBQUk7Z0JBQUUsT0FBTyxLQUFLLENBQUM7WUFDL0IsT0FBTyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3pDO0lBRUwsQ0FBQztJQUVELFdBQVc7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUN2RCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBRdWVyeVJlc3VsdCB9IGZyb20gXCIuLi8uLi90b29scy9kYXRhYmFzZS9EYXRhYmFzZVRvb2wuanNcIjtcclxuaW1wb3J0IHsgTW9kdWxlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgYm9vbGVhblByaW1pdGl2ZVR5cGUsIGNoYXJQcmltaXRpdmVUeXBlLCBkb3VibGVQcmltaXRpdmVUeXBlLCBmbG9hdFByaW1pdGl2ZVR5cGUsIGludFByaW1pdGl2ZVR5cGUsIFN0cmluZ1ByaW1pdGl2ZVR5cGUsIHN0cmluZ1ByaW1pdGl2ZVR5cGUgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvUHJpbWl0aXZlVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgTWV0aG9kLCBQYXJhbWV0ZXJsaXN0LCBUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFJlc3VsdFNldENsYXNzIGV4dGVuZHMgS2xhc3Mge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG1vZHVsZTogTW9kdWxlKSB7XHJcbiAgICAgICAgc3VwZXIoXCJSZXN1bHRTZXRcIiwgbW9kdWxlLCBcIkVpbiBSZXN1bHRTZXQtT2JqZWt0IHNwZWljaGVydCBkYXMgRXJnZWJuaXMgZWluZXIgQWJmcmFnZSBhbiBkaWUgRGF0ZW5iYW5rLlwiKTtcclxuXHJcbiAgICAgICAgbGV0IHJlc3VsdFNldFR5cGUgPSA8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiUmVzdWx0U2V0XCIpO1xyXG5cclxuICAgICAgICB0aGlzLnNldEJhc2VDbGFzcyg8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiT2JqZWN0XCIpKTtcclxuIFxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJuZXh0XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHJzaDogUmVzdWx0c2V0SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJzaC5uZXh0KCk7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdGw7xocnQgZWluIFNRTC1TdGF0ZW1lbnQgYXVzLicsXHJcbiAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJ3YXNOdWxsXCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgYm9vbGVhblByaW1pdGl2ZVR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHJzaDogUmVzdWx0c2V0SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJzaC53YXNOdWxsO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnR2lidCBnZW5hdSBkYW5uIHRydWUgenVyw7xjaywgd2VubiBkZXIgenVsZXR6dCBnZWxlc2VuZSBXZXJ0IG51bGwgd2FyLicsXHJcbiAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIGxldCB0eXBlcyA9IFtib29sZWFuUHJpbWl0aXZlVHlwZSwgaW50UHJpbWl0aXZlVHlwZSwgZmxvYXRQcmltaXRpdmVUeXBlLCBkb3VibGVQcmltaXRpdmVUeXBlLCBzdHJpbmdQcmltaXRpdmVUeXBlXTtcclxuXHJcbiAgICAgICAgZm9yKGxldCB0eXBlIG9mIHR5cGVzKXtcclxuXHJcbiAgICAgICAgICAgIGxldCB0eXBlSWRGaXJzdFVwcGVyY2FzZSA9IHR5cGUuaWRlbnRpZmllci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHR5cGUuaWRlbnRpZmllci5zdWJzdHJpbmcoMSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiZ2V0XCIrdHlwZUlkRmlyc3RVcHBlcmNhc2UsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJjb2x1bW5JbmRleFwiLCB0eXBlOiBpbnRQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICAgICAgXSksIHR5cGUsXHJcbiAgICAgICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb2x1bW5JbmRleDogbnVtYmVyID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJzaDogUmVzdWx0c2V0SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGNvbHVtbkluZGV4IDwgMSB8fCBjb2x1bW5JbmRleCA+IHJzaC5jb2x1bW5Db3VudCgpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJEYXMgRXJnZWJuaXMgaGF0IGtlaW5lIFNwYWx0ZSBcIiArIGNvbHVtbkluZGV4ICsgXCIuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZihyc2guaXNBZnRlckxhc3QoKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyLnRocm93RXhjZXB0aW9uKFwiRGVyIEN1cnNvciBiZWZpbmRldCBzaWNoIGhpbnRlciBkZW0gbGV0enRlbiBEYXRlbnNhdHogZGVzIFJlc3VsdFNldC5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJzaC5nZXRWYWx1ZSh0eXBlLCBjb2x1bW5JbmRleCk7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0dpYnQgZGVuIFdlcnQgZGVyIFNwYWx0ZSBtaXQgZGVtIGFuZ2VnZWJlbmVuIFNwYWx0ZW5pbmRleCBhbHMgJyArIHR5cGUuaWRlbnRpZmllciArIFwiIHp1csO8Y2suXCIsXHJcbiAgICAgICAgICAgICAgICBmYWxzZSkpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImdldFwiK3R5cGVJZEZpcnN0VXBwZXJjYXNlLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwiY29sdW1uTGFiZWxcIiwgdHlwZTogc3RyaW5nUHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIF0pLCB0eXBlLFxyXG4gICAgICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgY29sdW1uTGFiZWw6IHN0cmluZyA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCByc2g6IFJlc3VsdHNldEhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkhlbHBlclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGludGVycHJldGVyID0gbW9kdWxlLm1haW4uZ2V0SW50ZXJwcmV0ZXIoKTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHJzaC5pc0FmdGVyTGFzdCgpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJEZXIgQ3Vyc29yIGJlZmluZGV0IHNpY2ggaGludGVyIGRlbSBsZXR6dGVuIERhdGVuc2F0eiBkZXMgUmVzdWx0U2V0LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb2x1bW5JbmRleDogbnVtYmVyID0gcnNoLmdldENvbHVtbkluZGV4KGNvbHVtbkxhYmVsKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihjb2x1bW5JbmRleCA8IDApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci50aHJvd0V4Y2VwdGlvbihcIkRhcyBFcmdlYm5pcyBoYXQga2VpbmUgU3BhbHRlIG1pdCBkZW0gQmV6ZWljaG5lciBcIiArIGNvbHVtbkxhYmVsICsgXCIuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJzaC5nZXRWYWx1ZSh0eXBlLCBjb2x1bW5JbmRleCk7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0dpYnQgZGVuIFdlcnQgZGVyIFNwYWx0ZSBtaXQgZGVtIGFuZ2VnZWJlbmVuIFNwYWx0ZW5pbmRleCBhbHMgJyArIHR5cGUuaWRlbnRpZmllciArIFwiIHp1csO8Y2suXCIsXHJcbiAgICAgICAgICAgICAgICBmYWxzZSkpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBcclxuXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFJlc3VsdHNldEhlbHBlciB7XHJcbiAgICBjdXJzb3I6IG51bWJlciA9IC0xO1xyXG4gICAgd2FzTnVsbDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVzdWx0OiBRdWVyeVJlc3VsdCl7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldENvbHVtbkluZGV4KGNvbHVtbkxhYmVsOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbHVtbkxhYmVsID0gY29sdW1uTGFiZWwudG9Mb2NhbGVMb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5yZXN1bHQuY29sdW1ucy5maW5kSW5kZXgoKHZhbHVlLCBpbmRleCkgPT4ge3JldHVybiB2YWx1ZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09IGNvbHVtbkxhYmVsfSk7XHJcbiAgICAgICAgaWYoaW5kZXggPCAwKSByZXR1cm4gaW5kZXg7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4ICsgMTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgbmV4dCgpOiBib29sZWFuIHtcclxuICAgICAgICB0aGlzLmN1cnNvcisrO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmN1cnNvciA8IHRoaXMucmVzdWx0LnZhbHVlcy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgY29sdW1uQ291bnQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHQuY29sdW1ucy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VmFsdWUodHlwZTogVHlwZSwgY29sdW1uSW5kZXg6IG51bWJlcikge1xyXG5cclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnJlc3VsdC52YWx1ZXNbdGhpcy5jdXJzb3JdW2NvbHVtbkluZGV4IC0gMV07XHJcbiAgICAgICAgdGhpcy53YXNOdWxsID0gdmFsdWUgPT0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYodHlwZSA9PSBzdHJpbmdQcmltaXRpdmVUeXBlKXtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyBudWxsIDogXCJcIiArIHZhbHVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodHlwZSA9PSBpbnRQcmltaXRpdmVUeXBlKXtcclxuICAgICAgICAgICAgaWYodmFsdWUgPT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PSBcIm51bWJlclwiKSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih0eXBlID09IGZsb2F0UHJpbWl0aXZlVHlwZSB8fCB0eXBlID09IGRvdWJsZVByaW1pdGl2ZVR5cGUpe1xyXG4gICAgICAgICAgICBpZih2YWx1ZSA9PSBudWxsIHx8ICEodHlwZW9mIHZhbHVlID09IFwibnVtYmVyXCIpKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHR5cGUgPT0gYm9vbGVhblByaW1pdGl2ZVR5cGUpe1xyXG4gICAgICAgICAgICBpZih2YWx1ZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybiAodmFsdWUgKyBcIlwiKS5pbmRleE9mKFwiMVwiKSA+PSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgaXNBZnRlckxhc3QoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yID4gdGhpcy5yZXN1bHQudmFsdWVzLmxlbmd0aCAtIDE7XHJcbiAgICB9XHJcblxyXG5cclxufSJdfQ==