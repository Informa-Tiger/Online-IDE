import { Klass } from "../../compiler/types/Class.js";
import { booleanPrimitiveType, doublePrimitiveType, floatPrimitiveType, intPrimitiveType, stringPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
export class ResultSetClass extends Klass {
    constructor(module) {
        super("ResultSet", module, "Ein ResultSet-Objekt speichert das Ergebnis einer Abfrage an die Datenbank.");
        let resultSetType = module.typeStore.getType("ResultSet");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.addMethod(new Method("next", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let rsh = o.intrinsicData["Helper"];
            return rsh.next();
        }, false, false, 'F端hrt ein SQL-Statement aus.', false));
        this.addMethod(new Method("wasNull", new Parameterlist([]), booleanPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let rsh = o.intrinsicData["Helper"];
            return rsh.wasNull;
        }, false, false, 'Gibt genau dann true zur端ck, wenn der zuletzt gelesene Wert null war.', false));
        let types = [booleanPrimitiveType, intPrimitiveType, floatPrimitiveType, doublePrimitiveType, stringPrimitiveType];
        for (let type of types) {
            let typeIdFirstUppercase = type.identifier.charAt(0).toUpperCase() + type.identifier.substring(1);
            this.addMethod(new Method("get" + typeIdFirstUppercase, new Parameterlist([
                { identifier: "columnIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            ]), type, (parameters) => {
                let o = parameters[0].value;
                let columnIndex = parameters[1].value;
                let rsh = o.intrinsicData["Helper"];
                let interpreter = module.main.getInterpreter();
                if (columnIndex < 1 || columnIndex > rsh.columnCount()) {
                    interpreter.throwException("Das Ergebnis hat keine Spalte " + columnIndex + ".");
                    return;
                }
                if (rsh.isAfterLast()) {
                    interpreter.throwException("Der Cursor befindet sich hinter dem letzten Datensatz des ResultSet.");
                }
                return rsh.getValue(type, columnIndex);
            }, false, false, 'Gibt den Wert der Spalte mit dem angegebenen Spaltenindex als ' + type.identifier + " zur端ck.", false));
            this.addMethod(new Method("get" + typeIdFirstUppercase, new Parameterlist([
                { identifier: "columnLabel", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
            ]), type, (parameters) => {
                let o = parameters[0].value;
                let columnLabel = parameters[1].value;
                let rsh = o.intrinsicData["Helper"];
                let interpreter = module.main.getInterpreter();
                if (rsh.isAfterLast()) {
                    interpreter.throwException("Der Cursor befindet sich hinter dem letzten Datensatz des ResultSet.");
                }
                let columnIndex = rsh.getColumnIndex(columnLabel);
                if (columnIndex < 0) {
                    interpreter.throwException("Das Ergebnis hat keine Spalte mit dem Bezeichner " + columnLabel + ".");
                    return;
                }
                return rsh.getValue(type, columnIndex);
            }, false, false, 'Gibt den Wert der Spalte mit dem angegebenen Spaltenindex als ' + type.identifier + " zur端ck.", false));
        }
    }
}
export class ResultsetHelper {
    constructor(result) {
        this.result = result;
        this.cursor = -1;
        this.wasNull = false;
    }
    getColumnIndex(columnLabel) {
        columnLabel = columnLabel.toLocaleLowerCase();
        let index = this.result.columns.findIndex((value, index) => { return value.toLocaleLowerCase() == columnLabel; });
        if (index < 0)
            return index;
        return index + 1;
    }
    next() {
        this.cursor++;
        if (this.result == null)
            return false;
        return this.cursor < this.result.values.length;
    }
    columnCount() {
        return this.result.columns.length;
    }
    getValue(type, columnIndex) {
        let value = this.result.values[this.cursor][columnIndex - 1];
        this.wasNull = value == null;
        if (type == stringPrimitiveType) {
            return value == null ? null : "" + value;
        }
        if (type == intPrimitiveType) {
            if (value == null || !(typeof value == "number")) {
                return 0;
            }
            return Math.floor(value);
        }
        if (type == floatPrimitiveType || type == doublePrimitiveType) {
            if (value == null || !(typeof value == "number")) {
                return 0;
            }
            return value;
        }
        if (type == booleanPrimitiveType) {
            if (value == null)
                return false;
            return (value + "").indexOf("1") >= 0;
        }
    }
    isAfterLast() {
        return this.cursor > this.result.values.length - 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzdWx0U2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9ydW50aW1lbGlicmFyeS9kYXRhYmFzZS9SZXN1bHRTZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxvQkFBb0IsRUFBcUIsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQXVCLG1CQUFtQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDdE0sT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQVEsTUFBTSwrQkFBK0IsQ0FBQztBQUc1RSxNQUFNLE9BQU8sY0FBZSxTQUFRLEtBQUs7SUFFckMsWUFBWSxNQUFjO1FBQ3RCLEtBQUssQ0FBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLDZFQUE2RSxDQUFDLENBQUM7UUFFMUcsSUFBSSxhQUFhLEdBQVUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksYUFBYSxDQUFDLEVBQ25ELENBQUMsRUFBRSxvQkFBb0IsRUFDcEIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksR0FBRyxHQUFvQixDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JELE9BQU8sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXRCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLDhCQUE4QixFQUMvQyxLQUFLLENB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QUFJLENBQUMsQ0FBQyxPQUFPLEtBQUssSUFBSSxRQUFRLENBQUMsRUFBQztnQkFDNUMsT0FBTyxDQUFDLENBQUM7YUFDWjtZQUNELE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQsSUFBRyxJQUFJLElBQUksb0JBQW9CLEVBQUM7WUFDNUIsSUFBRyxLQUFLLElBQUksSUFBSTtnQkFBRSxPQUFPLEtBQUssQ0FBQztZQUMvQixPQUFPLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekM7SUFFTCxDQUFDO0lBRUQsV0FBVztRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5UmVzdWx0IH0gZnJvbSBcIi4uLy4uL3Rvb2xzL2RhdGFiYXNlL0RhdGFiYXNlVG9vbC5qc1wiO1xyXG5pbXBvcnQgeyBNb2R1bGUgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvcGFyc2VyL01vZHVsZS5qc1wiO1xyXG5pbXBvcnQgeyBLbGFzcyB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9DbGFzcy5qc1wiO1xyXG5pbXBvcnQgeyBib29sZWFuUHJpbWl0aXZlVHlwZSwgY2hhclByaW1pdGl2ZVR5cGUsIGRvdWJsZVByaW1pdGl2ZVR5cGUsIGZsb2F0UHJpbWl0aXZlVHlwZSwgaW50UHJpbWl0aXZlVHlwZSwgU3RyaW5nUHJpbWl0aXZlVHlwZSwgc3RyaW5nUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBNZXRob2QsIFBhcmFtZXRlcmxpc3QsIFR5cGUgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvVHlwZXMuanNcIjtcclxuaW1wb3J0IHsgUnVudGltZU9iamVjdCB9IGZyb20gXCIuLi8uLi9pbnRlcnByZXRlci9SdW50aW1lT2JqZWN0LmpzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgUmVzdWx0U2V0Q2xhc3MgZXh0ZW5kcyBLbGFzcyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICBzdXBlcihcIlJlc3VsdFNldFwiLCBtb2R1bGUsIFwiRWluIFJlc3VsdFNldC1PYmpla3Qgc3BlaWNoZXJ0IGRhcyBFcmdlYm5pcyBlaW5lciBBYmZyYWdlIGFuIGRpZSBEYXRlbmJhbmsuXCIpO1xyXG5cclxuICAgICAgICBsZXQgcmVzdWx0U2V0VHlwZSA9IDxLbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJSZXN1bHRTZXRcIik7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0QmFzZUNsYXNzKDxLbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJPYmplY3RcIikpO1xyXG4gXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIm5leHRcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBib29sZWFuUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgcnNoOiBSZXN1bHRzZXRIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcnNoLm5leHQoKTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0bDvGhydCBlaW4gU1FMLVN0YXRlbWVudCBhdXMuJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcIndhc051bGxcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBib29sZWFuUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgcnNoOiBSZXN1bHRzZXRIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcnNoLndhc051bGw7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdHaWJ0IGdlbmF1IGRhbm4gdHJ1ZSB6dXLDvGNrLCB3ZW5uIGRlciB6dWxldHp0IGdlbGVzZW5lIFdlcnQgbnVsbCB3YXIuJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgbGV0IHR5cGVzID0gW2Jvb2xlYW5QcmltaXRpdmVUeXBlLCBpbnRQcmltaXRpdmVUeXBlLCBmbG9hdFByaW1pdGl2ZVR5cGUsIGRvdWJsZVByaW1pdGl2ZVR5cGUsIHN0cmluZ1ByaW1pdGl2ZVR5cGVdO1xyXG5cclxuICAgICAgICBmb3IobGV0IHR5cGUgb2YgdHlwZXMpe1xyXG5cclxuICAgICAgICAgICAgbGV0IHR5cGVJZEZpcnN0VXBwZXJjYXNlID0gdHlwZS5pZGVudGlmaWVyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdHlwZS5pZGVudGlmaWVyLnN1YnN0cmluZygxKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJnZXRcIit0eXBlSWRGaXJzdFVwcGVyY2FzZSwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcImNvbHVtbkluZGV4XCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgICAgICBdKSwgdHlwZSxcclxuICAgICAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbHVtbkluZGV4OiBudW1iZXIgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgcnNoOiBSZXN1bHRzZXRIZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBpbnRlcnByZXRlciA9IG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY29sdW1uSW5kZXggPCAxIHx8IGNvbHVtbkluZGV4ID4gcnNoLmNvbHVtbkNvdW50KCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci50aHJvd0V4Y2VwdGlvbihcIkRhcyBFcmdlYm5pcyBoYXQga2VpbmUgU3BhbHRlIFwiICsgY29sdW1uSW5kZXggKyBcIi5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHJzaC5pc0FmdGVyTGFzdCgpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJEZXIgQ3Vyc29yIGJlZmluZGV0IHNpY2ggaGludGVyIGRlbSBsZXR6dGVuIERhdGVuc2F0eiBkZXMgUmVzdWx0U2V0LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnNoLmdldFZhbHVlKHR5cGUsIGNvbHVtbkluZGV4KTtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnR2lidCBkZW4gV2VydCBkZXIgU3BhbHRlIG1pdCBkZW0gYW5nZWdlYmVuZW4gU3BhbHRlbmluZGV4IGFscyAnICsgdHlwZS5pZGVudGlmaWVyICsgXCIgenVyw7xjay5cIixcclxuICAgICAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiZ2V0XCIrdHlwZUlkRmlyc3RVcHBlcmNhc2UsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgICAgIHsgaWRlbnRpZmllcjogXCJjb2x1bW5MYWJlbFwiLCB0eXBlOiBzdHJpbmdQcmltaXRpdmVUeXBlLCBkZWNsYXJhdGlvbjogbnVsbCwgdXNhZ2VQb3NpdGlvbnM6IG51bGwsIGlzRmluYWw6IHRydWUgfSxcclxuICAgICAgICAgICAgXSksIHR5cGUsXHJcbiAgICAgICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb2x1bW5MYWJlbDogc3RyaW5nID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJzaDogUmVzdWx0c2V0SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYocnNoLmlzQWZ0ZXJMYXN0KCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci50aHJvd0V4Y2VwdGlvbihcIkRlciBDdXJzb3IgYmVmaW5kZXQgc2ljaCBoaW50ZXIgZGVtIGxldHp0ZW4gRGF0ZW5zYXR6IGRlcyBSZXN1bHRTZXQuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbHVtbkluZGV4OiBudW1iZXIgPSByc2guZ2V0Q29sdW1uSW5kZXgoY29sdW1uTGFiZWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGNvbHVtbkluZGV4IDwgMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyLnRocm93RXhjZXB0aW9uKFwiRGFzIEVyZ2VibmlzIGhhdCBrZWluZSBTcGFsdGUgbWl0IGRlbSBCZXplaWNobmVyIFwiICsgY29sdW1uTGFiZWwgKyBcIi5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnNoLmdldFZhbHVlKHR5cGUsIGNvbHVtbkluZGV4KTtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnR2lidCBkZW4gV2VydCBkZXIgU3BhbHRlIG1pdCBkZW0gYW5nZWdlYmVuZW4gU3BhbHRlbmluZGV4IGFscyAnICsgdHlwZS5pZGVudGlmaWVyICsgXCIgenVyw7xjay5cIixcclxuICAgICAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIFxyXG5cclxuICAgIH1cclxuXHJcbn1cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUmVzdWx0c2V0SGVscGVyIHtcclxuICAgIGN1cnNvcjogbnVtYmVyID0gLTE7XHJcbiAgICB3YXNOdWxsOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZXN1bHQ6IFF1ZXJ5UmVzdWx0KXtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q29sdW1uSW5kZXgoY29sdW1uTGFiZWw6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29sdW1uTGFiZWwgPSBjb2x1bW5MYWJlbC50b0xvY2FsZUxvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBsZXQgaW5kZXggPSB0aGlzLnJlc3VsdC5jb2x1bW5zLmZpbmRJbmRleCgodmFsdWUsIGluZGV4KSA9PiB7cmV0dXJuIHZhbHVlLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT0gY29sdW1uTGFiZWx9KTtcclxuICAgICAgICBpZihpbmRleCA8IDApIHJldHVybiBpbmRleDtcclxuICAgICAgICByZXR1cm4gaW5kZXggKyAxO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBuZXh0KCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHRoaXMuY3Vyc29yKys7XHJcbiAgICAgICAgaWYodGhpcy5yZXN1bHQgPT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmN1cnNvciA8IHRoaXMucmVzdWx0LnZhbHVlcy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgY29sdW1uQ291bnQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHQuY29sdW1ucy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VmFsdWUodHlwZTogVHlwZSwgY29sdW1uSW5kZXg6IG51bWJlcikge1xyXG5cclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnJlc3VsdC52YWx1ZXNbdGhpcy5jdXJzb3JdW2NvbHVtbkluZGV4IC0gMV07XHJcbiAgICAgICAgdGhpcy53YXNOdWxsID0gdmFsdWUgPT0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYodHlwZSA9PSBzdHJpbmdQcmltaXRpdmVUeXBlKXtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyBudWxsIDogXCJcIiArIHZhbHVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodHlwZSA9PSBpbnRQcmltaXRpdmVUeXBlKXtcclxuICAgICAgICAgICAgaWYodmFsdWUgPT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PSBcIm51bWJlclwiKSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih0eXBlID09IGZsb2F0UHJpbWl0aXZlVHlwZSB8fCB0eXBlID09IGRvdWJsZVByaW1pdGl2ZVR5cGUpe1xyXG4gICAgICAgICAgICBpZih2YWx1ZSA9PSBudWxsIHx8ICEodHlwZW9mIHZhbHVlID09IFwibnVtYmVyXCIpKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHR5cGUgPT0gYm9vbGVhblByaW1pdGl2ZVR5cGUpe1xyXG4gICAgICAgICAgICBpZih2YWx1ZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybiAodmFsdWUgKyBcIlwiKS5pbmRleE9mKFwiMVwiKSA+PSAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgaXNBZnRlckxhc3QoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yID4gdGhpcy5yZXN1bHQudmFsdWVzLmxlbmd0aCAtIDE7XHJcbiAgICB9XHJcblxyXG5cclxufSJdfQ==