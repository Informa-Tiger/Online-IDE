import { DatabaseTool } from "../../tools/database/DatabaseTool.js";
import { Klass } from "../../compiler/types/Class.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { DatabaseLongPollingListener } from "../../tools/database/DatabaseLongPollingListener.js";
import { stringPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { PreparedStatementHelper } from "./DatabasePreparedStatement.js";
export class ConnectionClass extends Klass {
    constructor(module) {
        super("Connection", module, "Ein Connection-Objekt repräsentiert die Verbindung zu einer Datenbank auf www.sql-ide.de");
        this.setBaseClass(module.typeStore.getType("Object"));
        let preparedStatementType = module.typeStore.getType("PreparedStatement");
        let statementType = module.typeStore.getType("Statement");
        this.addMethod(new Method("createStatement", new Parameterlist([]), statementType, (parameters) => {
            let o = parameters[0].value;
            let ch = o.intrinsicData["Helper"];
            let stmt = new RuntimeObject(statementType);
            stmt.intrinsicData["ConnectionHelper"] = ch;
            return stmt;
        }, false, false, 'Erstellt ein Statement-Objekt, mit dem Statements zur Datenbank geschickt werden können.', false));
        this.addMethod(new Method("prepareStatement", new Parameterlist([
            { identifier: "query", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), preparedStatementType, (parameters) => {
            let o = parameters[0].value;
            let query = parameters[1].value;
            let ch = o.intrinsicData["Helper"];
            let stmt = new RuntimeObject(preparedStatementType);
            stmt.intrinsicData["Helper"] = new PreparedStatementHelper(ch, query);
            return stmt;
        }, false, false, 'Erstellt ein PreparedStatement-Objekt, mit dem Anweisungen zur Datenbank geschickt werden können.', false));
        this.addMethod(new Method("close", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let ch = o.intrinsicData["Helper"];
            ch.close();
        }, false, false, 'Schließt die Verbindung zur Datenbank.', false));
    }
}
export class ConnectionHelper {
    constructor(main) {
        this.main = main;
        this.skipNextServerSentStatement = false;
        main.getInterpreter().registerDatabaseConnection(this);
    }
    connect(code, callback) {
        let that = this;
        this.main.networkManager.fetchDatabaseAndToken(code, (dbData, token, error) => {
            if (error == null) {
                that.token = token;
                that.databaseData = dbData;
                that.database = new DatabaseTool(that.main);
                that.database.initializeWorker(dbData.templateDump, dbData.statements, (error) => {
                    that.longPollingListener = new DatabaseLongPollingListener(that.main.networkManager, that.token, (firstNewStatementIndex, newStatements, rollbackToVersion) => {
                        that.onServerSentStatements(firstNewStatementIndex, newStatements, rollbackToVersion);
                    });
                    that.longPollingListener.longPoll();
                    callback(null);
                });
            }
            else {
                callback(error);
            }
        });
    }
    close() {
        if (this.longPollingListener != null) {
            this.longPollingListener.close();
            this.longPollingListener = null;
        }
        if (this.database != null) {
            this.database.close();
            this.database = null;
        }
    }
    onServerSentStatements(firstNewStatementIndex, newStatements, rollbackToVersion) {
        if (this.skipNextServerSentStatement) {
            this.skipNextServerSentStatement = false;
            return;
        }
        if (rollbackToVersion != null) {
            // Rollback
            this.databaseData.statements.splice(rollbackToVersion);
            this.database.initializeWorker(this.databaseData.templateDump, this.databaseData.statements);
            return;
        }
        else {
            this.executeStatementsFromServer(firstNewStatementIndex, newStatements);
        }
    }
    executeStatementsFromServer(firstStatementIndex, statements, callback) {
        // connection already closed?
        if (this.database == null) {
            if (callback)
                callback("Keine Datenbankverbindung.");
            return;
        }
        let currentDBVersion = this.databaseData.statements.length;
        let delta = currentDBVersion - firstStatementIndex + 1; // these statements are already there
        if (delta >= statements.length) {
            if (callback)
                callback(null);
            return;
        }
        statements = statements.slice(delta);
        this.databaseData.statements = this.databaseData.statements.concat(statements);
        this.database.executeWriteQueries(statements, () => {
            if (callback != null)
                callback(null);
        }, (errorMessage) => {
            if (callback != null)
                callback(errorMessage);
        });
    }
    executeWriteStatement(query, callback, retrieveLastRowId = false) {
        // connection already closed?
        if (this.database == null) {
            callback("Es besteht keine Verbindung zur Datenbank.", 0);
        }
        let that = this;
        let oldStatementIndex = that.databaseData.statements.length;
        this.database.executeQuery("explain " + query, () => {
            that.skipNextServerSentStatement = true;
            that.main.networkManager.addDatabaseStatement(that.token, oldStatementIndex, [query], (statementsBefore, new_version, errorMessage) => {
                if (errorMessage != null) {
                    callback(errorMessage, 0);
                    return;
                }
                that.executeStatementsFromServer(oldStatementIndex + 1, statementsBefore, (error) => {
                    that.database.executeWriteQueries([query], () => {
                        that.databaseData.statements.push(query);
                        if (!retrieveLastRowId) {
                            callback(null, 0);
                            return;
                        }
                        that.executeQuery("select last_insert_rowid()", (error, data) => {
                            callback(null, data.values[0][0]);
                        });
                    }, (errorMessage) => {
                        that.databaseData.statements.push(query);
                        if (callback != null)
                            callback(errorMessage, 0);
                        // try rollback so that server doesn't store this statement
                        that.main.networkManager.rollbackDatabaseStatement(that.token, that.databaseData.statements.length, () => { });
                    });
                });
            });
        }, (error) => {
            callback(error, 0);
        });
    }
    executeQuery(query, callback) {
        if (this.database == null || this.longPollingListener == null) {
            callback("Es besteht keine Verbindung zur Datenbank.", null);
            return;
        }
        this.database.executeQuery(query, (results) => {
            callback(null, results[0]);
        }, (error) => {
            callback(error, null);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvcnVudGltZWxpYnJhcnkvZGF0YWJhc2UvQ29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsWUFBWSxFQUFlLE1BQU0sc0NBQXNDLENBQUM7QUFFakYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQ2xHLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ2hHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXpFLE1BQU0sT0FBTyxlQUFnQixTQUFRLEtBQUs7SUFFdEMsWUFBWSxNQUFjO1FBQ3RCLEtBQUssQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLDBGQUEwRixDQUFDLENBQUM7UUFFeEgsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzdELElBQUkscUJBQXFCLEdBQVUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqRixJQUFJLGFBQWEsR0FBVSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVqRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQzlELENBQUMsRUFBRSxhQUFhLEVBQ2IsQ0FBQyxVQUFVLEVBQUUs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QUFJLElBQUksRUFBRTtZQUMzRCxRQUFRLENBQUMsNENBQTRDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDN0QsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsT0FBc0IsRUFBRSxFQUFFO1lBQ3pELFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxFQUFFLENBQUMsS0FBYSxFQUFFLEVBQUU7WUFDakIsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFiYXNlRGF0YSwgU2VuZGluZ1N0YXRlbWVudHNNZXNzYWdlRnJvbVNlcnZlciB9IGZyb20gXCIuLi8uLi9jb21tdW5pY2F0aW9uL0RhdGEuanNcIjtcclxuaW1wb3J0IHsgTWFpbiB9IGZyb20gXCIuLi8uLi9tYWluL01haW4uanNcIjtcclxuaW1wb3J0IHsgRGF0YWJhc2VUb29sLCBRdWVyeVJlc3VsdCB9IGZyb20gXCIuLi8uLi90b29scy9kYXRhYmFzZS9EYXRhYmFzZVRvb2wuanNcIjtcclxuaW1wb3J0IHsgTW9kdWxlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3BhcnNlci9Nb2R1bGUuanNcIjtcclxuaW1wb3J0IHsgS2xhc3MgfSBmcm9tIFwiLi4vLi4vY29tcGlsZXIvdHlwZXMvQ2xhc3MuanNcIjtcclxuaW1wb3J0IHsgTWV0aG9kLCBQYXJhbWV0ZXJsaXN0IH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IFJ1bnRpbWVPYmplY3QgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvUnVudGltZU9iamVjdC5qc1wiO1xyXG5pbXBvcnQgeyBEYXRhYmFzZUxvbmdQb2xsaW5nTGlzdGVuZXIgfSBmcm9tIFwiLi4vLi4vdG9vbHMvZGF0YWJhc2UvRGF0YWJhc2VMb25nUG9sbGluZ0xpc3RlbmVyLmpzXCI7XHJcbmltcG9ydCB7IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIHZvaWRQcmltaXRpdmVUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XHJcbmltcG9ydCB7IFByZXBhcmVkU3RhdGVtZW50SGVscGVyIH0gZnJvbSBcIi4vRGF0YWJhc2VQcmVwYXJlZFN0YXRlbWVudC5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb25DbGFzcyBleHRlbmRzIEtsYXNzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgICAgIHN1cGVyKFwiQ29ubmVjdGlvblwiLCBtb2R1bGUsIFwiRWluIENvbm5lY3Rpb24tT2JqZWt0IHJlcHLDpHNlbnRpZXJ0IGRpZSBWZXJiaW5kdW5nIHp1IGVpbmVyIERhdGVuYmFuayBhdWYgd3d3LnNxbC1pZGUuZGVcIik7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0QmFzZUNsYXNzKDxLbGFzcz5tb2R1bGUudHlwZVN0b3JlLmdldFR5cGUoXCJPYmplY3RcIikpO1xyXG4gICAgICAgIGxldCBwcmVwYXJlZFN0YXRlbWVudFR5cGUgPSA8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiUHJlcGFyZWRTdGF0ZW1lbnRcIik7XHJcbiAgICAgICAgbGV0IHN0YXRlbWVudFR5cGUgPSA8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiU3RhdGVtZW50XCIpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiY3JlYXRlU3RhdGVtZW50XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICBdKSwgc3RhdGVtZW50VHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2g6IENvbm5lY3Rpb25IZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHN0bXQ6IFJ1bnRpbWVPYmplY3QgPSBuZXcgUnVudGltZU9iamVjdChzdGF0ZW1lbnRUeXBlKTtcclxuICAgICAgICAgICAgICAgIHN0bXQuaW50cmluc2ljRGF0YVtcIkNvbm5lY3Rpb25IZWxwZXJcIl0gPSBjaDtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RtdDtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0Vyc3RlbGx0IGVpbiBTdGF0ZW1lbnQtT2JqZWt0LCBtaXQgZGVtIFN0YXRlbWVudHMgenVyIERhdGVuYmFuayBnZXNjaGlja3Qgd2VyZGVuIGvDtm5uZW4uJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcInByZXBhcmVTdGF0ZW1lbnRcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICB7IGlkZW50aWZpZXI6IFwicXVlcnlcIiwgdHlwZTogc3RyaW5nUHJpbWl0aXZlVHlwZSwgZGVjbGFyYXRpb246IG51bGwsIHVzYWdlUG9zaXRpb25zOiBudWxsLCBpc0ZpbmFsOiB0cnVlIH1cclxuICAgICAgICBdKSwgcHJlcGFyZWRTdGF0ZW1lbnRUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBxdWVyeTogc3RyaW5nID0gcGFyYW1ldGVyc1sxXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgY2g6IENvbm5lY3Rpb25IZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHN0bXQ6IFJ1bnRpbWVPYmplY3QgPSBuZXcgUnVudGltZU9iamVjdChwcmVwYXJlZFN0YXRlbWVudFR5cGUpO1xyXG4gICAgICAgICAgICAgICAgc3RtdC5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdID0gbmV3IFByZXBhcmVkU3RhdGVtZW50SGVscGVyKGNoLCBxdWVyeSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0bXQ7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdFcnN0ZWxsdCBlaW4gUHJlcGFyZWRTdGF0ZW1lbnQtT2JqZWt0LCBtaXQgZGVtIEFud2Vpc3VuZ2VuIHp1ciBEYXRlbmJhbmsgZ2VzY2hpY2t0IHdlcmRlbiBrw7ZubmVuLicsXHJcbiAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJjbG9zZVwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIHZvaWRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGxldCBjaDogQ29ubmVjdGlvbkhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkhlbHBlclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICBjaC5jbG9zZSgpO1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnU2NobGllw590IGRpZSBWZXJiaW5kdW5nIHp1ciBEYXRlbmJhbmsuJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb25IZWxwZXIge1xyXG5cclxuICAgIGRhdGFiYXNlOiBEYXRhYmFzZVRvb2w7XHJcbiAgICBkYXRhYmFzZURhdGE6IERhdGFiYXNlRGF0YTtcclxuICAgIHRva2VuOiBzdHJpbmc7XHJcbiAgICBsb25nUG9sbGluZ0xpc3RlbmVyOiBEYXRhYmFzZUxvbmdQb2xsaW5nTGlzdGVuZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtYWluOiBNYWluKSB7XHJcblxyXG4gICAgICAgIG1haW4uZ2V0SW50ZXJwcmV0ZXIoKS5yZWdpc3RlckRhdGFiYXNlQ29ubmVjdGlvbih0aGlzKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdChjb2RlOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyb3I6IHN0cmluZykgPT4gdm9pZCkge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuICAgICAgICB0aGlzLm1haW4ubmV0d29ya01hbmFnZXIuZmV0Y2hEYXRhYmFzZUFuZFRva2VuKGNvZGUsIChkYkRhdGEsIHRva2VuLCBlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhhdC50b2tlbiA9IHRva2VuO1xyXG4gICAgICAgICAgICAgICAgdGhhdC5kYXRhYmFzZURhdGEgPSBkYkRhdGE7XHJcbiAgICAgICAgICAgICAgICB0aGF0LmRhdGFiYXNlID0gbmV3IERhdGFiYXNlVG9vbCh0aGF0Lm1haW4pO1xyXG4gICAgICAgICAgICAgICAgdGhhdC5kYXRhYmFzZS5pbml0aWFsaXplV29ya2VyKGRiRGF0YS50ZW1wbGF0ZUR1bXAsIGRiRGF0YS5zdGF0ZW1lbnRzLCAoZXJyb3IpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5sb25nUG9sbGluZ0xpc3RlbmVyID0gbmV3IERhdGFiYXNlTG9uZ1BvbGxpbmdMaXN0ZW5lcih0aGF0Lm1haW4ubmV0d29ya01hbmFnZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudG9rZW4sIChmaXJzdE5ld1N0YXRlbWVudEluZGV4LCBuZXdTdGF0ZW1lbnRzLCByb2xsYmFja1RvVmVyc2lvbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vblNlcnZlclNlbnRTdGF0ZW1lbnRzKGZpcnN0TmV3U3RhdGVtZW50SW5kZXgsIG5ld1N0YXRlbWVudHMsIHJvbGxiYWNrVG9WZXJzaW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5sb25nUG9sbGluZ0xpc3RlbmVyLmxvbmdQb2xsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMubG9uZ1BvbGxpbmdMaXN0ZW5lciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9uZ1BvbGxpbmdMaXN0ZW5lci5jbG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmxvbmdQb2xsaW5nTGlzdGVuZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodGhpcy5kYXRhYmFzZSAhPSBudWxsKXtcclxuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5jbG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFiYXNlID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNraXBOZXh0U2VydmVyU2VudFN0YXRlbWVudDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgb25TZXJ2ZXJTZW50U3RhdGVtZW50cyhmaXJzdE5ld1N0YXRlbWVudEluZGV4OiBudW1iZXIsIG5ld1N0YXRlbWVudHM6IHN0cmluZ1tdLCByb2xsYmFja1RvVmVyc2lvbjogbnVtYmVyKSB7XHJcblxyXG4gICAgICAgIGlmKHRoaXMuc2tpcE5leHRTZXJ2ZXJTZW50U3RhdGVtZW50KXtcclxuICAgICAgICAgICAgdGhpcy5za2lwTmV4dFNlcnZlclNlbnRTdGF0ZW1lbnQgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHJvbGxiYWNrVG9WZXJzaW9uICE9IG51bGwpIHtcclxuICAgICAgICAgICAgLy8gUm9sbGJhY2tcclxuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZURhdGEuc3RhdGVtZW50cy5zcGxpY2Uocm9sbGJhY2tUb1ZlcnNpb24pO1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFiYXNlLmluaXRpYWxpemVXb3JrZXIodGhpcy5kYXRhYmFzZURhdGEudGVtcGxhdGVEdW1wLCB0aGlzLmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZVN0YXRlbWVudHNGcm9tU2VydmVyKGZpcnN0TmV3U3RhdGVtZW50SW5kZXgsIG5ld1N0YXRlbWVudHMpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGVTdGF0ZW1lbnRzRnJvbVNlcnZlcihmaXJzdFN0YXRlbWVudEluZGV4OiBudW1iZXIsIHN0YXRlbWVudHM6IHN0cmluZ1tdLFxyXG4gICAgICAgIGNhbGxiYWNrPzogKGVycm9yOiBzdHJpbmcpID0+IHZvaWQpIHtcclxuXHJcbiAgICAgICAgLy8gY29ubmVjdGlvbiBhbHJlYWR5IGNsb3NlZD9cclxuICAgICAgICBpZiAodGhpcy5kYXRhYmFzZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmKGNhbGxiYWNrKSBjYWxsYmFjayhcIktlaW5lIERhdGVuYmFua3ZlcmJpbmR1bmcuXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgY3VycmVudERCVmVyc2lvbiA9IHRoaXMuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMubGVuZ3RoO1xyXG4gICAgICAgIGxldCBkZWx0YSA9IGN1cnJlbnREQlZlcnNpb24gLSBmaXJzdFN0YXRlbWVudEluZGV4ICsgMTsgLy8gdGhlc2Ugc3RhdGVtZW50cyBhcmUgYWxyZWFkeSB0aGVyZVxyXG4gICAgICAgIGlmIChkZWx0YSA+PSBzdGF0ZW1lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2sobnVsbCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RhdGVtZW50cyA9IHN0YXRlbWVudHMuc2xpY2UoZGVsdGEpO1xyXG4gICAgICAgIHRoaXMuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMgPSB0aGlzLmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzLmNvbmNhdChzdGF0ZW1lbnRzKTtcclxuXHJcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjdXRlV3JpdGVRdWVyaWVzKHN0YXRlbWVudHMsICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIGNhbGxiYWNrKG51bGwpO1xyXG4gICAgICAgIH0sIChlcnJvck1lc3NhZ2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIGNhbGxiYWNrKGVycm9yTWVzc2FnZSk7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlV3JpdGVTdGF0ZW1lbnQocXVlcnk6IHN0cmluZywgY2FsbGJhY2s6IChlcnJvcjogc3RyaW5nLCBsYXN0Um93SWQ6IG51bWJlcikgPT4gdm9pZCwgcmV0cmlldmVMYXN0Um93SWQ6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG5cclxuICAgICAgICAvLyBjb25uZWN0aW9uIGFscmVhZHkgY2xvc2VkP1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFiYXNlID09IG51bGwpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soXCJFcyBiZXN0ZWh0IGtlaW5lIFZlcmJpbmR1bmcgenVyIERhdGVuYmFuay5cIiwgMCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgbGV0IG9sZFN0YXRlbWVudEluZGV4ID0gdGhhdC5kYXRhYmFzZURhdGEuc3RhdGVtZW50cy5sZW5ndGg7XHJcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjdXRlUXVlcnkoXCJleHBsYWluIFwiICsgcXVlcnksICgpID0+IHtcclxuXHJcbiAgICAgICAgICAgIHRoYXQuc2tpcE5leHRTZXJ2ZXJTZW50U3RhdGVtZW50ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhhdC5tYWluLm5ldHdvcmtNYW5hZ2VyLmFkZERhdGFiYXNlU3RhdGVtZW50KHRoYXQudG9rZW4sIG9sZFN0YXRlbWVudEluZGV4LFxyXG4gICAgICAgICAgICAgICAgW3F1ZXJ5XSwgKHN0YXRlbWVudHNCZWZvcmUsIG5ld192ZXJzaW9uLCBlcnJvck1lc3NhZ2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3JNZXNzYWdlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyb3JNZXNzYWdlLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlU3RhdGVtZW50c0Zyb21TZXJ2ZXIob2xkU3RhdGVtZW50SW5kZXggKyAxLCBzdGF0ZW1lbnRzQmVmb3JlLCAoZXJyb3I6IHN0cmluZykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5kYXRhYmFzZS5leGVjdXRlV3JpdGVRdWVyaWVzKFtxdWVyeV0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMucHVzaChxdWVyeSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJldHJpZXZlTGFzdFJvd0lkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlUXVlcnkoXCJzZWxlY3QgbGFzdF9pbnNlcnRfcm93aWQoKVwiLCAoZXJyb3IsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhLnZhbHVlc1swXVswXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAoZXJyb3JNZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzLnB1c2gocXVlcnkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIGNhbGxiYWNrKGVycm9yTWVzc2FnZSwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnkgcm9sbGJhY2sgc28gdGhhdCBzZXJ2ZXIgZG9lc24ndCBzdG9yZSB0aGlzIHN0YXRlbWVudFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5tYWluLm5ldHdvcmtNYW5hZ2VyLnJvbGxiYWNrRGF0YWJhc2VTdGF0ZW1lbnQodGhhdC50b2tlbiwgdGhhdC5kYXRhYmFzZURhdGEuc3RhdGVtZW50cy5sZW5ndGgsICgpID0+IHt9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhlcnJvciwgMCk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZXhlY3V0ZVF1ZXJ5KHF1ZXJ5OiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyb3I6IHN0cmluZywgZGF0YTogUXVlcnlSZXN1bHQpID0+IHZvaWQpIHtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2UgPT0gbnVsbCB8fCB0aGlzLmxvbmdQb2xsaW5nTGlzdGVuZXIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhcIkVzIGJlc3RlaHQga2VpbmUgVmVyYmluZHVuZyB6dXIgRGF0ZW5iYW5rLlwiLCBudWxsKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjdXRlUXVlcnkocXVlcnksIChyZXN1bHRzOiBRdWVyeVJlc3VsdFtdKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHNbMF0pO1xyXG4gICAgICAgIH0sIChlcnJvcjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgICB9KVxyXG5cclxuICAgIH1cclxuXHJcbn0iXX0=