import { DatabaseTool } from "../../tools/database/DatabaseTool.js";
import { Klass } from "../../compiler/types/Class.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { DatabaseLongPollingListener } from "../../tools/database/DatabaseLongPollingListener.js";
import { stringPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { PreparedStatementHelper } from "./DatabasePreparedStatement.js";
export class ConnectionClass extends Klass {
    constructor(module) {
        super("Connection", module, "Ein Connection-Objekt repräsentiert die Verbindung zu einer Datenbank auf www.sql-ide.de");
        this.setBaseClass(module.typeStore.getType("Object"));
        let preparedStatementType = module.typeStore.getType("PreparedStatement");
        let statementType = module.typeStore.getType("Statement");
        this.addMethod(new Method("createStatement", new Parameterlist([]), statementType, (parameters) => {
            let o = parameters[0].value;
            let ch = o.intrinsicData["Helper"];
            let stmt = new RuntimeObject(statementType);
            stmt.intrinsicData["ConnectionHelper"] = ch;
            return stmt;
        }, false, false, 'Erstellt ein Statement-Objekt, mit dem Statements zur Datenbank geschickt werden können.', false));
        this.addMethod(new Method("prepareStatement", new Parameterlist([
            { identifier: "query", type: stringPrimitiveType, declaration: null, usagePositions: null, isFinal: true }
        ]), preparedStatementType, (parameters) => {
            let o = parameters[0].value;
            let query = parameters[1].value;
            let ch = o.intrinsicData["Helper"];
            let stmt = new RuntimeObject(preparedStatementType);
            stmt.intrinsicData["Helper"] = new PreparedStatementHelper(ch, query);
            return stmt;
        }, false, false, 'Erstellt ein PreparedStatement-Objekt, mit dem Anweisungen zur Datenbank geschickt werden können.', false));
        this.addMethod(new Method("close", new Parameterlist([]), voidPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let ch = o.intrinsicData["Helper"];
            ch.close();
        }, false, false, 'Schließt die Verbindung zur Datenbank.', false));
    }
}
export class ConnectionHelper {
    constructor(main) {
        this.main = main;
        this.skipNextServerSentStatement = false;
        main.getInterpreter().registerDatabaseConnection(this);
    }
    connect(code, callback) {
        let that = this;
        this.main.networkManager.fetchDatabaseAndToken(code, (dbData, token, error) => {
            if (error == null) {
                that.token = token;
                that.databaseData = dbData;
                that.database = new DatabaseTool(that.main);
                that.database.initializeWorker(dbData.templateDump, dbData.statements, (error) => {
                    that.longPollingListener = new DatabaseLongPollingListener(that.main.networkManager, that.token, (firstNewStatementIndex, newStatements, rollbackToVersion) => {
                        that.onServerSentStatements(firstNewStatementIndex, newStatements, rollbackToVersion);
                    });
                    that.longPollingListener.longPoll();
                    callback(null);
                });
            }
            else {
                callback(error);
            }
        });
    }
    close() {
        if (this.longPollingListener != null) {
            this.longPollingListener.close();
            this.longPollingListener = null;
        }
        if (this.database != null) {
            this.database.close();
            this.database = null;
        }
    }
    onServerSentStatements(firstNewStatementIndex, newStatements, rollbackToVersion) {
        if (this.skipNextServerSentStatement) {
            this.skipNextServerSentStatement = false;
            return;
        }
        if (rollbackToVersion != null) {
            // Rollback
            this.databaseData.statements.splice(rollbackToVersion);
            this.database.initializeWorker(this.databaseData.templateDump, this.databaseData.statements);
            return;
        }
        else {
            this.executeStatementsFromServer(firstNewStatementIndex, newStatements);
        }
    }
    executeStatementsFromServer(firstStatementIndex, statements, callback) {
        // connection already closed?
        if (this.database == null) {
            if (callback)
                callback("Keine Datenbankverbindung.");
            return;
        }
        let currentDBVersion = this.databaseData.statements.length;
        let delta = currentDBVersion - firstStatementIndex + 1; // these statements are already there
        if (delta >= statements.length) {
            if (callback)
                callback(null);
            return;
        }
        statements = statements.slice(delta);
        this.databaseData.statements = this.databaseData.statements.concat(statements);
        this.database.executeWriteQueries(statements, () => {
            if (callback != null)
                callback(null);
        }, (errorMessage) => {
            if (callback != null)
                callback(errorMessage);
        });
    }
    executeWriteStatement(query, callback, retrieveLastRowId = false) {
        // connection already closed?
        if (this.database == null) {
            callback("Es besteht keine Verbindung zur Datenbank.", 0);
        }
        let that = this;
        let oldStatementIndex = that.databaseData.statements.length;
        this.database.executeQuery("explain " + query, () => {
            that.skipNextServerSentStatement = true;
            that.main.networkManager.addDatabaseStatement(that.token, oldStatementIndex, [query], (statementsBefore, new_version, errorMessage) => {
                if (errorMessage != null) {
                    callback(errorMessage, 0);
                    return;
                }
                that.executeStatementsFromServer(oldStatementIndex + 1, statementsBefore, (error) => {
                    that.database.executeWriteQueries([query], () => {
                        that.databaseData.statements.push(query);
                        if (!retrieveLastRowId) {
                            callback(null, 0);
                            return;
                        }
                        that.executeQuery("select last_insert_rowid()", (error, data) => {
                            callback(null, data.values[0][0]);
                        });
                    }, (errorMessage) => {
                        that.databaseData.statements.push(query);
                        if (callback != null)
                            callback(errorMessage, 0);
                        // try rollback so that server doesn't store this statement
                        that.main.networkManager.rollbackDatabaseStatement(that.token, that.databaseData.statements.length, () => { });
                    });
                });
            });
        }, (error) => {
            callback(error, 0);
        });
    }
    executeQuery(query, callback) {
        if (this.database == null || this.longPollingListener == null) {
            callback("Es besteht keine Verbindung zur Datenbank.", null);
            return;
        }
        this.database.executeQuery(query, (results) => {
            callback(null, results.length == 0 ? { columns: [], values: [] } : results[0]);
        }, (error) => {
            callback(error, null);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvcnVudGltZWxpYnJhcnkvZGF0YWJhc2UvQ29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsWUFBWSxFQUFlLE1BQU0sc0NBQXNDLENBQUM7QUFFakYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQ2xHLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ2hHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXpFLE1BQU0sT0FBTyxlQUFnQixTQUFRLEtBQUs7SUFFdEMsWUFBWSxNQUFjO1FBQ3RCLEtBQUssQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLDBGQUEwRixDQUFDLENBQUM7UUFFeEgsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzdELElBQUkscUJBQXFCLEdBQVUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqRixJQUFJLGFBQWEsR0FBVSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVqRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFLElBQUksYUFBYSxDQUFDLEVBQzlELENBQUMsRUFBRSxhQUFhLEVBQ2IsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksRUFBRSxHQUFxQixDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXJELElBQUksSUFBSSxHQUFrQixJQUFJLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUMzRCxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRTVDLE9BQU8sSUFBSSxDQUFDO1FBRWhCLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLDBGQUEwRixFQUMzRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRVosSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLGFBQWEsQ0FBQztZQUM1RCxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO1NBQzdHLENBQUMsRUFBRSxxQkFBcUIsRUFDckIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksS0FBSyxHQUFXLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFFeEMsSUFBSSxFQUFFLEdBQXFCLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFckQsSUFBSSxJQUFJLEdBQWtCLElBQUksYUFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUM7WUFDbkUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLHVCQUF1QixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUV0RSxPQUFPLElBQUksQ0FBQztRQUVoQixDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxtR0FBbUcsRUFDcEgsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVaLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksYUFBYSxDQUFDLEVBQ3BELENBQUMsRUFBRSxpQkFBaUIsRUFDakIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksRUFBRSxHQUFxQixDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXJELEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVmLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLHdDQUF3QyxFQUN6RCxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRWhCLENBQUM7Q0FFSjtBQUdELE1BQU0sT0FBTyxnQkFBZ0I7SUFPekIsWUFBb0IsSUFBVTtRQUFWLFNBQUksR0FBSixJQUFJLENBQU07UUEwQzlCLGdDQUEyQixHQUFZLEtBQUssQ0FBQztRQXhDekMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTNELENBQUM7SUFFRCxPQUFPLENBQUMsSUFBWSxFQUFFLFFBQWlDO1FBQ25ELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzFFLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtnQkFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztnQkFDbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM1QyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUU3RSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFDL0UsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLHNCQUFzQixFQUFFLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxFQUFFO3dCQUNyRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsc0JBQXNCLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixDQUFDLENBQUM7b0JBQzFGLENBQUMsQ0FBQyxDQUFBO29CQUVOLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDcEMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQixDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNILFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNuQjtRQUNMLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVELEtBQUs7UUFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLEVBQUU7WUFDbEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7U0FDbkM7UUFFRCxJQUFHLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFDO1lBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7U0FDeEI7SUFFTCxDQUFDO0lBR0Qsc0JBQXNCLENBQUMsc0JBQThCLEVBQUUsYUFBdUIsRUFBRSxpQkFBeUI7UUFFckcsSUFBRyxJQUFJLENBQUMsMkJBQTJCLEVBQUM7WUFDaEMsSUFBSSxDQUFDLDJCQUEyQixHQUFHLEtBQUssQ0FBQztZQUN6QyxPQUFPO1NBQ1Y7UUFFRCxJQUFJLGlCQUFpQixJQUFJLElBQUksRUFBRTtZQUMzQixXQUFXO1lBQ1gsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzdGLE9BQU87U0FDVjthQUFNO1lBQ0gsSUFBSSxDQUFDLDJCQUEyQixDQUFDLHNCQUFzQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQzNFO0lBR0wsQ0FBQztJQUVELDJCQUEyQixDQUFDLG1CQUEyQixFQUFFLFVBQW9CLEVBQ3pFLFFBQWtDO1FBRWxDLDZCQUE2QjtRQUM3QixJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ3ZCLElBQUcsUUFBUTtnQkFBRSxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQztZQUNwRCxPQUFPO1NBQ1Y7UUFFRCxJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQztRQUMzRCxJQUFJLEtBQUssR0FBRyxnQkFBZ0IsR0FBRyxtQkFBbUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxxQ0FBcUM7UUFDN0YsSUFBSSxLQUFLLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUM1QixJQUFHLFFBQVE7Z0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVCLE9BQU87U0FDVjtRQUNELFVBQVUsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUvRSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7WUFDL0MsSUFBSSxRQUFRLElBQUksSUFBSTtnQkFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDaEIsSUFBSSxRQUFRLElBQUksSUFBSTtnQkFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBRUQscUJBQXFCLENBQUMsS0FBYSxFQUFFLFFBQW9ELEVBQUUsb0JBQTZCLEtBQUs7UUFFekgsNkJBQTZCO1FBQzdCLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUU7WUFDdkIsUUFBUSxDQUFDLDRDQUE0QyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzdEO1FBRUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBQzVELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFVBQVUsR0FBRyxLQUFLLEVBQUUsR0FBRyxFQUFFO1lBRWhELElBQUksQ0FBQywyQkFBMkIsR0FBRyxJQUFJLENBQUM7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxpQkFBaUIsRUFDdkUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsRUFBRTtnQkFDckQsSUFBSSxZQUFZLElBQUksSUFBSSxFQUFFO29CQUN0QixRQUFRLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUMxQixPQUFPO2lCQUNWO2dCQUVELElBQUksQ0FBQywyQkFBMkIsQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRTtvQkFFeEYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRTt3QkFDNUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUN6QyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7NEJBQ3BCLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7NEJBQ2xCLE9BQU87eUJBQ1Y7d0JBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRTs0QkFDNUQsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3RDLENBQUMsQ0FBQyxDQUFBO29CQUNOLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxFQUFFO3dCQUNoQixJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3pDLElBQUksUUFBUSxJQUFJLElBQUk7NEJBQUUsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQzt3QkFDaEQsMkRBQTJEO3dCQUMzRCxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQTtvQkFDakgsQ0FBQyxDQUFDLENBQUE7Z0JBR04sQ0FBQyxDQUFDLENBQUM7WUFFUCxDQUFDLENBQUMsQ0FBQTtRQUVWLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ1QsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7SUFFRCxZQUFZLENBQUMsS0FBYSxFQUFFLFFBQW9EO1FBRTVFLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLG1CQUFtQixJQUFJLElBQUksRUFBRTtZQUMzRCxRQUFRLENBQUMsNENBQTRDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDN0QsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsT0FBc0IsRUFBRSxFQUFFO1lBQ3pELFFBQVEsQ0FBQyxJQUFJLEVBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hGLENBQUMsRUFBRSxDQUFDLEtBQWEsRUFBRSxFQUFFO1lBQ2pCLFFBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhYmFzZURhdGEsIFNlbmRpbmdTdGF0ZW1lbnRzTWVzc2FnZUZyb21TZXJ2ZXIgfSBmcm9tIFwiLi4vLi4vY29tbXVuaWNhdGlvbi9EYXRhLmpzXCI7XHJcbmltcG9ydCB7IE1haW4gfSBmcm9tIFwiLi4vLi4vbWFpbi9NYWluLmpzXCI7XHJcbmltcG9ydCB7IERhdGFiYXNlVG9vbCwgUXVlcnlSZXN1bHQgfSBmcm9tIFwiLi4vLi4vdG9vbHMvZGF0YWJhc2UvRGF0YWJhc2VUb29sLmpzXCI7XHJcbmltcG9ydCB7IE1vZHVsZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IEtsYXNzIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IE1ldGhvZCwgUGFyYW1ldGVybGlzdCB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9UeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL1J1bnRpbWVPYmplY3QuanNcIjtcclxuaW1wb3J0IHsgRGF0YWJhc2VMb25nUG9sbGluZ0xpc3RlbmVyIH0gZnJvbSBcIi4uLy4uL3Rvb2xzL2RhdGFiYXNlL0RhdGFiYXNlTG9uZ1BvbGxpbmdMaXN0ZW5lci5qc1wiO1xyXG5pbXBvcnQgeyBzdHJpbmdQcmltaXRpdmVUeXBlLCB2b2lkUHJpbWl0aXZlVHlwZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9QcmltaXRpdmVUeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBQcmVwYXJlZFN0YXRlbWVudEhlbHBlciB9IGZyb20gXCIuL0RhdGFiYXNlUHJlcGFyZWRTdGF0ZW1lbnQuanNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBDb25uZWN0aW9uQ2xhc3MgZXh0ZW5kcyBLbGFzcyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IobW9kdWxlOiBNb2R1bGUpIHtcclxuICAgICAgICBzdXBlcihcIkNvbm5lY3Rpb25cIiwgbW9kdWxlLCBcIkVpbiBDb25uZWN0aW9uLU9iamVrdCByZXByw6RzZW50aWVydCBkaWUgVmVyYmluZHVuZyB6dSBlaW5lciBEYXRlbmJhbmsgYXVmIHd3dy5zcWwtaWRlLmRlXCIpO1xyXG5cclxuICAgICAgICB0aGlzLnNldEJhc2VDbGFzcyg8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiT2JqZWN0XCIpKTtcclxuICAgICAgICBsZXQgcHJlcGFyZWRTdGF0ZW1lbnRUeXBlID0gPEtsYXNzPm1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIlByZXBhcmVkU3RhdGVtZW50XCIpO1xyXG4gICAgICAgIGxldCBzdGF0ZW1lbnRUeXBlID0gPEtsYXNzPm1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIlN0YXRlbWVudFwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImNyZWF0ZVN0YXRlbWVudFwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIHN0YXRlbWVudFR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IGNoOiBDb25uZWN0aW9uSGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBzdG10OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3Qoc3RhdGVtZW50VHlwZSk7XHJcbiAgICAgICAgICAgICAgICBzdG10LmludHJpbnNpY0RhdGFbXCJDb25uZWN0aW9uSGVscGVyXCJdID0gY2g7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0bXQ7XHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdFcnN0ZWxsdCBlaW4gU3RhdGVtZW50LU9iamVrdCwgbWl0IGRlbSBTdGF0ZW1lbnRzIHp1ciBEYXRlbmJhbmsgZ2VzY2hpY2t0IHdlcmRlbiBrw7ZubmVuLicsXHJcbiAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJwcmVwYXJlU3RhdGVtZW50XCIsIG5ldyBQYXJhbWV0ZXJsaXN0KFtcclxuICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInF1ZXJ5XCIsIHR5cGU6IHN0cmluZ1ByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgXSksIHByZXBhcmVkU3RhdGVtZW50VHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgcXVlcnk6IHN0cmluZyA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGNoOiBDb25uZWN0aW9uSGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBzdG10OiBSdW50aW1lT2JqZWN0ID0gbmV3IFJ1bnRpbWVPYmplY3QocHJlcGFyZWRTdGF0ZW1lbnRUeXBlKTtcclxuICAgICAgICAgICAgICAgIHN0bXQuaW50cmluc2ljRGF0YVtcIkhlbHBlclwiXSA9IG5ldyBQcmVwYXJlZFN0YXRlbWVudEhlbHBlcihjaCwgcXVlcnkpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBzdG10O1xyXG5cclxuICAgICAgICAgICAgfSwgZmFsc2UsIGZhbHNlLCAnRXJzdGVsbHQgZWluIFByZXBhcmVkU3RhdGVtZW50LU9iamVrdCwgbWl0IGRlbSBBbndlaXN1bmdlbiB6dXIgRGF0ZW5iYW5rIGdlc2NoaWNrdCB3ZXJkZW4ga8O2bm5lbi4nLFxyXG4gICAgICAgICAgICBmYWxzZSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFkZE1ldGhvZChuZXcgTWV0aG9kKFwiY2xvc2VcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgKHBhcmFtZXRlcnMpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbzogUnVudGltZU9iamVjdCA9IHBhcmFtZXRlcnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2g6IENvbm5lY3Rpb25IZWxwZXIgPSBvLmludHJpbnNpY0RhdGFbXCJIZWxwZXJcIl07XHJcblxyXG4gICAgICAgICAgICAgICAgY2guY2xvc2UoKTtcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ1NjaGxpZcOfdCBkaWUgVmVyYmluZHVuZyB6dXIgRGF0ZW5iYW5rLicsXHJcbiAgICAgICAgICAgIGZhbHNlKSk7XHJcblxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBDb25uZWN0aW9uSGVscGVyIHtcclxuXHJcbiAgICBkYXRhYmFzZTogRGF0YWJhc2VUb29sO1xyXG4gICAgZGF0YWJhc2VEYXRhOiBEYXRhYmFzZURhdGE7XHJcbiAgICB0b2tlbjogc3RyaW5nO1xyXG4gICAgbG9uZ1BvbGxpbmdMaXN0ZW5lcjogRGF0YWJhc2VMb25nUG9sbGluZ0xpc3RlbmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFpbjogTWFpbikge1xyXG5cclxuICAgICAgICBtYWluLmdldEludGVycHJldGVyKCkucmVnaXN0ZXJEYXRhYmFzZUNvbm5lY3Rpb24odGhpcyk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGNvbm5lY3QoY29kZTogc3RyaW5nLCBjYWxsYmFjazogKGVycm9yOiBzdHJpbmcpID0+IHZvaWQpIHtcclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5tYWluLm5ldHdvcmtNYW5hZ2VyLmZldGNoRGF0YWJhc2VBbmRUb2tlbihjb2RlLCAoZGJEYXRhLCB0b2tlbiwgZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycm9yID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRoYXQudG9rZW4gPSB0b2tlbjtcclxuICAgICAgICAgICAgICAgIHRoYXQuZGF0YWJhc2VEYXRhID0gZGJEYXRhO1xyXG4gICAgICAgICAgICAgICAgdGhhdC5kYXRhYmFzZSA9IG5ldyBEYXRhYmFzZVRvb2wodGhhdC5tYWluKTtcclxuICAgICAgICAgICAgICAgIHRoYXQuZGF0YWJhc2UuaW5pdGlhbGl6ZVdvcmtlcihkYkRhdGEudGVtcGxhdGVEdW1wLCBkYkRhdGEuc3RhdGVtZW50cywgKGVycm9yKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQubG9uZ1BvbGxpbmdMaXN0ZW5lciA9IG5ldyBEYXRhYmFzZUxvbmdQb2xsaW5nTGlzdGVuZXIodGhhdC5tYWluLm5ldHdvcmtNYW5hZ2VyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRva2VuLCAoZmlyc3ROZXdTdGF0ZW1lbnRJbmRleCwgbmV3U3RhdGVtZW50cywgcm9sbGJhY2tUb1ZlcnNpb24pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQub25TZXJ2ZXJTZW50U3RhdGVtZW50cyhmaXJzdE5ld1N0YXRlbWVudEluZGV4LCBuZXdTdGF0ZW1lbnRzLCByb2xsYmFja1RvVmVyc2lvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQubG9uZ1BvbGxpbmdMaXN0ZW5lci5sb25nUG9sbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmxvbmdQb2xsaW5nTGlzdGVuZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLmxvbmdQb2xsaW5nTGlzdGVuZXIuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5sb25nUG9sbGluZ0xpc3RlbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHRoaXMuZGF0YWJhc2UgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBza2lwTmV4dFNlcnZlclNlbnRTdGF0ZW1lbnQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIG9uU2VydmVyU2VudFN0YXRlbWVudHMoZmlyc3ROZXdTdGF0ZW1lbnRJbmRleDogbnVtYmVyLCBuZXdTdGF0ZW1lbnRzOiBzdHJpbmdbXSwgcm9sbGJhY2tUb1ZlcnNpb246IG51bWJlcikge1xyXG5cclxuICAgICAgICBpZih0aGlzLnNraXBOZXh0U2VydmVyU2VudFN0YXRlbWVudCl7XHJcbiAgICAgICAgICAgIHRoaXMuc2tpcE5leHRTZXJ2ZXJTZW50U3RhdGVtZW50ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyb2xsYmFja1RvVmVyc2lvbiAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIC8vIFJvbGxiYWNrXHJcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMuc3BsaWNlKHJvbGxiYWNrVG9WZXJzaW9uKTtcclxuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5pbml0aWFsaXplV29ya2VyKHRoaXMuZGF0YWJhc2VEYXRhLnRlbXBsYXRlRHVtcCwgdGhpcy5kYXRhYmFzZURhdGEuc3RhdGVtZW50cyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGVTdGF0ZW1lbnRzRnJvbVNlcnZlcihmaXJzdE5ld1N0YXRlbWVudEluZGV4LCBuZXdTdGF0ZW1lbnRzKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlU3RhdGVtZW50c0Zyb21TZXJ2ZXIoZmlyc3RTdGF0ZW1lbnRJbmRleDogbnVtYmVyLCBzdGF0ZW1lbnRzOiBzdHJpbmdbXSxcclxuICAgICAgICBjYWxsYmFjaz86IChlcnJvcjogc3RyaW5nKSA9PiB2b2lkKSB7XHJcblxyXG4gICAgICAgIC8vIGNvbm5lY3Rpb24gYWxyZWFkeSBjbG9zZWQ/XHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2UgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2soXCJLZWluZSBEYXRlbmJhbmt2ZXJiaW5kdW5nLlwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGN1cnJlbnREQlZlcnNpb24gPSB0aGlzLmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzLmxlbmd0aDtcclxuICAgICAgICBsZXQgZGVsdGEgPSBjdXJyZW50REJWZXJzaW9uIC0gZmlyc3RTdGF0ZW1lbnRJbmRleCArIDE7IC8vIHRoZXNlIHN0YXRlbWVudHMgYXJlIGFscmVhZHkgdGhlcmVcclxuICAgICAgICBpZiAoZGVsdGEgPj0gc3RhdGVtZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzLnNsaWNlKGRlbHRhKTtcclxuICAgICAgICB0aGlzLmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzID0gdGhpcy5kYXRhYmFzZURhdGEuc3RhdGVtZW50cy5jb25jYXQoc3RhdGVtZW50cyk7XHJcblxyXG4gICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY3V0ZVdyaXRlUXVlcmllcyhzdGF0ZW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSBjYWxsYmFjayhudWxsKTtcclxuICAgICAgICB9LCAoZXJyb3JNZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSBjYWxsYmFjayhlcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgZXhlY3V0ZVdyaXRlU3RhdGVtZW50KHF1ZXJ5OiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyb3I6IHN0cmluZywgbGFzdFJvd0lkOiBudW1iZXIpID0+IHZvaWQsIHJldHJpZXZlTGFzdFJvd0lkOiBib29sZWFuID0gZmFsc2UpIHtcclxuXHJcbiAgICAgICAgLy8gY29ubmVjdGlvbiBhbHJlYWR5IGNsb3NlZD9cclxuICAgICAgICBpZiAodGhpcy5kYXRhYmFzZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKFwiRXMgYmVzdGVodCBrZWluZSBWZXJiaW5kdW5nIHp1ciBEYXRlbmJhbmsuXCIsIDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGxldCBvbGRTdGF0ZW1lbnRJbmRleCA9IHRoYXQuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMubGVuZ3RoO1xyXG4gICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY3V0ZVF1ZXJ5KFwiZXhwbGFpbiBcIiArIHF1ZXJ5LCAoKSA9PiB7XHJcblxyXG4gICAgICAgICAgICB0aGF0LnNraXBOZXh0U2VydmVyU2VudFN0YXRlbWVudCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoYXQubWFpbi5uZXR3b3JrTWFuYWdlci5hZGREYXRhYmFzZVN0YXRlbWVudCh0aGF0LnRva2VuLCBvbGRTdGF0ZW1lbnRJbmRleCxcclxuICAgICAgICAgICAgICAgIFtxdWVyeV0sIChzdGF0ZW1lbnRzQmVmb3JlLCBuZXdfdmVyc2lvbiwgZXJyb3JNZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yTWVzc2FnZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9yTWVzc2FnZSwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQuZXhlY3V0ZVN0YXRlbWVudHNGcm9tU2VydmVyKG9sZFN0YXRlbWVudEluZGV4ICsgMSwgc3RhdGVtZW50c0JlZm9yZSwgKGVycm9yOiBzdHJpbmcpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZGF0YWJhc2UuZXhlY3V0ZVdyaXRlUXVlcmllcyhbcXVlcnldLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzLnB1c2gocXVlcnkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXRyaWV2ZUxhc3RSb3dJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZXhlY3V0ZVF1ZXJ5KFwic2VsZWN0IGxhc3RfaW5zZXJ0X3Jvd2lkKClcIiwgKGVycm9yLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YS52YWx1ZXNbMF1bMF0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yTWVzc2FnZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5kYXRhYmFzZURhdGEuc3RhdGVtZW50cy5wdXNoKHF1ZXJ5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSBjYWxsYmFjayhlcnJvck1lc3NhZ2UsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHJvbGxiYWNrIHNvIHRoYXQgc2VydmVyIGRvZXNuJ3Qgc3RvcmUgdGhpcyBzdGF0ZW1lbnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQubWFpbi5uZXR3b3JrTWFuYWdlci5yb2xsYmFja0RhdGFiYXNlU3RhdGVtZW50KHRoYXQudG9rZW4sIHRoYXQuZGF0YWJhc2VEYXRhLnN0YXRlbWVudHMubGVuZ3RoLCAoKSA9PiB7fSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICB9LCAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgY2FsbGJhY2soZXJyb3IsIDApO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGVRdWVyeShxdWVyeTogc3RyaW5nLCBjYWxsYmFjazogKGVycm9yOiBzdHJpbmcsIGRhdGE6IFF1ZXJ5UmVzdWx0KSA9PiB2b2lkKSB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRhdGFiYXNlID09IG51bGwgfHwgdGhpcy5sb25nUG9sbGluZ0xpc3RlbmVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soXCJFcyBiZXN0ZWh0IGtlaW5lIFZlcmJpbmR1bmcgenVyIERhdGVuYmFuay5cIiwgbnVsbCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY3V0ZVF1ZXJ5KHF1ZXJ5LCAocmVzdWx0czogUXVlcnlSZXN1bHRbXSkgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLHJlc3VsdHMubGVuZ3RoID09IDAgPyB7Y29sdW1uczogW10sIHZhbHVlczogW119IDogcmVzdWx0c1swXSk7XHJcbiAgICAgICAgfSwgKGVycm9yOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==