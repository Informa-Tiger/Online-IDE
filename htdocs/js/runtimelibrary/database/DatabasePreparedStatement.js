import { Klass } from "../../compiler/types/Class.js";
import { booleanPrimitiveType, doublePrimitiveType, floatPrimitiveType, intPrimitiveType, stringPrimitiveType, voidPrimitiveType } from "../../compiler/types/PrimitiveTypes.js";
import { Method, Parameterlist } from "../../compiler/types/Types.js";
import { RuntimeObject } from "../../interpreter/RuntimeObject.js";
import { ResultsetHelper } from "./ResultSet.js";
export class DatabasePreparedStatementClass extends Klass {
    constructor(module) {
        super("PreparedStatement", module, "Ein PreparedStatement-Objekt repräsentiert eine parametrisierte Anweisung an die Datenbank.");
        let resultSetType = module.typeStore.getType("ResultSet");
        this.setBaseClass(module.typeStore.getType("Object"));
        this.addMethod(new Method("executeQuery", new Parameterlist([]), resultSetType, (parameters) => {
            let o = parameters[0].value;
            let query = parameters[1].value;
            let psh = o.intrinsicData["Helper"];
            let interpreter = module.main.getInterpreter();
            if (!psh.query.toLocaleLowerCase().startsWith("select")) {
                module.main.getInterpreter().resumeAfterInput(null);
                interpreter.throwException("Mit der Methode executeQuery können nur select-Anweisungen ausgeführt werden. Benutze für datenverändernde Anweisungen die Methode executeUpdate.");
                return null;
            }
            interpreter.pauseForInput();
            module.main.getBottomDiv().showHideDbBusyIcon(true);
            let error = psh.checkQuery();
            if (error != null) {
                interpreter.throwException(error);
                return null;
            }
            psh.connectionHelper.executeQuery(psh.getQueryWithParameterValuesFilledIn(), (error, result) => {
                module.main.getBottomDiv().showHideDbBusyIcon(false);
                if (error != null) {
                    module.main.getInterpreter().resumeAfterInput(null);
                    interpreter.throwException(error);
                    return;
                }
                let rsh = new ResultsetHelper(result);
                let rs = new RuntimeObject(resultSetType);
                rs.intrinsicData["Helper"] = rsh;
                interpreter.resumeAfterInput({ value: rs, type: resultSetType }, true);
            });
        }, false, false, 'Führt ein SQL-Statement aus, das eine select-Anweisung enthält.', false));
        this.addMethod(new Method("executeUpdate", new Parameterlist([]), intPrimitiveType, (parameters) => {
            let o = parameters[0].value;
            let psh = o.intrinsicData["Helper"];
            let interpreter = module.main.getInterpreter();
            if (psh.query.toLocaleLowerCase().startsWith("select")) {
                module.main.getInterpreter().resumeAfterInput(null);
                interpreter.throwException("Mit der Methode execute können nur datenverändernde Anweisungen ausgeführt werden." +
                    "Benutze für select-Anweisungen die Methode executeQuery.");
                return null;
            }
            interpreter.pauseForInput();
            module.main.getBottomDiv().showHideDbBusyIcon(true);
            let error = psh.checkQuery();
            if (error != null) {
                interpreter.resumeAfterInput(null);
                interpreter.throwException(error);
                return null;
            }
            psh.connectionHelper.executeWriteStatement(psh.getQueryWithParameterValuesFilledIn(), (error) => {
                module.main.getBottomDiv().showHideDbBusyIcon(false);
                if (error != null) {
                    module.main.getInterpreter().resumeAfterInput(null);
                    interpreter.resumeAfterInput(null);
                    interpreter.throwException(error);
                    return;
                }
                interpreter.resumeAfterInput({ value: 0, type: intPrimitiveType }, true);
            });
        }, false, false, 'Führt ein SQL-Statement aus, das eine datenverändernde Anweisung enthält.', false));
        let types = [booleanPrimitiveType, intPrimitiveType, floatPrimitiveType, doublePrimitiveType, stringPrimitiveType];
        for (let type of types) {
            let typeIdFirstUppercase = type.identifier.charAt(0).toUpperCase() + type.identifier.substring(1);
            this.addMethod(new Method("set" + typeIdFirstUppercase, new Parameterlist([
                { identifier: "parameterIndex", type: intPrimitiveType, declaration: null, usagePositions: null, isFinal: true },
                { identifier: "value", type: type, declaration: null, usagePositions: null, isFinal: true }
            ]), voidPrimitiveType, (parameters) => {
                let o = parameters[0].value;
                let index = parameters[1].value;
                let value = parameters[2].value;
                let psh = o.intrinsicData["Helper"];
                let error = psh.setValue(value, index);
                if (error != null) {
                    module.main.getInterpreter().resumeAfterInput(null);
                    module.main.getInterpreter().throwException(error);
                }
                return;
            }, false, false, 'Setzt im Parameter mit dem angegebenen Index den ' + type.identifier + '-Wert ein.'));
        }
    }
}
export class PreparedStatementHelper {
    constructor(connectionHelper, query) {
        this.connectionHelper = connectionHelper;
        this.query = query.trim();
        this.prepareStatement(this.query);
    }
    prepareStatement(sql) {
        let insideQuotation = false;
        this.parameterPositions = [];
        for (let i = 0; i < sql.length; i++) {
            let c = sql.charAt(i);
            switch (c) {
                case "'":
                    insideQuotation = !insideQuotation;
                    break;
                case "?":
                    if (!insideQuotation) {
                        this.parameterPositions.push(i);
                    }
                    break;
                default:
                    break;
            }
        }
        this.parameterValues = new Array(this.parameterPositions.length);
    }
    setValue(value, position) {
        if (position < 1 || position > this.parameterPositions.length) {
            if (this.parameterPositions.length == 0) {
                return "Es gibt keine Parameter (mit ? besetzte Stellen) in dieser Anweisung.";
            }
            return "Es gibt nur die Parameterpositionen 1 bis " + this.parameterPositions.length + " in der SQL-Anweisung, keine Position " + position + ".";
        }
        if (value == null) {
            this.parameterValues[position - 1] = "null";
        }
        else if (typeof value == "string") {
            value = value.replace(/'/g, "''");
            this.parameterValues[position - 1] = "'" + value + "'";
        }
        else {
            this.parameterValues[position - 1] = "" + value;
        }
        return;
    }
    checkQuery() {
        return null;
    }
    getQueryWithParameterValuesFilledIn() {
        let query = this.query;
        let queryParts = [];
        let pos = 0;
        for (let i = 0; i < this.parameterPositions.length; i++) {
            queryParts.push(query.substring(pos, this.parameterPositions[i]));
            pos = this.parameterPositions[i] + 1;
        }
        if (pos < query.length) {
            queryParts.push(query.substring(pos));
        }
        let queryWithParameterValues = "";
        for (let i = 0; i < this.parameterPositions.length; i++) {
            queryWithParameterValues += queryParts[i] + this.parameterValues[i];
        }
        if (queryParts.length > this.parameterPositions.length) {
            queryWithParameterValues += queryParts[queryParts.length - 1];
        }
        return queryWithParameterValues;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YWJhc2VQcmVwYXJlZFN0YXRlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvcnVudGltZWxpYnJhcnkvZGF0YWJhc2UvRGF0YWJhc2VQcmVwYXJlZFN0YXRlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDakwsT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR2pELE1BQU0sT0FBTyw4QkFBK0IsU0FBUSxLQUFLO0lBRXJELFlBQVksTUFBYztRQUN0QixLQUFLLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLDZGQUE2RixDQUFDLENBQUM7UUFHbEksSUFBSSxhQUFhLEdBQVUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLFlBQVksQ0FBUSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsY0FBYyxFQUFFLElBQUksYUFBYSxDQUFDLEVBQzNELENBQUMsRUFBRSxhQUFhLEVBQ2IsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUVYLElBQUksQ0FBQyxHQUFrQixVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQzNDLElBQUksS0FBSyxHQUFX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QUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckQsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLEdBQUcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3hDO1FBRUQsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNwQixVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUN6QztRQUVELElBQUksd0JBQXdCLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3JELHdCQUF3QixJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7WUFDcEQsd0JBQXdCLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDakU7UUFFRCxPQUFPLHdCQUF3QixDQUFDO0lBQ3BDLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSB9IGZyb20gXCIuLi8uLi9jb21waWxlci9wYXJzZXIvTW9kdWxlLmpzXCI7XHJcbmltcG9ydCB7IEtsYXNzIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IGJvb2xlYW5QcmltaXRpdmVUeXBlLCBkb3VibGVQcmltaXRpdmVUeXBlLCBmbG9hdFByaW1pdGl2ZVR5cGUsIGludFByaW1pdGl2ZVR5cGUsIHN0cmluZ1ByaW1pdGl2ZVR5cGUsIHZvaWRQcmltaXRpdmVUeXBlIH0gZnJvbSBcIi4uLy4uL2NvbXBpbGVyL3R5cGVzL1ByaW1pdGl2ZVR5cGVzLmpzXCI7XHJcbmltcG9ydCB7IE1ldGhvZCwgUGFyYW1ldGVybGlzdCB9IGZyb20gXCIuLi8uLi9jb21waWxlci90eXBlcy9UeXBlcy5qc1wiO1xyXG5pbXBvcnQgeyBSdW50aW1lT2JqZWN0IH0gZnJvbSBcIi4uLy4uL2ludGVycHJldGVyL1J1bnRpbWVPYmplY3QuanNcIjtcclxuaW1wb3J0IHsgQ29ubmVjdGlvbkhlbHBlciB9IGZyb20gXCIuL0Nvbm5lY3Rpb24uanNcIjtcclxuaW1wb3J0IHsgUmVzdWx0c2V0SGVscGVyIH0gZnJvbSBcIi4vUmVzdWx0U2V0LmpzXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFiYXNlUHJlcGFyZWRTdGF0ZW1lbnRDbGFzcyBleHRlbmRzIEtsYXNzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2R1bGU6IE1vZHVsZSkge1xyXG4gICAgICAgIHN1cGVyKFwiUHJlcGFyZWRTdGF0ZW1lbnRcIiwgbW9kdWxlLCBcIkVpbiBQcmVwYXJlZFN0YXRlbWVudC1PYmpla3QgcmVwcsOkc2VudGllcnQgZWluZSBwYXJhbWV0cmlzaWVydGUgQW53ZWlzdW5nIGFuIGRpZSBEYXRlbmJhbmsuXCIpO1xyXG5cclxuXHJcbiAgICAgICAgbGV0IHJlc3VsdFNldFR5cGUgPSA8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiUmVzdWx0U2V0XCIpO1xyXG5cclxuICAgICAgICB0aGlzLnNldEJhc2VDbGFzcyg8S2xhc3M+bW9kdWxlLnR5cGVTdG9yZS5nZXRUeXBlKFwiT2JqZWN0XCIpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImV4ZWN1dGVRdWVyeVwiLCBuZXcgUGFyYW1ldGVybGlzdChbXHJcbiAgICAgICAgXSksIHJlc3VsdFNldFR5cGUsXHJcbiAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG86IFJ1bnRpbWVPYmplY3QgPSBwYXJhbWV0ZXJzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IHF1ZXJ5OiBzdHJpbmcgPSBwYXJhbWV0ZXJzWzFdLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwc2g6IFByZXBhcmVkU3RhdGVtZW50SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBpbnRlcnByZXRlciA9IG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXBzaC5xdWVyeS50b0xvY2FsZUxvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJzZWxlY3RcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJlc3VtZUFmdGVySW5wdXQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJNaXQgZGVyIE1ldGhvZGUgZXhlY3V0ZVF1ZXJ5IGvDtm5uZW4gbnVyIHNlbGVjdC1BbndlaXN1bmdlbiBhdXNnZWbDvGhydCB3ZXJkZW4uIEJlbnV0emUgZsO8ciBkYXRlbnZlcsOkbmRlcm5kZSBBbndlaXN1bmdlbiBkaWUgTWV0aG9kZSBleGVjdXRlVXBkYXRlLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpbnRlcnByZXRlci5wYXVzZUZvcklucHV0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbW9kdWxlLm1haW4uZ2V0Qm90dG9tRGl2KCkuc2hvd0hpZGVEYkJ1c3lJY29uKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBlcnJvciA9IHBzaC5jaGVja1F1ZXJ5KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci50aHJvd0V4Y2VwdGlvbihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIHBzaC5jb25uZWN0aW9uSGVscGVyLmV4ZWN1dGVRdWVyeShwc2guZ2V0UXVlcnlXaXRoUGFyYW1ldGVyVmFsdWVzRmlsbGVkSW4oKSwgKGVycm9yLCByZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRCb3R0b21EaXYoKS5zaG93SGlkZURiQnVzeUljb24oZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCkucmVzdW1lQWZ0ZXJJbnB1dChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCByc2ggPSBuZXcgUmVzdWx0c2V0SGVscGVyKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJzID0gbmV3IFJ1bnRpbWVPYmplY3QocmVzdWx0U2V0VHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcnMuaW50cmluc2ljRGF0YVtcIkhlbHBlclwiXSA9IHJzaDtcclxuICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci5yZXN1bWVBZnRlcklucHV0KHsgdmFsdWU6IHJzLCB0eXBlOiByZXN1bHRTZXRUeXBlIH0sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ0bDvGhydCBlaW4gU1FMLVN0YXRlbWVudCBhdXMsIGRhcyBlaW5lIHNlbGVjdC1BbndlaXN1bmcgZW50aMOkbHQuJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGRNZXRob2QobmV3IE1ldGhvZChcImV4ZWN1dGVVcGRhdGVcIiwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgIF0pLCBpbnRQcmltaXRpdmVUeXBlLFxyXG4gICAgICAgICAgICAocGFyYW1ldGVycykgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcHNoOiBQcmVwYXJlZFN0YXRlbWVudEhlbHBlciA9IG8uaW50cmluc2ljRGF0YVtcIkhlbHBlclwiXTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXIgPSBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBzaC5xdWVyeS50b0xvY2FsZUxvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJzZWxlY3RcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJlc3VtZUFmdGVySW5wdXQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJNaXQgZGVyIE1ldGhvZGUgZXhlY3V0ZSBrw7ZubmVuIG51ciBkYXRlbnZlcsOkbmRlcm5kZSBBbndlaXN1bmdlbiBhdXNnZWbDvGhydCB3ZXJkZW4uXCIgKyBcclxuICAgICAgICAgICAgICAgICAgICBcIkJlbnV0emUgZsO8ciBzZWxlY3QtQW53ZWlzdW5nZW4gZGllIE1ldGhvZGUgZXhlY3V0ZVF1ZXJ5LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpbnRlcnByZXRlci5wYXVzZUZvcklucHV0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbW9kdWxlLm1haW4uZ2V0Qm90dG9tRGl2KCkuc2hvd0hpZGVEYkJ1c3lJY29uKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBlcnJvciA9IHBzaC5jaGVja1F1ZXJ5KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlci5yZXN1bWVBZnRlcklucHV0KG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyLnRocm93RXhjZXB0aW9uKGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcHNoLmNvbm5lY3Rpb25IZWxwZXIuZXhlY3V0ZVdyaXRlU3RhdGVtZW50KHBzaC5nZXRRdWVyeVdpdGhQYXJhbWV0ZXJWYWx1ZXNGaWxsZWRJbigpLCAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRCb3R0b21EaXYoKS5zaG93SGlkZURiQnVzeUljb24oZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCkucmVzdW1lQWZ0ZXJJbnB1dChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIucmVzdW1lQWZ0ZXJJbnB1dChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyLnJlc3VtZUFmdGVySW5wdXQoeyB2YWx1ZTogMCwgdHlwZTogaW50UHJpbWl0aXZlVHlwZSB9LCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICB9LCBmYWxzZSwgZmFsc2UsICdGw7xocnQgZWluIFNRTC1TdGF0ZW1lbnQgYXVzLCBkYXMgZWluZSBkYXRlbnZlcsOkbmRlcm5kZSBBbndlaXN1bmcgZW50aMOkbHQuJyxcclxuICAgICAgICAgICAgZmFsc2UpKTtcclxuXHJcbiAgICAgICAgbGV0IHR5cGVzID0gW2Jvb2xlYW5QcmltaXRpdmVUeXBlLCBpbnRQcmltaXRpdmVUeXBlLCBmbG9hdFByaW1pdGl2ZVR5cGUsIGRvdWJsZVByaW1pdGl2ZVR5cGUsIHN0cmluZ1ByaW1pdGl2ZVR5cGVdO1xyXG5cclxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHR5cGVzKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgdHlwZUlkRmlyc3RVcHBlcmNhc2UgPSB0eXBlLmlkZW50aWZpZXIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0eXBlLmlkZW50aWZpZXIuc3Vic3RyaW5nKDEpO1xyXG5cclxuXHJcbiAgICAgICAgICAgIHRoaXMuYWRkTWV0aG9kKG5ldyBNZXRob2QoXCJzZXRcIit0eXBlSWRGaXJzdFVwcGVyY2FzZSwgbmV3IFBhcmFtZXRlcmxpc3QoW1xyXG4gICAgICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInBhcmFtZXRlckluZGV4XCIsIHR5cGU6IGludFByaW1pdGl2ZVR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9LFxyXG4gICAgICAgICAgICAgICAgeyBpZGVudGlmaWVyOiBcInZhbHVlXCIsIHR5cGU6IHR5cGUsIGRlY2xhcmF0aW9uOiBudWxsLCB1c2FnZVBvc2l0aW9uczogbnVsbCwgaXNGaW5hbDogdHJ1ZSB9XHJcbiAgICAgICAgICAgIF0pLCB2b2lkUHJpbWl0aXZlVHlwZSxcclxuICAgICAgICAgICAgICAgIChwYXJhbWV0ZXJzKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBvOiBSdW50aW1lT2JqZWN0ID0gcGFyYW1ldGVyc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXg6IG51bWJlciA9IHBhcmFtZXRlcnNbMV0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbHVlOiBhbnkgPSBwYXJhbWV0ZXJzWzJdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBwc2g6IFByZXBhcmVkU3RhdGVtZW50SGVscGVyID0gby5pbnRyaW5zaWNEYXRhW1wiSGVscGVyXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgZXJyb3IgPSBwc2guc2V0VmFsdWUodmFsdWUsIGluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUubWFpbi5nZXRJbnRlcnByZXRlcigpLnJlc3VtZUFmdGVySW5wdXQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZS5tYWluLmdldEludGVycHJldGVyKCkudGhyb3dFeGNlcHRpb24oZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgICAgIH0sIGZhbHNlLCBmYWxzZSwgJ1NldHp0IGltIFBhcmFtZXRlciBtaXQgZGVtIGFuZ2VnZWJlbmVuIEluZGV4IGRlbiAnICsgdHlwZS5pZGVudGlmaWVyICsgJy1XZXJ0IGVpbi4nKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBQcmVwYXJlZFN0YXRlbWVudEhlbHBlciB7XHJcblxyXG4gICAgcGFyYW1ldGVyVmFsdWVzOiBzdHJpbmdbXTtcclxuICAgIHBhcmFtZXRlclBvc2l0aW9uczogbnVtYmVyW107XHJcbiAgICBxdWVyeTogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBjb25uZWN0aW9uSGVscGVyOiBDb25uZWN0aW9uSGVscGVyLCBxdWVyeTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5LnRyaW0oKTtcclxuICAgICAgICB0aGlzLnByZXBhcmVTdGF0ZW1lbnQodGhpcy5xdWVyeSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJlcGFyZVN0YXRlbWVudChzcWw6IHN0cmluZykge1xyXG5cclxuICAgICAgICBsZXQgaW5zaWRlUXVvdGF0aW9uOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnMgPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcWwubGVuZ3RoOyBpKyspIHtcclxuXHJcbiAgICAgICAgICAgIGxldCBjID0gc3FsLmNoYXJBdChpKTtcclxuICAgICAgICAgICAgc3dpdGNoIChjKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiJ1wiOiBpbnNpZGVRdW90YXRpb24gPSAhaW5zaWRlUXVvdGF0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIj9cIjogaWYgKCFpbnNpZGVRdW90YXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmFtZXRlclBvc2l0aW9ucy5wdXNoKGkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJWYWx1ZXMgPSBuZXcgQXJyYXkodGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnMubGVuZ3RoKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2V0VmFsdWUodmFsdWU6IGFueSwgcG9zaXRpb246IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHBvc2l0aW9uIDwgMSB8fCBwb3NpdGlvbiA+IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnMubGVuZ3RoID09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcIkVzIGdpYnQga2VpbmUgUGFyYW1ldGVyIChtaXQgPyBiZXNldHp0ZSBTdGVsbGVuKSBpbiBkaWVzZXIgQW53ZWlzdW5nLlwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBcIkVzIGdpYnQgbnVyIGRpZSBQYXJhbWV0ZXJwb3NpdGlvbmVuIDEgYmlzIFwiICsgdGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnMubGVuZ3RoICsgXCIgaW4gZGVyIFNRTC1BbndlaXN1bmcsIGtlaW5lIFBvc2l0aW9uIFwiICsgcG9zaXRpb24gKyBcIi5cIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHZhbHVlID09IG51bGwpe1xyXG4gICAgICAgICAgICB0aGlzLnBhcmFtZXRlclZhbHVlc1twb3NpdGlvbiAtIDFdID0gXCJudWxsXCI7XHJcbiAgICAgICAgfSBlbHNlXHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvJy9nLCBcIicnXCIpO1xyXG4gICAgICAgICAgICB0aGlzLnBhcmFtZXRlclZhbHVlc1twb3NpdGlvbiAtIDFdID0gXCInXCIgKyB2YWx1ZSArIFwiJ1wiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVyVmFsdWVzW3Bvc2l0aW9uIC0gMV0gPSBcIlwiICsgdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjaGVja1F1ZXJ5KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UXVlcnlXaXRoUGFyYW1ldGVyVmFsdWVzRmlsbGVkSW4oKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgcXVlcnkgPSB0aGlzLnF1ZXJ5O1xyXG4gICAgICAgIGxldCBxdWVyeVBhcnRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIGxldCBwb3MgPSAwO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHF1ZXJ5UGFydHMucHVzaChxdWVyeS5zdWJzdHJpbmcocG9zLCB0aGlzLnBhcmFtZXRlclBvc2l0aW9uc1tpXSkpO1xyXG4gICAgICAgICAgICBwb3MgPSB0aGlzLnBhcmFtZXRlclBvc2l0aW9uc1tpXSArIDE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocG9zIDwgcXVlcnkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHF1ZXJ5UGFydHMucHVzaChxdWVyeS5zdWJzdHJpbmcocG9zKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcXVlcnlXaXRoUGFyYW1ldGVyVmFsdWVzID0gXCJcIjtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHF1ZXJ5V2l0aFBhcmFtZXRlclZhbHVlcyArPSBxdWVyeVBhcnRzW2ldICsgdGhpcy5wYXJhbWV0ZXJWYWx1ZXNbaV07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocXVlcnlQYXJ0cy5sZW5ndGggPiB0aGlzLnBhcmFtZXRlclBvc2l0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcXVlcnlXaXRoUGFyYW1ldGVyVmFsdWVzICs9IHF1ZXJ5UGFydHNbcXVlcnlQYXJ0cy5sZW5ndGggLSAxXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBxdWVyeVdpdGhQYXJhbWV0ZXJWYWx1ZXM7XHJcbiAgICB9XHJcblxyXG59Il19