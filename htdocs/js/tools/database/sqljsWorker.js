importScripts('../../../lib/sql.js/sql-wasm.js', 'sqljsWorkerTools.js');
//@ts-ignore
var initsql = initSqlJs({
    locateFile: name => (self.location + "").replace("js/tools/database/sqljsWorker.js", "") + 'lib/sql.js/' + name
});
var db;
var SQL;
function worker(event) {
    var buff;
    var result;
    var data = event.data;
    var config = data["config"] ? data["config"] : {};
    try {
        switch (data && data["action"]) {
            case "open":
                buff = data["buffer"];
                createDb(SQL, buff && new Uint8Array(buff));
                //@ts-ignore
                return postMessage({
                    id: data["id"],
                    ready: true
                });
            case "exec":
                if (db === null) {
                    createDb(SQL, undefined);
                }
                if (!data["sql"]) {
                    throw "exec: Missing query string";
                }
                //@ts-ignore
                return postMessage({
                    id: data["id"],
                    results: db.exec(data["sql"], data["params"], config)
                });
            case "each":
                if (db === null) {
                    createDb(SQL, undefined);
                }
                var callback = function callback(row) {
                    //@ts-ignore
                    return postMessage({
                        id: data["id"],
                        row: row,
                        finished: false
                    });
                };
                var done = function done() {
                    //@ts-ignore
                    return postMessage({
                        id: data["id"],
                        finished: true
                    });
                };
                return db.each(data["sql"], data["params"], callback, done, config);
            case "export":
                buff = db["export"]();
                result = {
                    id: data["id"],
                    results: [
                        {
                            buffer: buff
                        }
                    ]
                };
                try {
                    //@ts-ignore
                    return postMessage(result);
                }
                catch (error) {
                    //@ts-ignore
                    return postMessage(result);
                }
            case "close":
                if (db) {
                    db.close();
                }
                //@ts-ignore
                return postMessage({
                    id: data["id"]
                });
            default:
                throw new Error("Invalid action : " + (data && data["action"]));
        }
    }
    catch (err) {
        //@ts-ignore
        return postMessage({
            id: data["id"],
            error: err["message"]
        });
    }
}
self.onmessage = (event) => {
    if (db == null) {
        initsql.then((SQL1) => {
            SQL = SQL1;
            db = createDb(SQL1, undefined);
            worker(event);
        }).catch((err) => {
            console.log(err);
            //@ts-ignore
            return postMessage({
                id: this["data"]["id"],
                error: err["message"]
            });
        });
    }
    else {
        worker(event);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsanNXb3JrZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L3Rvb2xzL2RhdGFiYXNlL3NxbGpzV29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGFBQWEsQ0FBQyxpQ0FBaUMsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO0FBRXhFLFlBQVk7QUFDWixJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUM7SUFDcEIsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQ0FBa0MsRUFBRSxFQUFFLENBQUMsR0FBRyxhQUFhLEdBQUcsSUFBSTtDQUMvRyxDQUFDLENBQUM7QUFDTixJQUFJLEVBQUUsQ0FBQztBQUNQLElBQUksR0FBRyxDQUFDO0FBRVIsU0FBUyxNQUFNLENBQUMsS0FBSztJQUNqQixJQUFJLElBQUksQ0FBQztJQUFDLElBQUksTUFBTSxDQUFDO0lBQ3JCLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDdEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNsRCxJQUFJO1FBQ0EsUUFBUSxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzVCLEtBQUssTUFBTTtnQkFDUCxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN0QixRQUFRLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUM1QyxZQUFZO2dCQUNaLE9BQU8sV0FBVyxDQUFDO29CQUNmLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUNkLEtBQUssRUFBRSxJQUFJO2lCQUNk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RyxRQUFRLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsWUFBWTtZQUNaLE9BQU8sV0FBVyxDQUFDO2dCQUNmLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUN0QixLQUFLLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQzthQUN4QixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQTtLQUNMO1NBQU07UUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDakI7QUFDTCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnRTY3JpcHRzKCcuLi8uLi8uLi9saWIvc3FsLmpzL3NxbC13YXNtLmpzJywgJ3NxbGpzV29ya2VyVG9vbHMuanMnKTtcclxuXHJcbi8vQHRzLWlnbm9yZVxyXG52YXIgaW5pdHNxbCA9IGluaXRTcWxKcyh7XHJcbiAgICBsb2NhdGVGaWxlOiBuYW1lID0+IChzZWxmLmxvY2F0aW9uICsgXCJcIikucmVwbGFjZShcImpzL3Rvb2xzL2RhdGFiYXNlL3NxbGpzV29ya2VyLmpzXCIsIFwiXCIpICsgJ2xpYi9zcWwuanMvJyArIG5hbWVcclxuICAgfSk7XHJcbnZhciBkYjtcclxudmFyIFNRTDtcclxuXHJcbmZ1bmN0aW9uIHdvcmtlcihldmVudCkge1xyXG4gICAgdmFyIGJ1ZmY7IHZhciByZXN1bHQ7XHJcbiAgICB2YXIgZGF0YSA9IGV2ZW50LmRhdGE7XHJcbiAgICB2YXIgY29uZmlnID0gZGF0YVtcImNvbmZpZ1wiXSA/IGRhdGFbXCJjb25maWdcIl0gOiB7fTtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgc3dpdGNoIChkYXRhICYmIGRhdGFbXCJhY3Rpb25cIl0pIHtcclxuICAgICAgICAgICAgY2FzZSBcIm9wZW5cIjpcclxuICAgICAgICAgICAgICAgIGJ1ZmYgPSBkYXRhW1wiYnVmZmVyXCJdO1xyXG4gICAgICAgICAgICAgICAgY3JlYXRlRGIoU1FMLCBidWZmICYmIG5ldyBVaW50OEFycmF5KGJ1ZmYpKTtcclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBvc3RNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogZGF0YVtcImlkXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlYWR5OiB0cnVlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY2FzZSBcImV4ZWNcIjpcclxuICAgICAgICAgICAgICAgIGlmIChkYiA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZURiKFNRTCwgdW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghZGF0YVtcInNxbFwiXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IFwiZXhlYzogTWlzc2luZyBxdWVyeSBzdHJpbmdcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBvc3RNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogZGF0YVtcImlkXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHM6IGRiLmV4ZWMoZGF0YVtcInNxbFwiXSwgZGF0YVtcInBhcmFtc1wiXSwgY29uZmlnKVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNhc2UgXCJlYWNoXCI6XHJcbiAgICAgICAgICAgICAgICBpZiAoZGIgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVEYihTUUwsIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbiBjYWxsYmFjayhyb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zdE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogZGF0YVtcImlkXCJdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByb3c6IHJvdyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmluaXNoZWQ6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdmFyIGRvbmUgPSBmdW5jdGlvbiBkb25lKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwb3N0TWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkYXRhW1wiaWRcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRiLmVhY2goZGF0YVtcInNxbFwiXSwgZGF0YVtcInBhcmFtc1wiXSwgY2FsbGJhY2ssIGRvbmUsIGNvbmZpZyk7XHJcbiAgICAgICAgICAgIGNhc2UgXCJleHBvcnRcIjpcclxuICAgICAgICAgICAgICAgIGJ1ZmYgPSBkYltcImV4cG9ydFwiXSgpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiBkYXRhW1wiaWRcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0czogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXI6IGJ1ZmZcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwb3N0TWVzc2FnZShyZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9zdE1lc3NhZ2UocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBcImNsb3NlXCI6XHJcbiAgICAgICAgICAgICAgICBpZiAoZGIpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcG9zdE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiBkYXRhW1wiaWRcIl1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBhY3Rpb24gOiBcIiArIChkYXRhICYmIGRhdGFbXCJhY3Rpb25cIl0pKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgcmV0dXJuIHBvc3RNZXNzYWdlKHtcclxuICAgICAgICAgICAgaWQ6IGRhdGFbXCJpZFwiXSxcclxuICAgICAgICAgICAgZXJyb3I6IGVycltcIm1lc3NhZ2VcIl1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcblxyXG5zZWxmLm9ubWVzc2FnZSA9IChldmVudCkgPT4ge1xyXG4gICAgaWYgKGRiID09IG51bGwpIHtcclxuICAgICAgICBpbml0c3FsLnRoZW4oKFNRTDEpID0+IHtcclxuICAgICAgICAgICAgU1FMID0gU1FMMTtcclxuICAgICAgICAgICAgZGIgPSBjcmVhdGVEYihTUUwxLCB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICB3b3JrZXIoZXZlbnQpO1xyXG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJldHVybiBwb3N0TWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICBpZDogdGhpc1tcImRhdGFcIl1bXCJpZFwiXSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiBlcnJbXCJtZXNzYWdlXCJdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHdvcmtlcihldmVudCk7XHJcbiAgICB9XHJcbn1cclxuIl19