export class DatabaseWebSocket {
    constructor(networkManager, connectionHelper, interpreter, onServerSentStatementsCallback) {
        this.networkManager = networkManager;
        this.connectionHelper = connectionHelper;
        this.interpreter = interpreter;
        this.onServerSentStatementsCallback = onServerSentStatementsCallback;
    }
    open(callback) {
        let url = this.networkManager.sqlIdeURL.replace("http", "ws") + "jwebsocket";
        this.connection = new WebSocket(url);
        this.connection.onerror = (error) => { this.onError(error); };
        this.connection.onclose = (event) => { this.onClose(event); };
        this.connection.onmessage = (event) => { this.onMessage(event); };
        this.connection.onopen = (event) => {
            let request = {
                command: 1,
                databaseVersion: this.connectionHelper.databaseData.statements.length,
                token: this.connectionHelper.token
            };
            this.callbackWhenOpen = callback;
            this.sendIntern(JSON.stringify(request));
        };
    }
    onError(error) {
        this.interpreter.throwException("Kommunikationsfehler beim WebSocket");
        this.isOpen = false;
        if (this.callbackWhenOpen) {
            this.callbackWhenOpen("Die Websocket-Datenbankverbindung kam nicht zustande.");
            this.callbackWhenOpen = null;
        }
    }
    onClose(event) {
        this.isOpen = false;
        if (this.callbackWhenOpen) {
            this.callbackWhenOpen("Die Websocket-Datenbankverbindung kam nicht zustande.");
            this.callbackWhenOpen = null;
        }
    }
    onMessage(event) {
        this.isOpen = true;
        if (this.callbackWhenOpen) {
            this.callbackWhenOpen(null);
            this.callbackWhenOpen = null;
        }
        let response = JSON.parse(event.data);
        if (response.command == undefined)
            return;
        switch (response.command) {
            case 2:
                if (this.onServerSentStatementsCallback != null) {
                    this.onServerSentStatementsCallback(response);
                }
                break;
            case 3: // disconnect message from server
                this.isOpen = false;
                break;
            case 4: // keepalive message from server
                break;
        }
    }
    close() {
        let message = {
            command: 4
        };
        this.sendIntern(JSON.stringify(message));
    }
    sendIntern(message) {
        try {
            this.connection.send(message);
        }
        catch (exception) {
            console.log(exception);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YWJhc2VXZWJTb2NrZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L3Rvb2xzL2RhdGFiYXNlL0RhdGFiYXNlV2ViU29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE1BQU0sT0FBTyxpQkFBaUI7SUFNMUIsWUFBb0IsY0FBOEIsRUFDdEMsZ0JBQWtDLEVBQVUsV0FBd0IsRUFDcEUsOEJBQXFGO1FBRjdFLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUN0QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDcEUsbUNBQThCLEdBQTlCLDhCQUE4QixDQUF1RDtJQUVqRyxDQUFDO0lBRUQsSUFBSSxDQUFDLFFBQWlDO1FBQ2xDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDO1FBQzdFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFckMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFZLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDcEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFpQixFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3pFLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxHQUFHLENBQUMsS0FBbUIsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUUvRSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQVksRUFBRSxFQUFFO1lBRXRDLElBQUksT0FBTyxHQUE2QjtnQkFDcEMsT0FBTyxFQUFFLENBQUM7Z0JBQ1YsZUFBZSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU07Z0JBQ3JFLEtBQUssRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSzthQUNyQyxDQUFBO1lBQ0QsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFFBQVEsQ0FBQztZQUNqQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUU3QyxDQUFDLENBQUE7SUFDTCxDQUFDO0lBR0QsT0FBTyxDQUFDLEtBQVk7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBQztZQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsdURBQXVELENBQUMsQ0FBQztZQUMvRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFpQjtRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBQztZQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsdURBQXVELENBQUMsQ0FBQztZQUMvRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFtQjtRQUN6QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBQztZQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztTQUNoQztRQUNELElBQUksUUFBUSxHQUF1QixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxRCxJQUFJLFFBQVEsQ0FBQyxPQUFPLElBQUksU0FBUztZQUFFLE9BQU87UUFFMUMsUUFBUSxRQUFRLENBQUMsT0FBTyxFQUFFO1lBQ3RCLEtBQUssQ0FBQztnQkFDRixJQUFHLElBQUksQ0FBQyw4QkFBOEIsSUFBSSxJQUFJLEVBQUM7b0JBQzNDLElBQUksQ0FBQyw4QkFBOEIsQ0FBcUMsUUFBUSxDQUFDLENBQUM7aUJBQ3JGO2dCQUNELE1BQU07WUFDVixLQUFLLENBQUMsRUFBRSxpQ0FBaUM7Z0JBQ3JDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixNQUFNO1lBQ1YsS0FBSyxDQUFDLEVBQUUsZ0NBQWdDO2dCQUNwQyxNQUFNO1NBQ2I7SUFDTCxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksT0FBTyxHQUFnQztZQUN2QyxPQUFPLEVBQUUsQ0FBQztTQUNiLENBQUM7UUFDRixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsVUFBVSxDQUFDLE9BQWU7UUFDdEIsSUFBSTtZQUNBLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2pDO1FBQUMsT0FBTyxTQUFTLEVBQUU7WUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpNZXNzYWdlRnJvbVNlcnZlciwgSldlYlNvY2tldE1lc3NhZ2VDb25uZWN0LCBKV2ViU29ja2V0TWVzc2FnZURpc2Nvbm5lY3QsIEpXZWJTb2NrZXRNZXNzYWdlRXhlY3V0ZVN0YXRlbWVudCwgU2VuZGluZ1N0YXRlbWVudHNNZXNzYWdlRnJvbVNlcnZlciwgV2ViU29ja2V0UmVxdWVzdENvbm5lY3QgfSBmcm9tIFwiLi4vLi4vY29tbXVuaWNhdGlvbi9EYXRhLmpzXCI7XHJcbmltcG9ydCB7IE5ldHdvcmtNYW5hZ2VyIH0gZnJvbSBcIi4uLy4uL2NvbW11bmljYXRpb24vTmV0d29ya01hbmFnZXIuanNcIjtcclxuaW1wb3J0IHsgSW50ZXJwcmV0ZXIgfSBmcm9tIFwiLi4vLi4vaW50ZXJwcmV0ZXIvSW50ZXJwcmV0ZXIuanNcIjtcclxuaW1wb3J0IHsgQ29ubmVjdGlvbkhlbHBlciB9IGZyb20gXCIuLi8uLi9ydW50aW1lbGlicmFyeS9kYXRhYmFzZS9Db25uZWN0aW9uLmpzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VXZWJTb2NrZXQge1xyXG5cclxuICAgIGNvbm5lY3Rpb246IFdlYlNvY2tldDtcclxuICAgIGlzT3BlbjogYm9vbGVhbjtcclxuICAgIGNhbGxiYWNrV2hlbk9wZW46IChlcnJvcjogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbmV0d29ya01hbmFnZXI6IE5ldHdvcmtNYW5hZ2VyLCBcclxuICAgICAgICBwcml2YXRlIGNvbm5lY3Rpb25IZWxwZXI6IENvbm5lY3Rpb25IZWxwZXIsIHByaXZhdGUgaW50ZXJwcmV0ZXI6IEludGVycHJldGVyLFxyXG4gICAgICAgIHByaXZhdGUgb25TZXJ2ZXJTZW50U3RhdGVtZW50c0NhbGxiYWNrOiAobWVzc2FnZTogU2VuZGluZ1N0YXRlbWVudHNNZXNzYWdlRnJvbVNlcnZlcikgPT4gdm9pZCkge1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBvcGVuKGNhbGxiYWNrOiAoZXJyb3I6IHN0cmluZykgPT4gdm9pZCkge1xyXG4gICAgICAgIGxldCB1cmwgPSB0aGlzLm5ldHdvcmtNYW5hZ2VyLnNxbElkZVVSTC5yZXBsYWNlKFwiaHR0cFwiLCBcIndzXCIpICsgXCJqd2Vic29ja2V0XCI7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uID0gbmV3IFdlYlNvY2tldCh1cmwpO1xyXG5cclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25lcnJvciA9IChlcnJvcjogRXZlbnQpID0+IHsgdGhpcy5vbkVycm9yKGVycm9yKTsgfVxyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbmNsb3NlID0gKGV2ZW50OiBDbG9zZUV2ZW50KSA9PiB7IHRoaXMub25DbG9zZShldmVudCk7IH1cclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25tZXNzYWdlID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+IHsgdGhpcy5vbk1lc3NhZ2UoZXZlbnQpOyB9XHJcblxyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbm9wZW4gPSAoZXZlbnQ6IEV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgcmVxdWVzdDogSldlYlNvY2tldE1lc3NhZ2VDb25uZWN0ID0ge1xyXG4gICAgICAgICAgICAgICAgY29tbWFuZDogMSxcclxuICAgICAgICAgICAgICAgIGRhdGFiYXNlVmVyc2lvbjogdGhpcy5jb25uZWN0aW9uSGVscGVyLmRhdGFiYXNlRGF0YS5zdGF0ZW1lbnRzLmxlbmd0aCxcclxuICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLmNvbm5lY3Rpb25IZWxwZXIudG9rZW5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrV2hlbk9wZW4gPSBjYWxsYmFjaztcclxuICAgICAgICAgICAgdGhpcy5zZW5kSW50ZXJuKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBvbkVycm9yKGVycm9yOiBFdmVudCkge1xyXG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXIudGhyb3dFeGNlcHRpb24oXCJLb21tdW5pa2F0aW9uc2ZlaGxlciBiZWltIFdlYlNvY2tldFwiKTtcclxuICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgIGlmKHRoaXMuY2FsbGJhY2tXaGVuT3Blbil7XHJcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tXaGVuT3BlbihcIkRpZSBXZWJzb2NrZXQtRGF0ZW5iYW5rdmVyYmluZHVuZyBrYW0gbmljaHQgenVzdGFuZGUuXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrV2hlbk9wZW4gPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvbkNsb3NlKGV2ZW50OiBDbG9zZUV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcclxuICAgICAgICBpZih0aGlzLmNhbGxiYWNrV2hlbk9wZW4pe1xyXG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrV2hlbk9wZW4oXCJEaWUgV2Vic29ja2V0LURhdGVuYmFua3ZlcmJpbmR1bmcga2FtIG5pY2h0IHp1c3RhbmRlLlwiKTtcclxuICAgICAgICAgICAgdGhpcy5jYWxsYmFja1doZW5PcGVuID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25NZXNzYWdlKGV2ZW50OiBNZXNzYWdlRXZlbnQpIHtcclxuICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7XHJcbiAgICAgICAgaWYodGhpcy5jYWxsYmFja1doZW5PcGVuKXtcclxuICAgICAgICAgICAgdGhpcy5jYWxsYmFja1doZW5PcGVuKG51bGwpO1xyXG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrV2hlbk9wZW4gPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmVzcG9uc2U6IEpNZXNzYWdlRnJvbVNlcnZlciA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLmNvbW1hbmQgPT0gdW5kZWZpbmVkKSByZXR1cm47XHJcblxyXG4gICAgICAgIHN3aXRjaCAocmVzcG9uc2UuY29tbWFuZCkge1xyXG4gICAgICAgICAgICBjYXNlIDI6IFxyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5vblNlcnZlclNlbnRTdGF0ZW1lbnRzQ2FsbGJhY2sgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblNlcnZlclNlbnRTdGF0ZW1lbnRzQ2FsbGJhY2soPFNlbmRpbmdTdGF0ZW1lbnRzTWVzc2FnZUZyb21TZXJ2ZXI+cmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgMzogLy8gZGlzY29ubmVjdCBtZXNzYWdlIGZyb20gc2VydmVyXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgNDogLy8ga2VlcGFsaXZlIG1lc3NhZ2UgZnJvbSBzZXJ2ZXJcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjbG9zZSgpe1xyXG4gICAgICAgIGxldCBtZXNzYWdlOiBKV2ViU29ja2V0TWVzc2FnZURpc2Nvbm5lY3QgPSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IDRcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuc2VuZEludGVybihKU09OLnN0cmluZ2lmeShtZXNzYWdlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VuZEludGVybihtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uc2VuZChtZXNzYWdlKTtcclxuICAgICAgICB9IGNhdGNoIChleGNlcHRpb24pIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXhjZXB0aW9uKTsgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufSJdfQ==