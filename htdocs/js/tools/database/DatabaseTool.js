import { WorkerSim } from "./sqljsWorkerSim.js";
export class DatabaseTool {
    constructor(main) {
        this.main = main;
        this.databaseDirectoryEntries = null;
        this.queryId = 0;
        this.querySuccessCallbacksMap = new Map();
        this.queryErrorCallbackMap = new Map();
    }
    initializeWorker(template, queries, callbackAfterInitializing) {
        this.main.getBottomDiv().console.writeConsoleEntry('Bitte warten, die Datenbank wird initialisiert...', null);
        if (this.worker != null) {
            this.worker.terminate();
        }
        let t = performance.now();
        // console.log("Starting worker...");
        let url = "js/tools/database/sqljsWorker.js";
        if (this.main.isEmbedded()) {
            //@ts-ignore
            url = window.javaOnlineDir + url;
        }
        //@ts-ignore
        if (window.jo_doc) {
            //@ts-ignore
            this.worker = new WorkerSim();
        }
        else {
            this.worker = new Worker(url);
        }
        let that = this;
        let error;
        this.worker.onmessage = () => {
            // console.log("Database opened (" + (performance.now() - t)/1000 + " s)");
            that.worker.onmessage = event => {
                // console.log(event.data);
                let id = event.data.id;
                if (event.data.error == null) {
                    let querySuccessCallback = that.querySuccessCallbacksMap.get(id);
                    if (querySuccessCallback != null) {
                        querySuccessCallback(event.data.results);
                    }
                }
                else {
                    let queryErrorCallback = that.queryErrorCallbackMap.get(id);
                    if (queryErrorCallback != null) {
                        queryErrorCallback(event.data.error);
                    }
                }
                // if(event.data.buffer){
                //     console.log(event.data.buffer);
                // }
                this.queryErrorCallbackMap.delete(id);
                this.querySuccessCallbacksMap.delete(id);
            };
            if (queries == null)
                queries = [];
            queries = queries.slice();
            let queryCount = queries.length;
            let execQuery = () => {
                if (queries.length > 0) {
                    // this.main.getWaitOverlay().setProgress(`${Math.round((1-queries.length/queryCount)*100) + " %"}`)
                    let query = queries.shift();
                    that.executeQuery(query, (result) => {
                        execQuery();
                    }, (error) => {
                        error = ("Error while setting up database: " + error + ", query: " + query);
                        console.log({ "error": "Error while setting up database: " + error, "query": query });
                        console.log();
                        execQuery();
                    });
                }
                else {
                    if (callbackAfterInitializing != null)
                        callbackAfterInitializing(error);
                }
            };
            execQuery();
        };
        this.worker.onerror = (e) => {
            error = ("Worker error: " + e.error);
            console.log("Worker error: " + e.error);
        };
        this.worker.postMessage({
            id: that.queryId++,
            action: "open",
            buffer: template, /*Optional. An ArrayBuffer representing an SQLite Database file*/
        });
    }
    executeQuery(query, successCallback, errorCallback) {
        let id = this.queryId++;
        this.querySuccessCallbacksMap.set(id, successCallback);
        this.queryErrorCallbackMap.set(id, errorCallback);
        this.worker.postMessage({
            id: id,
            action: "exec",
            sql: query,
            params: {}
        });
    }
    executeWriteQueries(queries, successCallback, errorCallback) {
        if (queries.length == 0) {
            successCallback();
            return;
        }
        let query = queries.shift();
        this.executeQuery(query, () => {
            this.executeWriteQueries(queries, successCallback, errorCallback);
        }, (message) => {
            this.executeWriteQueries(queries, () => { }, (error) => { });
            errorCallback(message); // report first error
        });
    }
    static getDumpType(dump) {
        let sqliteMagicBytes = [0x53, 0x51, 0x4c, 0x69, 0x74, 0x65];
        let zlibMagicByte = 0x78;
        let found = true;
        for (let i = 0; i < sqliteMagicBytes.length; i++) {
            if (sqliteMagicBytes[i] != dump[i]) {
                found = false;
                break;
            }
        }
        if (found)
            return "binaryUncompressed";
        if (dump[0] == zlibMagicByte)
            return "binaryCompressed";
        return "other";
    }
    close() {
        if (this.worker != null) {
            this.worker.terminate();
            this.worker = null;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YWJhc2VUb29sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NsaWVudC90b29scy9kYXRhYmFzZS9EYXRhYmFzZVRvb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBaURoRCxNQUFNLE9BQU8sWUFBWTtJQWFyQixZQUFvQixJQUFjO1FBQWQsU0FBSSxHQUFKLElBQUksQ0FBVTtRQVhsQyw2QkFBd0IsR0FBNkIsSUFBSSxDQUFDO1FBSTFELFlBQU8sR0FBVyxDQUFDLENBQUM7UUFFcEIsNkJBQXdCLEdBQXNDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDeEUsMEJBQXFCLEdBQW9DLElBQUksR0FBRyxFQUFFLENBQUM7SUFNbkUsQ0FBQztJQUVELGdCQUFnQixDQUFDLFFBQW9CLEVBQUUsT0FBaUIsRUFBRSx5QkFBbUQ7UUFFekcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsbURBQW1ELEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFMUcsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksRUFBRTtZQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQzNCO1FBRUQsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTFCLHFDQUFxQztRQUVyQyxJQUFJLEdBQUcsR0FBVyxrQ0FBa0MsQ0FBQTtRQUNwRCxJQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUM7WUFDdEIsWUFBWTtZQUNaLEdBQUcsR0FBRyxNQUFNLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQztTQUNwQztRQUVELFlBQVk7UUFDWixJQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUM7WUFDYixZQUFZO1lBQ1osSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLFNB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QUFDLEtBQUssRUFBRSxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7WUFDM0QsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMscUJBQXFCO1FBQ2pELENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBZ0I7UUFFL0IsSUFBSSxnQkFBZ0IsR0FBYSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEUsSUFBSSxhQUFhLEdBQVcsSUFBSSxDQUFDO1FBRWpDLElBQUksS0FBSyxHQUFZLElBQUksQ0FBQztRQUMxQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzlDLElBQUksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNoQyxLQUFLLEdBQUcsS0FBSyxDQUFDO2dCQUNkLE1BQU07YUFDVDtTQUNKO1FBQ0QsSUFBSSxLQUFLO1lBQUUsT0FBTyxvQkFBb0IsQ0FBQztRQUV2QyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxhQUFhO1lBQUUsT0FBTyxrQkFBa0IsQ0FBQztRQUV4RCxPQUFPLE9BQU8sQ0FBQztJQUVuQixDQUFDO0lBRUQsS0FBSztRQUNELElBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUM7WUFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztTQUN0QjtJQUNMLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1haW5CYXNlIH0gZnJvbSBcInNyYy9jbGllbnQvbWFpbi9NYWluQmFzZS5qc1wiO1xyXG5pbXBvcnQgeyBXb3JrZXJTaW0gfSBmcm9tIFwiLi9zcWxqc1dvcmtlclNpbS5qc1wiO1xyXG5cclxuZXhwb3J0IHR5cGUgRGF0YWJhc2VEdW1wVHlwZSA9IFwiYmluYXJ5VW5jb21wcmVzc2VkXCIgfCBcImJpbmFyeUNvbXByZXNzZWRcIiB8IFwib3RoZXJcIjtcclxuXHJcbmV4cG9ydCB0eXBlIERhdGFiYXNlRGlyZWN0b3J5RW50cnkgPSB7XHJcbiAgICBuYW1lOiBzdHJpbmcsXHJcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nLFxyXG4gICAgZmlsZW5hbWU6IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBRdWVyeVJlc3VsdCA9IHtcclxuICAgIGNvbHVtbnM6IHN0cmluZ1tdLFxyXG4gICAgdmFsdWVzOiBhbnlbXVtdLFxyXG4gICAgYnVmZmVyPzogVWludDhBcnJheVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBRdWVyeVN1Y2Nlc3NDYWxsYmFjayA9IChyZXN1bHRzOiBRdWVyeVJlc3VsdFtdKSA9PiB2b2lkO1xyXG5leHBvcnQgdHlwZSBRdWVyeUVycm9yQ2FsbGJhY2sgPSAoZXJyb3I6IHN0cmluZykgPT4gdm9pZDtcclxuXHJcbmV4cG9ydCB0eXBlIENvbHVtblN0cnVjdHVyZSA9IHtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIHRhYmxlOiBUYWJsZVN0cnVjdHVyZTtcclxuXHJcbiAgICB0eXBlTGVuZ3Rocz86IG51bWJlcltdOyAvLyBmb3IgdmFyY2hhcig1KSwgLi4uXHJcbiAgICBjb21wbGV0ZVR5cGVTUUw6IHN0cmluZztcclxuXHJcbiAgICByZWZlcmVuY2VzPzogQ29sdW1uU3RydWN0dXJlO1xyXG4gICAgcmVmZXJlbmNlc1Jhd0RhdGE/OiBhbnlbXTtcclxuICAgIGlzUHJpbWFyeUtleTogYm9vbGVhbjtcclxuICAgIGlzQXV0b0luY3JlbWVudDogYm9vbGVhbjtcclxuXHJcbiAgICBub3ROdWxsOiBib29sZWFuO1xyXG4gICAgZGVmYXVsdFZhbHVlOiBzdHJpbmc7XHJcblxyXG4gICAgZHVtcFZhbHVlRnVuY3Rpb24/OiAoYW55KSA9PiBzdHJpbmdcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgVGFibGVTdHJ1Y3R1cmUgPSB7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbiAgICBzaXplOiBudW1iZXI7XHJcbiAgICBjb2x1bW5zOiBDb2x1bW5TdHJ1Y3R1cmVbXTtcclxuICAgIGNvbXBsZXRlU1FMOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIERhdGFiYXNlU3RydWN0dXJlID0ge1xyXG4gICAgdGFibGVzOiBUYWJsZVN0cnVjdHVyZVtdXHJcbn1cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VUb29sIHtcclxuXHJcbiAgICBkYXRhYmFzZURpcmVjdG9yeUVudHJpZXM6IERhdGFiYXNlRGlyZWN0b3J5RW50cnlbXSA9IG51bGw7XHJcblxyXG4gICAgd29ya2VyOiBXb3JrZXI7XHJcblxyXG4gICAgcXVlcnlJZDogbnVtYmVyID0gMDtcclxuXHJcbiAgICBxdWVyeVN1Y2Nlc3NDYWxsYmFja3NNYXA6IE1hcDxudW1iZXIsIFF1ZXJ5U3VjY2Vzc0NhbGxiYWNrPiA9IG5ldyBNYXAoKTtcclxuICAgIHF1ZXJ5RXJyb3JDYWxsYmFja01hcDogTWFwPG51bWJlciwgUXVlcnlFcnJvckNhbGxiYWNrPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICBkYXRhYmFzZVN0cnVjdHVyZTogRGF0YWJhc2VTdHJ1Y3R1cmU7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBtYWluOiBNYWluQmFzZSl7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGluaXRpYWxpemVXb3JrZXIodGVtcGxhdGU6IFVpbnQ4QXJyYXksIHF1ZXJpZXM6IHN0cmluZ1tdLCBjYWxsYmFja0FmdGVySW5pdGlhbGl6aW5nPzogKGVycm9yOiBzdHJpbmcpID0+IHZvaWQpIHtcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLm1haW4uZ2V0Qm90dG9tRGl2KCkuY29uc29sZS53cml0ZUNvbnNvbGVFbnRyeSgnQml0dGUgd2FydGVuLCBkaWUgRGF0ZW5iYW5rIHdpcmQgaW5pdGlhbGlzaWVydC4uLicsIG51bGwpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBpZiAodGhpcy53b3JrZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmtlci50ZXJtaW5hdGUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB0ID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgd29ya2VyLi4uXCIpO1xyXG5cclxuICAgICAgICBsZXQgdXJsOiBzdHJpbmcgPSBcImpzL3Rvb2xzL2RhdGFiYXNlL3NxbGpzV29ya2VyLmpzXCJcclxuICAgICAgICBpZih0aGlzLm1haW4uaXNFbWJlZGRlZCgpKXtcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHVybCA9IHdpbmRvdy5qYXZhT25saW5lRGlyICsgdXJsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgaWYod2luZG93LmpvX2RvYyl7XHJcbiAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB0aGlzLndvcmtlciA9IG5ldyBXb3JrZXJTaW0oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLndvcmtlciA9IG5ldyBXb3JrZXIodXJsKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG5cclxuICAgICAgICBsZXQgZXJyb3I6IHN0cmluZztcclxuXHJcbiAgICAgICAgdGhpcy53b3JrZXIub25tZXNzYWdlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkRhdGFiYXNlIG9wZW5lZCAoXCIgKyAocGVyZm9ybWFuY2Uubm93KCkgLSB0KS8xMDAwICsgXCIgcylcIik7XHJcbiAgICAgICAgICAgIHRoYXQud29ya2VyLm9ubWVzc2FnZSA9IGV2ZW50ID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhldmVudC5kYXRhKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaWQgPSBldmVudC5kYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEuZXJyb3IgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBxdWVyeVN1Y2Nlc3NDYWxsYmFjayA9IHRoYXQucXVlcnlTdWNjZXNzQ2FsbGJhY2tzTWFwLmdldChpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5U3VjY2Vzc0NhbGxiYWNrICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlTdWNjZXNzQ2FsbGJhY2soZXZlbnQuZGF0YS5yZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBxdWVyeUVycm9yQ2FsbGJhY2sgPSB0aGF0LnF1ZXJ5RXJyb3JDYWxsYmFja01hcC5nZXQoaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChxdWVyeUVycm9yQ2FsbGJhY2sgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBxdWVyeUVycm9yQ2FsbGJhY2soZXZlbnQuZGF0YS5lcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIGlmKGV2ZW50LmRhdGEuYnVmZmVyKXtcclxuICAgICAgICAgICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhldmVudC5kYXRhLmJ1ZmZlcik7XHJcbiAgICAgICAgICAgICAgICAvLyB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMucXVlcnlFcnJvckNhbGxiYWNrTWFwLmRlbGV0ZShpZCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5U3VjY2Vzc0NhbGxiYWNrc01hcC5kZWxldGUoaWQpO1xyXG5cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmKHF1ZXJpZXMgPT0gbnVsbCkgcXVlcmllcyA9IFtdO1xyXG4gICAgICAgICAgICBxdWVyaWVzID0gcXVlcmllcy5zbGljZSgpO1xyXG4gICAgICAgICAgICBsZXQgcXVlcnlDb3VudCA9IHF1ZXJpZXMubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgbGV0IGV4ZWNRdWVyeSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChxdWVyaWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLm1haW4uZ2V0V2FpdE92ZXJsYXkoKS5zZXRQcm9ncmVzcyhgJHtNYXRoLnJvdW5kKCgxLXF1ZXJpZXMubGVuZ3RoL3F1ZXJ5Q291bnQpKjEwMCkgKyBcIiAlXCJ9YClcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcXVlcnkgPSBxdWVyaWVzLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlUXVlcnkocXVlcnksIChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhlY1F1ZXJ5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gKFwiRXJyb3Igd2hpbGUgc2V0dGluZyB1cCBkYXRhYmFzZTogXCIgKyBlcnJvciArIFwiLCBxdWVyeTogXCIgKyBxdWVyeSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHtcImVycm9yXCI6IFwiRXJyb3Igd2hpbGUgc2V0dGluZyB1cCBkYXRhYmFzZTogXCIgKyBlcnJvciwgXCJxdWVyeVwiOiBxdWVyeX0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWNRdWVyeSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja0FmdGVySW5pdGlhbGl6aW5nICE9IG51bGwpIGNhbGxiYWNrQWZ0ZXJJbml0aWFsaXppbmcoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGV4ZWNRdWVyeSgpO1xyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLndvcmtlci5vbmVycm9yID0gKGUpID0+IHtcclxuICAgICAgICAgICAgZXJyb3IgPSAoXCJXb3JrZXIgZXJyb3I6IFwiICsgZS5lcnJvcik7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiV29ya2VyIGVycm9yOiBcIiArIGUuZXJyb3IpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy53b3JrZXIucG9zdE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICBpZDogdGhhdC5xdWVyeUlkKyssXHJcbiAgICAgICAgICAgIGFjdGlvbjogXCJvcGVuXCIsXHJcbiAgICAgICAgICAgIGJ1ZmZlcjogdGVtcGxhdGUsIC8qT3B0aW9uYWwuIEFuIEFycmF5QnVmZmVyIHJlcHJlc2VudGluZyBhbiBTUUxpdGUgRGF0YWJhc2UgZmlsZSovXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGVRdWVyeShxdWVyeTogc3RyaW5nLCBzdWNjZXNzQ2FsbGJhY2s6IFF1ZXJ5U3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrOiBRdWVyeUVycm9yQ2FsbGJhY2spIHtcclxuXHJcbiAgICAgICAgbGV0IGlkID0gdGhpcy5xdWVyeUlkKys7XHJcblxyXG4gICAgICAgIHRoaXMucXVlcnlTdWNjZXNzQ2FsbGJhY2tzTWFwLnNldChpZCwgc3VjY2Vzc0NhbGxiYWNrKTtcclxuICAgICAgICB0aGlzLnF1ZXJ5RXJyb3JDYWxsYmFja01hcC5zZXQoaWQsIGVycm9yQ2FsbGJhY2spO1xyXG5cclxuICAgICAgICB0aGlzLndvcmtlci5wb3N0TWVzc2FnZSh7XHJcbiAgICAgICAgICAgIGlkOiBpZCxcclxuICAgICAgICAgICAgYWN0aW9uOiBcImV4ZWNcIixcclxuICAgICAgICAgICAgc3FsOiBxdWVyeSxcclxuICAgICAgICAgICAgcGFyYW1zOiB7fVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlV3JpdGVRdWVyaWVzKHF1ZXJpZXM6IHN0cmluZ1tdLCBzdWNjZXNzQ2FsbGJhY2s6ICgpID0+IHZvaWQsIGVycm9yQ2FsbGJhY2s6IFF1ZXJ5RXJyb3JDYWxsYmFjayl7XHJcblxyXG4gICAgICAgIGlmKHF1ZXJpZXMubGVuZ3RoID09IDApe1xyXG4gICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcXVlcnkgPSBxdWVyaWVzLnNoaWZ0KCk7XHJcblxyXG4gICAgICAgIHRoaXMuZXhlY3V0ZVF1ZXJ5KHF1ZXJ5LCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZVdyaXRlUXVlcmllcyhxdWVyaWVzLCBzdWNjZXNzQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spO1xyXG4gICAgICAgIH0sIChtZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZVdyaXRlUXVlcmllcyhxdWVyaWVzLCAoKSA9PiB7fSwgKGVycm9yKSA9PiB7fSk7XHJcbiAgICAgICAgICAgIGVycm9yQ2FsbGJhY2sobWVzc2FnZSk7IC8vIHJlcG9ydCBmaXJzdCBlcnJvclxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZ2V0RHVtcFR5cGUoZHVtcDogVWludDhBcnJheSk6IERhdGFiYXNlRHVtcFR5cGUge1xyXG5cclxuICAgICAgICBsZXQgc3FsaXRlTWFnaWNCeXRlczogbnVtYmVyW10gPSBbMHg1MywgMHg1MSwgMHg0YywgMHg2OSwgMHg3NCwgMHg2NV07XHJcbiAgICAgICAgbGV0IHpsaWJNYWdpY0J5dGU6IG51bWJlciA9IDB4Nzg7XHJcblxyXG4gICAgICAgIGxldCBmb3VuZDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcWxpdGVNYWdpY0J5dGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChzcWxpdGVNYWdpY0J5dGVzW2ldICE9IGR1bXBbaV0pIHtcclxuICAgICAgICAgICAgICAgIGZvdW5kID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZm91bmQpIHJldHVybiBcImJpbmFyeVVuY29tcHJlc3NlZFwiO1xyXG5cclxuICAgICAgICBpZiAoZHVtcFswXSA9PSB6bGliTWFnaWNCeXRlKSByZXR1cm4gXCJiaW5hcnlDb21wcmVzc2VkXCI7XHJcblxyXG4gICAgICAgIHJldHVybiBcIm90aGVyXCI7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlKCl7XHJcbiAgICAgICAgaWYodGhpcy53b3JrZXIgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIHRoaXMud29ya2VyLnRlcm1pbmF0ZSgpO1xyXG4gICAgICAgICAgICB0aGlzLndvcmtlciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufSJdfQ==