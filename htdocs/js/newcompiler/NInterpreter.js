import { InputManager } from "../interpreter/InputManager.js";
import { PrintManager } from "../main/gui/PrintManager.js";
import { GamepadTool } from "../tools/GamepadTool.js";
import { KeyboardTool } from "../tools/KeyboardTool.js";
import { NLoadController } from "./NLoadController.js";
import { NThreadPool, NThreadPoolLstate } from "./NThreadPool.js";
export class NInterpreter {
    constructor(main, controlButtons, $runDiv) {
        this.main = main;
        this.controlButtons = controlButtons;
        this.isExternalTimer = false;
        this.timerIntervalMs = 16;
        this.moduleStoreVersion = -100;
        this.actions = ["start", "pause", "stop", "stepOver",
            "stepInto", "stepOut", "restart"];
        //NThreadPoolLstatus { done, running, paused, not_initialized }
        // buttonActiveMatrix[button][i] tells if button is active at 
        // InterpreterState i
        this.buttonActiveMatrix = {
            "start": [true, false, true, false],
            "pause": [false, true, false, false],
            "stop": [false, true, true, false],
            "stepOver": [true, false, true, false],
            "stepInto": [true, false, true, false],
            "stepOut": [false, false, true, false],
            "restart": [true, true, true, false]
        };
        this.printManager = new PrintManager($runDiv, this.main);
        this.inputManager = new InputManager($runDiv, this.main);
        if (main.isEmbedded()) {
            this.keyboardTool = new KeyboardTool(jQuery('html'), main);
        }
        else {
            this.keyboardTool = new KeyboardTool(jQuery(window), main);
        }
        this.gamepadTool = new GamepadTool();
        // TODO: This wires up speedcontrol with interpreter
        // controlButtons.setInterpreter(this);
        this.threadPool = new NThreadPool(this);
        this.loadController = new NLoadController(this.threadPool, this);
        this.initTimer();
    }
    initTimer() {
        let that = this;
        let periodicFunction = () => {
            if (!that.isExternalTimer) {
                that.timerFunction(that.timerIntervalMs);
            }
        };
        this.timerId = setInterval(periodicFunction, this.timerIntervalMs);
    }
    timerFunction(timerIntervalMs) {
        if (this.threadPool.state == NThreadPoolLstate.running) {
            this.loadController.tick(timerIntervalMs);
        }
    }
    executeOneStep(stepInto) {
        if (this.threadPool.state != NThreadPoolLstate.paused) {
            this.init();
            if (this.threadPool.state == NThreadPoolLstate.not_initialized) {
                return;
            }
            this.resetRuntime();
        }
        this.threadPool.runSingleStepKeepingThread(stepInto, () => {
            this.pause();
        });
        if (!stepInto) {
            this.threadPool.setState(NThreadPoolLstate.running);
        }
    }
    showProgramPointer(position) {
        throw new Error("Method not implemented.");
    }
    pause() {
        this.threadPool.setState(NThreadPoolLstate.paused);
        this.threadPool.unmarkStep();
        this.showProgramPointer(this.threadPool.getNextStepPosition());
    }
    stop(restart) {
        var _a;
        this.inputManager.hide();
        this.threadPool.setState(NThreadPoolLstate.done);
        this.threadPool.unmarkStep();
        if (this.worldHelper != null) {
            this.worldHelper.spriteAnimations = [];
        }
        (_a = this.gngEreignisbehandlungHelper) === null || _a === void 0 ? void 0 : _a.detachEvents();
        this.gngEreignisbehandlungHelper = null;
        this.getTimerClass().stopTimer();
        if (this.worldHelper != null) {
            this.worldHelper.cacheAsBitmap();
        }
        setTimeout(() => {
            this.main.hideProgramPointerPosition();
            if (restart) {
                this.start();
            }
        }, 500);
    }
    start() {
        var _a, _b;
        (_b = (_a = this.main.getBottomDiv()) === null || _a === void 0 ? void 0 : _a.console) === null || _b === void 0 ? void 0 : _b.clearErrors();
        if (this.threadPool.state != NThreadPoolLstate.paused) {
            this.init();
            this.resetRuntime();
        }
        this.hideProgrampointerPosition();
        this.threadPool.setState(NThreadPoolLstate.running);
        this.getTimerClass().startTimer();
    }
    stepOut() {
        this.threadPool.stepOut(() => {
            this.pause();
        });
    }
    initGUI() {
        let that = this;
        let am = this.main.getActionManager();
        am.registerAction("interpreter.start", ['F4'], () => {
            if (am.isActive("interpreter.start")) {
                this.start();
            }
            else {
                this.pause();
            }
        }, "Programm starten", this.controlButtons.$buttonStart);
        am.registerAction("interpreter.pause", ['F4'], () => {
            if (am.isActive("interpreter.start")) {
                this.start();
            }
            else {
                this.pause();
            }
        }, "Pause", this.controlButtons.$buttonPause);
        am.registerAction("interpreter.stop", [], () => {
            this.stop(false);
        }, "Programm anhalten", this.controlButtons.$buttonStop);
        am.registerAction("interpreter.stepOver", ['F6'], () => {
            this.executeOneStep(false);
        }, "Einzelschritt (Step over)", this.controlButtons.$buttonStepOver);
        am.registerAction("interpreter.stepInto", ['F7'], () => {
            this.executeOneStep(true);
        }, "Einzelschritt (Step into)", this.controlButtons.$buttonStepInto);
        am.registerAction("interpreter.stepOut", [], () => {
            this.stepOut();
        }, "Step out", this.controlButtons.$buttonStepOut);
        am.registerAction("interpreter.restart", [], () => {
            this.stop(true);
        }, "Neu starten", this.controlButtons.$buttonRestart);
    }
    setState(oldState, state) {
        var _a;
        if (state == NThreadPoolLstate.done) {
            // TODO
            // this.closeAllWebsockets();
        }
        let am = this.main.getActionManager();
        for (let actionId of this.actions) {
            am.setActive("interpreter." + actionId, this.buttonActiveMatrix[actionId][state]);
        }
        let buttonStartActive = this.buttonActiveMatrix['start'][state];
        if (buttonStartActive) {
            this.controlButtons.$buttonStart.show();
            this.controlButtons.$buttonPause.hide();
        }
        else {
            this.controlButtons.$buttonStart.hide();
            this.controlButtons.$buttonPause.show();
        }
        let buttonStopActive = this.buttonActiveMatrix['stop'][state];
        if (state == NThreadPoolLstate.done) {
            if (this.worldHelper != null) {
                this.worldHelper.clearActorLists();
            }
            (_a = this.gngEreignisbehandlungHelper) === null || _a === void 0 ? void 0 : _a.detachEvents();
            this.gngEreignisbehandlungHelper = null;
        }
        if (oldState != NThreadPoolLstate.done && state == NThreadPoolLstate.done) {
            // TODO
            // this.debugger.disable();
            this.keyboardTool.unsubscribeAllListeners();
        }
        if ([NThreadPoolLstate.running, NThreadPoolLstate.paused].indexOf(oldState) < 0
            && state == NThreadPoolLstate.running) {
            // TODO
            //   this.debugger.enable();
        }
    }
    getStartableModule(moduleStore) {
        let cem;
        cem = this.main.getCurrentlyEditedModule();
        let currentlyEditedModuleIsClassOnly = false;
        // decide which module to start
        // first attempt: is currently edited Module startable?
        if (cem != null) {
            let currentlyEditedModule = moduleStore.findModuleByFile(cem.file);
            if (currentlyEditedModule != null) {
                currentlyEditedModuleIsClassOnly = !cem.hasErrors()
                    && !currentlyEditedModule.isStartable;
                if (currentlyEditedModule.isStartable) {
                    return currentlyEditedModule;
                }
            }
        }
        // second attempt: which module has been started last time?
        if (this.mainModule != null && currentlyEditedModuleIsClassOnly) {
            let lastMainModule = moduleStore.findModuleByFile(this.mainModule.file);
            if (lastMainModule != null && lastMainModule.isStartable) {
                return lastMainModule;
            }
        }
        // third attempt: pick first startable module of current workspace
        if (currentlyEditedModuleIsClassOnly) {
            for (let m of moduleStore.getModules(false)) {
                if (m.isStartable) {
                    return m;
                }
            }
        }
        return null;
    }
    resetRuntime() {
        var _a, _b, _c;
        this.printManager.clear();
        (_a = this.worldHelper) === null || _a === void 0 ? void 0 : _a.destroyWorld();
        (_b = this.processingHelper) === null || _b === void 0 ? void 0 : _b.destroyWorld();
        (_c = this.gngEreignisbehandlungHelper) === null || _c === void 0 ? void 0 : _c.detachEvents();
        this.gngEreignisbehandlungHelper = null;
    }
    getTimerClass() {
        let baseModule = this.main.getCurrentWorkspace().moduleStore.getModule("Base Module");
        return baseModule.typeStore.getType("Timer");
    }
    init() {
        var _a, _b, _c, _d, _e, _f;
        (_b = (_a = this.main.getBottomDiv()) === null || _a === void 0 ? void 0 : _a.console) === null || _b === void 0 ? void 0 : _b.clearErrors();
        let cem = this.main.getCurrentlyEditedModule();
        cem.getBreakpointPositionsFromEditor();
        (_d = (_c = this.main.getBottomDiv()) === null || _c === void 0 ? void 0 : _c.console) === null || _d === void 0 ? void 0 : _d.clearExceptions();
        /*
            As long as there is no startable new Version of current workspace we keep current compiled modules so
            that variables and objects defined/instantiated via console can be kept, too.
        */
        if (this.moduleStoreVersion != this.main.version && this.main.getCompiler().atLeastOneModuleIsStartable) {
            this.main.copyExecutableModuleStoreToInterpreter();
            (_f = (_e = this.main.getBottomDiv()) === null || _e === void 0 ? void 0 : _e.console) === null || _f === void 0 ? void 0 : _f.detachValues(); // detach values from console entries
        }
        let newMainModule = this.getStartableModule(this.moduleStore);
        if (newMainModule == null) {
            this.threadPool.setState(NThreadPoolLstate.not_initialized);
            return;
        }
        this.mainModule = newMainModule;
        this.threadPool.init(this.moduleStore, this.mainModule);
        this.threadPool.setState(NThreadPoolLstate.done);
    }
    hideProgrampointerPosition() {
        this.main.hideProgramPointerPosition();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTkludGVycHJldGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NsaWVudC9uZXdjb21waWxlci9OSW50ZXJwcmV0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzlELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQU8zRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsV0FBVyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHbEUsTUFBTSxPQUFPLFlBQVk7SUEwQ3JCLFlBQW1CLElBQWMsRUFBUyxjQUFxQyxFQUFFLE9BQTRCO1FBQTFGLFNBQUksR0FBSixJQUFJLENBQVU7UUFBUyxtQkFBYyxHQUFkLGNBQWMsQ0FBdUI7UUFyQy9FLG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBRWpDLG9CQUFlLEdBQVcsRUFBRSxDQUFDO1FBSTdCLHVCQUFrQixHQUFXLENBQUMsR0FBRyxDQUFDO1FBYWxDLFlBQU8sR0FBYSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVU7WUFDckQsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN0QywrREFBK0Q7UUFFL0QsOERBQThEO1FBQzlELHFCQUFxQjtRQUNyQix1QkFBa0IsR0FBd0M7WUFDdEQsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDO1lBQ25DLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztZQUNwQyxNQUFNLEVB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SiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZHVsZSwgTW9kdWxlU3RvcmUgfSBmcm9tIFwiLi4vY29tcGlsZXIvcGFyc2VyL01vZHVsZS5qc1wiO1xyXG5pbXBvcnQgeyBUZXh0UG9zaXRpb25XaXRoTW9kdWxlIH0gZnJvbSBcIi4uL2NvbXBpbGVyL3R5cGVzL1R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IElucHV0TWFuYWdlciB9IGZyb20gXCIuLi9pbnRlcnByZXRlci9JbnB1dE1hbmFnZXIuanNcIjtcclxuaW1wb3J0IHsgUHJpbnRNYW5hZ2VyIH0gZnJvbSBcIi4uL21haW4vZ3VpL1ByaW50TWFuYWdlci5qc1wiO1xyXG5pbXBvcnQgeyBQcm9ncmFtQ29udHJvbEJ1dHRvbnMgfSBmcm9tIFwiLi4vbWFpbi9ndWkvUHJvZ3JhbUNvbnRyb2xCdXR0b25zLmpzXCI7XHJcbmltcG9ydCB7IE1haW5CYXNlIH0gZnJvbSBcIi4uL21haW4vTWFpbkJhc2UuanNcIjtcclxuaW1wb3J0IHsgR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyIH0gZnJvbSBcIi4uL3J1bnRpbWVsaWJyYXJ5L2duZy9HTkdFcmVpZ25pc2JlaGFuZGx1bmcuanNcIjtcclxuaW1wb3J0IHsgUHJvY2Vzc2luZ0hlbHBlciB9IGZyb20gXCIuLi9ydW50aW1lbGlicmFyeS9ncmFwaGljcy9Qcm9jZXNzaW5nLmpzXCI7XHJcbmltcG9ydCB7IFdvcmxkSGVscGVyIH0gZnJvbSBcIi4uL3J1bnRpbWVsaWJyYXJ5L2dyYXBoaWNzL1dvcmxkLmpzXCI7XHJcbmltcG9ydCB7IFRpbWVyQ2xhc3MgfSBmcm9tIFwiLi4vcnVudGltZWxpYnJhcnkvVGltZXIuanNcIjtcclxuaW1wb3J0IHsgR2FtZXBhZFRvb2wgfSBmcm9tIFwiLi4vdG9vbHMvR2FtZXBhZFRvb2wuanNcIjtcclxuaW1wb3J0IHsgS2V5Ym9hcmRUb29sIH0gZnJvbSBcIi4uL3Rvb2xzL0tleWJvYXJkVG9vbC5qc1wiO1xyXG5pbXBvcnQgeyBOTG9hZENvbnRyb2xsZXIgfSBmcm9tIFwiLi9OTG9hZENvbnRyb2xsZXIuanNcIjtcclxuaW1wb3J0IHsgTlRocmVhZFBvb2wsIE5UaHJlYWRQb29sTHN0YXRlIH0gZnJvbSBcIi4vTlRocmVhZFBvb2wuanNcIjtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgTkludGVycHJldGVyIHtcclxuXHJcbiAgICBsb2FkQ29udHJvbGxlcjogTkxvYWRDb250cm9sbGVyO1xyXG4gICAgdGhyZWFkUG9vbDogTlRocmVhZFBvb2w7XHJcblxyXG4gICAgaXNFeHRlcm5hbFRpbWVyOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICB0aW1lcklkOiBhbnk7XHJcbiAgICB0aW1lckludGVydmFsTXM6IG51bWJlciA9IDE2O1xyXG5cclxuICAgIG1haW5Nb2R1bGU6IE1vZHVsZTtcclxuICAgIG1vZHVsZVN0b3JlOiBNb2R1bGVTdG9yZTtcclxuICAgIG1vZHVsZVN0b3JlVmVyc2lvbjogbnVtYmVyID0gLTEwMDtcclxuXHJcbiAgICBwcmludE1hbmFnZXI6IFByaW50TWFuYWdlcjtcclxuICAgIGlucHV0TWFuYWdlcjogSW5wdXRNYW5hZ2VyO1xyXG5cclxuICAgIGtleWJvYXJkVG9vbDogS2V5Ym9hcmRUb29sO1xyXG4gICAgZ2FtZXBhZFRvb2w6IEdhbWVwYWRUb29sO1xyXG5cclxuICAgIHdvcmxkSGVscGVyOiBXb3JsZEhlbHBlcjtcclxuICAgIGduZ0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcjogR05HRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyO1xyXG4gICAgcHJvY2Vzc2luZ0hlbHBlcjogUHJvY2Vzc2luZ0hlbHBlcjtcclxuXHJcblxyXG4gICAgYWN0aW9uczogc3RyaW5nW10gPSBbXCJzdGFydFwiLCBcInBhdXNlXCIsIFwic3RvcFwiLCBcInN0ZXBPdmVyXCIsXHJcbiAgICAgICAgXCJzdGVwSW50b1wiLCBcInN0ZXBPdXRcIiwgXCJyZXN0YXJ0XCJdO1xyXG4gICAgLy9OVGhyZWFkUG9vbExzdGF0dXMgeyBkb25lLCBydW5uaW5nLCBwYXVzZWQsIG5vdF9pbml0aWFsaXplZCB9XHJcblxyXG4gICAgLy8gYnV0dG9uQWN0aXZlTWF0cml4W2J1dHRvbl1baV0gdGVsbHMgaWYgYnV0dG9uIGlzIGFjdGl2ZSBhdCBcclxuICAgIC8vIEludGVycHJldGVyU3RhdGUgaVxyXG4gICAgYnV0dG9uQWN0aXZlTWF0cml4OiB7IFtidXR0b25OYW1lOiBzdHJpbmddOiBib29sZWFuW10gfSA9IHtcclxuICAgICAgICBcInN0YXJ0XCI6IFt0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2VdLFxyXG4gICAgICAgIFwicGF1c2VcIjogW2ZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2VdLFxyXG4gICAgICAgIFwic3RvcFwiOiBbZmFsc2UsIHRydWUsIHRydWUsIGZhbHNlXSxcclxuICAgICAgICBcInN0ZXBPdmVyXCI6IFt0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2VdLFxyXG4gICAgICAgIFwic3RlcEludG9cIjogW3RydWUsIGZhbHNlLCB0cnVlLCBmYWxzZV0sXHJcbiAgICAgICAgXCJzdGVwT3V0XCI6IFtmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlXSxcclxuICAgICAgICBcInJlc3RhcnRcIjogW3RydWUsIHRydWUsIHRydWUsIGZhbHNlXVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IocHVibGljIG1haW46IE1haW5CYXNlLCBwdWJsaWMgY29udHJvbEJ1dHRvbnM6IFByb2dyYW1Db250cm9sQnV0dG9ucywgJHJ1bkRpdjogSlF1ZXJ5PEhUTUxFbGVtZW50Pikge1xyXG5cclxuICAgICAgICB0aGlzLnByaW50TWFuYWdlciA9IG5ldyBQcmludE1hbmFnZXIoJHJ1bkRpdiwgdGhpcy5tYWluKTtcclxuICAgICAgICB0aGlzLmlucHV0TWFuYWdlciA9IG5ldyBJbnB1dE1hbmFnZXIoJHJ1bkRpdiwgdGhpcy5tYWluKTtcclxuICAgICAgICBpZiAobWFpbi5pc0VtYmVkZGVkKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5rZXlib2FyZFRvb2wgPSBuZXcgS2V5Ym9hcmRUb29sKGpRdWVyeSgnaHRtbCcpLCBtYWluKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmtleWJvYXJkVG9vbCA9IG5ldyBLZXlib2FyZFRvb2woalF1ZXJ5KHdpbmRvdyksIG1haW4pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5nYW1lcGFkVG9vbCA9IG5ldyBHYW1lcGFkVG9vbCgpO1xyXG5cclxuICAgICAgICAvLyBUT0RPOiBUaGlzIHdpcmVzIHVwIHNwZWVkY29udHJvbCB3aXRoIGludGVycHJldGVyXHJcbiAgICAgICAgLy8gY29udHJvbEJ1dHRvbnMuc2V0SW50ZXJwcmV0ZXIodGhpcyk7XHJcblxyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbCA9IG5ldyBOVGhyZWFkUG9vbCh0aGlzKTtcclxuICAgICAgICB0aGlzLmxvYWRDb250cm9sbGVyID0gbmV3IE5Mb2FkQ29udHJvbGxlcih0aGlzLnRocmVhZFBvb2wsIHRoaXMpO1xyXG4gICAgICAgIHRoaXMuaW5pdFRpbWVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdFRpbWVyKCkge1xyXG5cclxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgbGV0IHBlcmlvZGljRnVuY3Rpb24gPSAoKSA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXRoYXQuaXNFeHRlcm5hbFRpbWVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGF0LnRpbWVyRnVuY3Rpb24odGhhdC50aW1lckludGVydmFsTXMpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy50aW1lcklkID0gc2V0SW50ZXJ2YWwocGVyaW9kaWNGdW5jdGlvbiwgdGhpcy50aW1lckludGVydmFsTXMpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICB0aW1lckZ1bmN0aW9uKHRpbWVySW50ZXJ2YWxNczogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudGhyZWFkUG9vbC5zdGF0ZSA9PSBOVGhyZWFkUG9vbExzdGF0ZS5ydW5uaW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZENvbnRyb2xsZXIudGljayh0aW1lckludGVydmFsTXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlT25lU3RlcChzdGVwSW50bzogYm9vbGVhbikge1xyXG5cclxuICAgICAgICBpZiAodGhpcy50aHJlYWRQb29sLnN0YXRlICE9IE5UaHJlYWRQb29sTHN0YXRlLnBhdXNlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICAgICAgaWYodGhpcy50aHJlYWRQb29sLnN0YXRlID09IE5UaHJlYWRQb29sTHN0YXRlLm5vdF9pbml0aWFsaXplZCl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5yZXNldFJ1bnRpbWUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC5ydW5TaW5nbGVTdGVwS2VlcGluZ1RocmVhZChzdGVwSW50bywgKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnBhdXNlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKCFzdGVwSW50bykge1xyXG4gICAgICAgICAgICB0aGlzLnRocmVhZFBvb2wuc2V0U3RhdGUoTlRocmVhZFBvb2xMc3RhdGUucnVubmluZyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNob3dQcm9ncmFtUG9pbnRlcihwb3NpdGlvbjogVGV4dFBvc2l0aW9uV2l0aE1vZHVsZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHBhdXNlKCkge1xyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC5zZXRTdGF0ZShOVGhyZWFkUG9vbExzdGF0ZS5wYXVzZWQpO1xyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC51bm1hcmtTdGVwKCk7XHJcbiAgICAgICAgdGhpcy5zaG93UHJvZ3JhbVBvaW50ZXIodGhpcy50aHJlYWRQb29sLmdldE5leHRTdGVwUG9zaXRpb24oKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RvcChyZXN0YXJ0OiBib29sZWFuKSB7XHJcblxyXG4gICAgICAgIHRoaXMuaW5wdXRNYW5hZ2VyLmhpZGUoKTtcclxuICAgICAgICB0aGlzLnRocmVhZFBvb2wuc2V0U3RhdGUoTlRocmVhZFBvb2xMc3RhdGUuZG9uZSk7XHJcbiAgICAgICAgdGhpcy50aHJlYWRQb29sLnVubWFya1N0ZXAoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMud29ybGRIZWxwZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkSGVscGVyLnNwcml0ZUFuaW1hdGlvbnMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXI/LmRldGFjaEV2ZW50cygpO1xyXG4gICAgICAgIHRoaXMuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgdGhpcy5nZXRUaW1lckNsYXNzKCkuc3RvcFRpbWVyKCk7XHJcbiAgICAgICAgaWYgKHRoaXMud29ybGRIZWxwZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmxkSGVscGVyLmNhY2hlQXNCaXRtYXAoKTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5tYWluLmhpZGVQcm9ncmFtUG9pbnRlclBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgIGlmIChyZXN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCA1MDApO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgc3RhcnQoKSB7XHJcblxyXG4gICAgICAgIHRoaXMubWFpbi5nZXRCb3R0b21EaXYoKT8uY29uc29sZT8uY2xlYXJFcnJvcnMoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMudGhyZWFkUG9vbC5zdGF0ZSAhPSBOVGhyZWFkUG9vbExzdGF0ZS5wYXVzZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVzZXRSdW50aW1lKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmhpZGVQcm9ncmFtcG9pbnRlclBvc2l0aW9uKCk7XHJcblxyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC5zZXRTdGF0ZShOVGhyZWFkUG9vbExzdGF0ZS5ydW5uaW5nKTtcclxuXHJcbiAgICAgICAgdGhpcy5nZXRUaW1lckNsYXNzKCkuc3RhcnRUaW1lcigpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBzdGVwT3V0KCkge1xyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC5zdGVwT3V0KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wYXVzZSgpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEdVSSgpIHtcclxuXHJcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xyXG5cclxuICAgICAgICBsZXQgYW0gPSB0aGlzLm1haW4uZ2V0QWN0aW9uTWFuYWdlcigpO1xyXG5cclxuICAgICAgICBhbS5yZWdpc3RlckFjdGlvbihcImludGVycHJldGVyLnN0YXJ0XCIsIFsnRjQnXSxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGFtLmlzQWN0aXZlKFwiaW50ZXJwcmV0ZXIuc3RhcnRcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGF1c2UoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0sIFwiUHJvZ3JhbW0gc3RhcnRlblwiLCB0aGlzLmNvbnRyb2xCdXR0b25zLiRidXR0b25TdGFydCk7XHJcblxyXG4gICAgICAgIGFtLnJlZ2lzdGVyQWN0aW9uKFwiaW50ZXJwcmV0ZXIucGF1c2VcIiwgWydGNCddLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYW0uaXNBY3RpdmUoXCJpbnRlcnByZXRlci5zdGFydFwiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXVzZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSwgXCJQYXVzZVwiLCB0aGlzLmNvbnRyb2xCdXR0b25zLiRidXR0b25QYXVzZSk7XHJcblxyXG4gICAgICAgIGFtLnJlZ2lzdGVyQWN0aW9uKFwiaW50ZXJwcmV0ZXIuc3RvcFwiLCBbXSxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wKGZhbHNlKTtcclxuICAgICAgICAgICAgfSwgXCJQcm9ncmFtbSBhbmhhbHRlblwiLCB0aGlzLmNvbnRyb2xCdXR0b25zLiRidXR0b25TdG9wKTtcclxuXHJcbiAgICAgICAgYW0ucmVnaXN0ZXJBY3Rpb24oXCJpbnRlcnByZXRlci5zdGVwT3ZlclwiLCBbJ0Y2J10sXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXhlY3V0ZU9uZVN0ZXAoZmFsc2UpO1xyXG4gICAgICAgICAgICB9LCBcIkVpbnplbHNjaHJpdHQgKFN0ZXAgb3ZlcilcIiwgdGhpcy5jb250cm9sQnV0dG9ucy4kYnV0dG9uU3RlcE92ZXIpO1xyXG5cclxuICAgICAgICBhbS5yZWdpc3RlckFjdGlvbihcImludGVycHJldGVyLnN0ZXBJbnRvXCIsIFsnRjcnXSxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlT25lU3RlcCh0cnVlKTtcclxuICAgICAgICAgICAgfSwgXCJFaW56ZWxzY2hyaXR0IChTdGVwIGludG8pXCIsIHRoaXMuY29udHJvbEJ1dHRvbnMuJGJ1dHRvblN0ZXBJbnRvKTtcclxuXHJcbiAgICAgICAgYW0ucmVnaXN0ZXJBY3Rpb24oXCJpbnRlcnByZXRlci5zdGVwT3V0XCIsIFtdLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0ZXBPdXQoKTtcclxuICAgICAgICAgICAgfSwgXCJTdGVwIG91dFwiLCB0aGlzLmNvbnRyb2xCdXR0b25zLiRidXR0b25TdGVwT3V0KTtcclxuXHJcbiAgICAgICAgYW0ucmVnaXN0ZXJBY3Rpb24oXCJpbnRlcnByZXRlci5yZXN0YXJ0XCIsIFtdLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3AodHJ1ZSk7XHJcbiAgICAgICAgICAgIH0sIFwiTmV1IHN0YXJ0ZW5cIiwgdGhpcy5jb250cm9sQnV0dG9ucy4kYnV0dG9uUmVzdGFydCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNldFN0YXRlKG9sZFN0YXRlOiBOVGhyZWFkUG9vbExzdGF0ZSwgc3RhdGU6IE5UaHJlYWRQb29sTHN0YXRlKSB7XHJcblxyXG4gICAgICAgIGlmIChzdGF0ZSA9PSBOVGhyZWFkUG9vbExzdGF0ZS5kb25lKSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE9cclxuICAgICAgICAgICAgLy8gdGhpcy5jbG9zZUFsbFdlYnNvY2tldHMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBhbSA9IHRoaXMubWFpbi5nZXRBY3Rpb25NYW5hZ2VyKCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGFjdGlvbklkIG9mIHRoaXMuYWN0aW9ucykge1xyXG4gICAgICAgICAgICBhbS5zZXRBY3RpdmUoXCJpbnRlcnByZXRlci5cIiArIGFjdGlvbklkLCB0aGlzLmJ1dHRvbkFjdGl2ZU1hdHJpeFthY3Rpb25JZF1bc3RhdGVdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBidXR0b25TdGFydEFjdGl2ZSA9IHRoaXMuYnV0dG9uQWN0aXZlTWF0cml4WydzdGFydCddW3N0YXRlXTtcclxuXHJcbiAgICAgICAgaWYgKGJ1dHRvblN0YXJ0QWN0aXZlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbEJ1dHRvbnMuJGJ1dHRvblN0YXJ0LnNob3coKTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sQnV0dG9ucy4kYnV0dG9uUGF1c2UuaGlkZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbEJ1dHRvbnMuJGJ1dHRvblN0YXJ0LmhpZGUoKTtcclxuICAgICAgICAgICAgdGhpcy5jb250cm9sQnV0dG9ucy4kYnV0dG9uUGF1c2Uuc2hvdygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGJ1dHRvblN0b3BBY3RpdmUgPSB0aGlzLmJ1dHRvbkFjdGl2ZU1hdHJpeFsnc3RvcCddW3N0YXRlXTtcclxuXHJcbiAgICAgICAgaWYgKHN0YXRlID09IE5UaHJlYWRQb29sTHN0YXRlLmRvbmUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMud29ybGRIZWxwZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53b3JsZEhlbHBlci5jbGVhckFjdG9yTGlzdHMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmduZ0VyZWlnbmlzYmVoYW5kbHVuZ0hlbHBlcj8uZGV0YWNoRXZlbnRzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob2xkU3RhdGUgIT0gTlRocmVhZFBvb2xMc3RhdGUuZG9uZSAmJiBzdGF0ZSA9PSBOVGhyZWFkUG9vbExzdGF0ZS5kb25lKSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE9cclxuICAgICAgICAgICAgLy8gdGhpcy5kZWJ1Z2dlci5kaXNhYmxlKCk7XHJcbiAgICAgICAgICAgIHRoaXMua2V5Ym9hcmRUb29sLnVuc3Vic2NyaWJlQWxsTGlzdGVuZXJzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoW05UaHJlYWRQb29sTHN0YXRlLnJ1bm5pbmcsIE5UaHJlYWRQb29sTHN0YXRlLnBhdXNlZF0uaW5kZXhPZihvbGRTdGF0ZSkgPCAwXHJcbiAgICAgICAgICAgICYmIHN0YXRlID09IE5UaHJlYWRQb29sTHN0YXRlLnJ1bm5pbmcpIHtcclxuICAgICAgICAgICAgLy8gVE9ET1xyXG4gICAgICAgICAgICAvLyAgIHRoaXMuZGVidWdnZXIuZW5hYmxlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBnZXRTdGFydGFibGVNb2R1bGUobW9kdWxlU3RvcmU6IE1vZHVsZVN0b3JlKTogTW9kdWxlIHtcclxuXHJcbiAgICAgICAgbGV0IGNlbTogTW9kdWxlO1xyXG4gICAgICAgIGNlbSA9IHRoaXMubWFpbi5nZXRDdXJyZW50bHlFZGl0ZWRNb2R1bGUoKTtcclxuXHJcbiAgICAgICAgbGV0IGN1cnJlbnRseUVkaXRlZE1vZHVsZUlzQ2xhc3NPbmx5ID0gZmFsc2U7XHJcblxyXG4gICAgICAgIC8vIGRlY2lkZSB3aGljaCBtb2R1bGUgdG8gc3RhcnRcclxuXHJcbiAgICAgICAgLy8gZmlyc3QgYXR0ZW1wdDogaXMgY3VycmVudGx5IGVkaXRlZCBNb2R1bGUgc3RhcnRhYmxlP1xyXG4gICAgICAgIGlmIChjZW0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBsZXQgY3VycmVudGx5RWRpdGVkTW9kdWxlID0gbW9kdWxlU3RvcmUuZmluZE1vZHVsZUJ5RmlsZShjZW0uZmlsZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50bHlFZGl0ZWRNb2R1bGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudGx5RWRpdGVkTW9kdWxlSXNDbGFzc09ubHkgPSAhY2VtLmhhc0Vycm9ycygpXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgIWN1cnJlbnRseUVkaXRlZE1vZHVsZS5pc1N0YXJ0YWJsZTtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50bHlFZGl0ZWRNb2R1bGUuaXNTdGFydGFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudGx5RWRpdGVkTW9kdWxlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBzZWNvbmQgYXR0ZW1wdDogd2hpY2ggbW9kdWxlIGhhcyBiZWVuIHN0YXJ0ZWQgbGFzdCB0aW1lP1xyXG4gICAgICAgIGlmICh0aGlzLm1haW5Nb2R1bGUgIT0gbnVsbCAmJiBjdXJyZW50bHlFZGl0ZWRNb2R1bGVJc0NsYXNzT25seSkge1xyXG4gICAgICAgICAgICBsZXQgbGFzdE1haW5Nb2R1bGUgPSBtb2R1bGVTdG9yZS5maW5kTW9kdWxlQnlGaWxlKHRoaXMubWFpbk1vZHVsZS5maWxlKTtcclxuICAgICAgICAgICAgaWYgKGxhc3RNYWluTW9kdWxlICE9IG51bGwgJiYgbGFzdE1haW5Nb2R1bGUuaXNTdGFydGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsYXN0TWFpbk1vZHVsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdGhpcmQgYXR0ZW1wdDogcGljayBmaXJzdCBzdGFydGFibGUgbW9kdWxlIG9mIGN1cnJlbnQgd29ya3NwYWNlXHJcbiAgICAgICAgaWYgKGN1cnJlbnRseUVkaXRlZE1vZHVsZUlzQ2xhc3NPbmx5KSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IG0gb2YgbW9kdWxlU3RvcmUuZ2V0TW9kdWxlcyhmYWxzZSkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtLmlzU3RhcnRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0UnVudGltZSgpIHtcclxuICAgICAgICB0aGlzLnByaW50TWFuYWdlci5jbGVhcigpO1xyXG4gICAgICAgIHRoaXMud29ybGRIZWxwZXI/LmRlc3Ryb3lXb3JsZCgpO1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc2luZ0hlbHBlcj8uZGVzdHJveVdvcmxkKCk7XHJcbiAgICAgICAgdGhpcy5nbmdFcmVpZ25pc2JlaGFuZGx1bmdIZWxwZXI/LmRldGFjaEV2ZW50cygpO1xyXG4gICAgICAgIHRoaXMuZ25nRXJlaWduaXNiZWhhbmRsdW5nSGVscGVyID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRUaW1lckNsYXNzKCk6IFRpbWVyQ2xhc3Mge1xyXG4gICAgICAgIGxldCBiYXNlTW9kdWxlID0gdGhpcy5tYWluLmdldEN1cnJlbnRXb3Jrc3BhY2UoKS5tb2R1bGVTdG9yZS5nZXRNb2R1bGUoXCJCYXNlIE1vZHVsZVwiKTtcclxuICAgICAgICByZXR1cm4gPFRpbWVyQ2xhc3M+YmFzZU1vZHVsZS50eXBlU3RvcmUuZ2V0VHlwZShcIlRpbWVyXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXQoKSB7XHJcblxyXG4gICAgICAgIHRoaXMubWFpbi5nZXRCb3R0b21EaXYoKT8uY29uc29sZT8uY2xlYXJFcnJvcnMoKTtcclxuXHJcbiAgICAgICAgbGV0IGNlbSA9IHRoaXMubWFpbi5nZXRDdXJyZW50bHlFZGl0ZWRNb2R1bGUoKTtcclxuXHJcbiAgICAgICAgY2VtLmdldEJyZWFrcG9pbnRQb3NpdGlvbnNGcm9tRWRpdG9yKCk7XHJcblxyXG4gICAgICAgIHRoaXMubWFpbi5nZXRCb3R0b21EaXYoKT8uY29uc29sZT8uY2xlYXJFeGNlcHRpb25zKCk7XHJcblxyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIEFzIGxvbmcgYXMgdGhlcmUgaXMgbm8gc3RhcnRhYmxlIG5ldyBWZXJzaW9uIG9mIGN1cnJlbnQgd29ya3NwYWNlIHdlIGtlZXAgY3VycmVudCBjb21waWxlZCBtb2R1bGVzIHNvXHJcbiAgICAgICAgICAgIHRoYXQgdmFyaWFibGVzIGFuZCBvYmplY3RzIGRlZmluZWQvaW5zdGFudGlhdGVkIHZpYSBjb25zb2xlIGNhbiBiZSBrZXB0LCB0b28uIFxyXG4gICAgICAgICovXHJcbiAgICAgICAgaWYgKHRoaXMubW9kdWxlU3RvcmVWZXJzaW9uICE9IHRoaXMubWFpbi52ZXJzaW9uICYmIHRoaXMubWFpbi5nZXRDb21waWxlcigpLmF0TGVhc3RPbmVNb2R1bGVJc1N0YXJ0YWJsZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1haW4uY29weUV4ZWN1dGFibGVNb2R1bGVTdG9yZVRvSW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5tYWluLmdldEJvdHRvbURpdigpPy5jb25zb2xlPy5kZXRhY2hWYWx1ZXMoKTsgIC8vIGRldGFjaCB2YWx1ZXMgZnJvbSBjb25zb2xlIGVudHJpZXNcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBuZXdNYWluTW9kdWxlID0gdGhpcy5nZXRTdGFydGFibGVNb2R1bGUodGhpcy5tb2R1bGVTdG9yZSk7XHJcblxyXG4gICAgICAgIGlmIChuZXdNYWluTW9kdWxlID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy50aHJlYWRQb29sLnNldFN0YXRlKE5UaHJlYWRQb29sTHN0YXRlLm5vdF9pbml0aWFsaXplZCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubWFpbk1vZHVsZSA9IG5ld01haW5Nb2R1bGU7XHJcblxyXG4gICAgICAgIHRoaXMudGhyZWFkUG9vbC5pbml0KHRoaXMubW9kdWxlU3RvcmUsIHRoaXMubWFpbk1vZHVsZSk7XHJcbiAgICAgICAgdGhpcy50aHJlYWRQb29sLnNldFN0YXRlKE5UaHJlYWRQb29sTHN0YXRlLmRvbmUpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBoaWRlUHJvZ3JhbXBvaW50ZXJQb3NpdGlvbigpIHtcclxuXHJcbiAgICAgICAgdGhpcy5tYWluLmhpZGVQcm9ncmFtUG9pbnRlclBvc2l0aW9uKCk7XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=