import { DiagramElement, Alignment } from "../DiagramElement.js";
import { Klass, Visibility, Interface } from "../../../../compiler/types/Class.js";
import { getDeclarationAsString, getTypeIdentifier } from "../../../../compiler/types/DeclarationHelper.js";
import { hash } from "../../../../tools/StringTools.js";
export class ClassBox extends DiagramElement {
    constructor(diagram, leftCm, topCm, klass) {
        super(diagram.svgElement);
        this.diagram = diagram;
        this.active = true;
        this.withMethods = true;
        this.withAttributes = true;
        this.klass = klass;
        if (klass != null) {
            this.attachToClass(this.klass);
            this.isSystemClass = klass.module.isSystemModule;
            this.withAttributes = false; //!this.isSystemClass;
            this.withMethods = false; // !this.isSystemClass;
        }
        this.moveTo(leftCm, topCm, true);
    }
    serialize() {
        return {
            className: this.className,
            filename: this.filename,
            hashedSignature: this.hashedSignature,
            withAttributes: this.withAttributes,
            withMethods: this.withMethods,
            isSystemClass: this.isSystemClass,
            leftCm: this.leftCm,
            topCm: this.topCm
        };
    }
    static deserialize(diagram, scb) {
        let cb = new ClassBox(diagram, scb.leftCm, scb.topCm, null);
        cb.hashedSignature = scb.hashedSignature;
        cb.className = scb.className;
        cb.filename = scb.filename;
        cb.withAttributes = scb.withAttributes;
        cb.withMethods = scb.withMethods;
        cb.isSystemClass = scb.isSystemClass;
        return cb;
    }
    attachToClass(klass) {
        this.klass = klass;
        let klassSignature = this.getSignature(klass);
        if (this.className != klass.identifier || this.hashedSignature != klassSignature || this.widthCm < 0.7 || this.documentation != klass.documentation) {
            this.isSystemClass = klass.module.isSystemModule;
            this.renderLines();
        }
        else {
            this.addMouseEvents();
        }
        this.className = klass.identifier;
        this.filename = klass.module.file.name;
        this.hashedSignature = klassSignature;
        this.documentation = klass.documentation;
    }
    jumpToDeclaration(element) {
        this.diagram.main.jumpToDeclaration(this.klass.module, element.declaration);
    }
    renderLines() {
        this.clear();
        let parametersWithTypes = this.diagram.currentClassBoxes.parametersWithTypes;
        this.addTextLine({
            type: "text",
            text: (this.klass instanceof Interface ? "<<interface>> " : (this.klass.isAbstract ? "<<abstract>> " : "")) + this.klass.identifier,
            tooltip: getDeclarationAsString(this.klass, "", true),
            alignment: Alignment.center,
            bold: true,
            italics: this.klass instanceof Interface || this.klass.isAbstract,
            onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(this.klass); }
        });
        if (this.klass instanceof Klass && this.withAttributes) {
            this.addTextLine({
                type: "line",
                thicknessCm: 0.05
            });
            for (let a of this.klass.attributes) {
                let text = this.getVisibilityText(a.visibility) + getTypeIdentifier(a.type) + " " + a.identifier;
                this.addTextLine({
                    type: "text",
                    text: text,
                    tooltip: getDeclarationAsString(a),
                    alignment: Alignment.left,
                    onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(a); }
                });
            }
        }
        if (this.withMethods) {
            this.addTextLine({
                type: "line",
                thicknessCm: 0.05
            });
            this.klass.methods.filter(m => m.signature != "toJson()").forEach(m => {
                let text = this.getVisibilityText(m.visibility) + m.identifier + "()";
                if (parametersWithTypes) {
                    let returnType = m.isConstructor ? "" :
                        (m.returnType == null ? "void " : getTypeIdentifier(m.returnType) + " ");
                    text = this.getVisibilityText(m.visibility) + returnType + m.identifier + "(" +
                        m.parameterlist.parameters.map((p) => { return getTypeIdentifier(p.type) + " " + p.identifier; }).join(", ") + ")";
                }
                this.addTextLine({
                    type: "text",
                    text: text,
                    tooltip: getDeclarationAsString(m),
                    alignment: Alignment.left,
                    italics: this.klass instanceof Interface || m.isAbstract,
                    onClick: this.isSystemClass ? undefined : () => { this.jumpToDeclaration(m); }
                });
            });
        }
        this.backgroundColor = this.isSystemClass ? "#aaaaaa" : "#ffffff";
        this.render();
        this.$dropdownTriangle = this.createElement("path", this.$element[0], {
            d: this.getTrianglePath(),
            class: "dropdown-triangle",
            style: "transform: " + "translate(" + (this.widthCm - 0.35) + "cm,0.05cm)", // + (<TextLine>this.lines[0]).textHeightCm + "cm)"
        });
        this.addMouseEvents();
    }
    getTrianglePath() {
        if (this.withMethods) {
            return "M 0 8 L 11 8 L 5.5 2 L 0 8";
        }
        else {
            return "M 0 2 L 11 2 L 5.5 8 L 0 2";
        }
        // if (this.withMethods) {
        //     return "M 3 6 L 11 6 L 7 2 L 3 6";
        // } else {
        //     return "M 3 2 L 11 2 L 7 6 L 3 2";
        // }
    }
    detach() {
        var _a;
        (_a = this.$element) === null || _a === void 0 ? void 0 : _a.off('mousedown.diagramElement');
        jQuery(document).off('mouseup.diagramElement');
        jQuery(document).off('mousemove.diagramElement');
        super.detach();
    }
    addMouseEvents() {
        let that = this;
        if (this.$dropdownTriangle != null) {
            this.$dropdownTriangle.off("mouseup.dropdowntriangle");
            this.$dropdownTriangle.off("mousedown.dropdowntriangle");
        }
        this.$dropdownTriangle.on("mousedown.dropdowntriangle", (e) => {
            e.stopPropagation();
        });
        this.$dropdownTriangle.on("mouseup.dropdowntriangle", (e) => {
            e.stopPropagation();
            this.withMethods = !this.withMethods;
            this.withAttributes = !this.withAttributes;
            this.$dropdownTriangle.attr("d", this.getTrianglePath());
            this.renderLines();
            this.diagram.adjustClassDiagramSize();
            this.diagram.updateArrows();
        });
        this.$element.on('mousedown.diagramElement', (event) => {
            event.stopPropagation();
            event.stopImmediatePropagation();
            if (event.button != 0)
                return;
            let x = event.screenX;
            let y = event.screenY;
            that.$element.find('rect').addClass('dragging');
            jQuery(document).off('mouseup.diagramElement');
            jQuery(document).off('mousemove.diagramElement');
            jQuery(document).on('mousemove.diagramElement', (event) => {
                let cmPerPixel = 1 / 96 * 2.36 / this.diagram.zoomfactor;
                let dx = (event.screenX - x) * cmPerPixel;
                let dy = (event.screenY - y) * cmPerPixel;
                x = event.screenX;
                y = event.screenY;
                that.move(dx, dy, true);
                clearTimeout(that.inDebounce);
                that.inDebounce = setTimeout(() => {
                    let classDiagram = that.diagram;
                    classDiagram.updateArrows();
                }, 200);
            });
            jQuery(document).on('mouseup.diagramElement', () => {
                that.move(0, 0, true, true);
                let classDiagram = that.diagram;
                classDiagram.adjustClassDiagramSize();
                classDiagram.updateArrows();
                that.$element.find('rect').removeClass('dragging');
                jQuery(document).off('mouseup.diagramElement');
                jQuery(document).off('mousemove.diagramElement');
                classDiagram.dirty = true;
            });
        });
    }
    getVisibilityText(visibility) {
        switch (visibility) {
            case Visibility.private: return "-";
            case Visibility.protected: return "#";
            case Visibility.public: return "+";
        }
    }
    getSignature(klass) {
        let s = "";
        if (klass instanceof Klass && this.withAttributes && klass.attributes.length > 0) {
            for (let a of klass.attributes)
                s += this.getVisibilityText(a.visibility) + a.type.identifier + " " + a.identifier;
        }
        if (this.withMethods && klass.methods.length > 0) {
            for (let m of klass.methods) {
                if (m.isConstructor)
                    continue;
                let rt = m.returnType == null ? "void" : m.returnType.identifier;
                s += this.getVisibilityText(m.visibility) + rt + " " + m.identifier + "(" +
                    m.parameterlist.parameters.map((p) => { return p.type.identifier + " " + p.identifier; }).join(", ") + ")";
            }
        }
        return hash(s);
    }
    hasSignatureAndFileOf(klass) {
        return klass.module.file.name == this.filename &&
            this.getSignature(klass) == this.hashedSignature;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xhc3NCb3guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY2xpZW50L21haW4vZ3VpL2RpYWdyYW1zL2NsYXNzZGlhZ3JhbS9DbGFzc0JveC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ25GLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBSzVHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQWV4RCxNQUFNLE9BQU8sUUFBUyxTQUFRLGNBQWM7SUFpQnhDLFlBQW1CLE9BQWdCLEVBQUUsTUFBYyxFQUFFLEtBQWEsRUFBRSxLQUF3QjtRQUN4RixLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRFgsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQVZuQyxXQUFNLEdBQVksSUFBSSxDQUFDO1FBQ3ZCLGdCQUFXLEdBQVksSUFBSSxDQUFDO1FBQzVCLG1CQUFjLEdBQVksSUFBSSxDQUFDO1FBVzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtZQUNmLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUM7WUFDakQsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsQ0FBQyxzQkFBc0I7WUFDbkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQyx1QkFBdUI7U0FDcEQ7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFD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QUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxHQUFHLEdBQUc7b0JBQ3JFLENBQUMsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7YUFDakg7U0FDSjtRQUVELE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5CLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxLQUF3QjtRQUMxQyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUTtZQUMxQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDekQsQ0FBQztDQUlKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlhZ3JhbUVsZW1lbnQsIEFsaWdubWVudCB9IGZyb20gXCIuLi9EaWFncmFtRWxlbWVudC5qc1wiO1xyXG5pbXBvcnQgeyBLbGFzcywgVmlzaWJpbGl0eSwgSW50ZXJmYWNlIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBpbGVyL3R5cGVzL0NsYXNzLmpzXCI7XHJcbmltcG9ydCB7IGdldERlY2xhcmF0aW9uQXNTdHJpbmcsIGdldFR5cGVJZGVudGlmaWVyIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbXBpbGVyL3R5cGVzL0RlY2xhcmF0aW9uSGVscGVyLmpzXCI7XHJcbmltcG9ydCB7IERpYWdyYW0gfSBmcm9tIFwiLi4vRGlhZ3JhbS5qc1wiO1xyXG5pbXBvcnQgeyBQb2ludCB9IGZyb20gXCIuL1JvdXRlci5qc1wiO1xyXG5pbXBvcnQgeyBDbGFzc0RpYWdyYW0gfSBmcm9tIFwiLi9DbGFzc0RpYWdyYW0uanNcIjtcclxuaW1wb3J0IHsgVGV4dExpbmUgfSBmcm9tIFwiLi4vRGlhZ3JhbUVsZW1lbnQuanNcIjtcclxuaW1wb3J0IHsgaGFzaCB9IGZyb20gXCIuLi8uLi8uLi8uLi90b29scy9TdHJpbmdUb29scy5qc1wiO1xyXG5pbXBvcnQgeyBNZXRob2QsIEF0dHJpYnV0ZSB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21waWxlci90eXBlcy9UeXBlcy5qc1wiO1xyXG5cclxuZXhwb3J0IHR5cGUgU2VyaWFsaXplZENsYXNzQm94ID0ge1xyXG4gICAgY2xhc3NOYW1lOiBzdHJpbmcsXHJcbiAgICBmaWxlbmFtZTogc3RyaW5nLFxyXG4gICAgaGFzaGVkU2lnbmF0dXJlOiBudW1iZXIsXHJcbiAgICB3aXRoTWV0aG9kczogYm9vbGVhbixcclxuICAgIHdpdGhBdHRyaWJ1dGVzOiBib29sZWFuLFxyXG4gICAgbGVmdENtOiBudW1iZXIsXHJcbiAgICB0b3BDbTogbnVtYmVyLFxyXG4gICAgaXNTeXN0ZW1DbGFzczogYm9vbGVhbixcclxuICAgIHdvcmtzcGFjZUlkPzogbnVtYmVyXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDbGFzc0JveCBleHRlbmRzIERpYWdyYW1FbGVtZW50IHtcclxuXHJcbiAgICBjbGFzc05hbWU6IHN0cmluZztcclxuICAgIGtsYXNzOiBLbGFzcyB8IEludGVyZmFjZTtcclxuICAgIGZpbGVuYW1lOiBzdHJpbmc7XHJcbiAgICBoYXNoZWRTaWduYXR1cmU6IG51bWJlcjtcclxuICAgIGRvY3VtZW50YXRpb246IHN0cmluZztcclxuICAgIGFjdGl2ZTogYm9vbGVhbiA9IHRydWU7XHJcbiAgICB3aXRoTWV0aG9kczogYm9vbGVhbiA9IHRydWU7XHJcbiAgICB3aXRoQXR0cmlidXRlczogYm9vbGVhbiA9IHRydWU7XHJcblxyXG4gICAgaW5EZWJvdW5jZTogYW55O1xyXG5cclxuICAgIGlzU3lzdGVtQ2xhc3M6IGJvb2xlYW47XHJcblxyXG4gICAgJGRyb3Bkb3duVHJpYW5nbGU6IEpRdWVyeTxFbGVtZW50PjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgZGlhZ3JhbTogRGlhZ3JhbSwgbGVmdENtOiBudW1iZXIsIHRvcENtOiBudW1iZXIsIGtsYXNzOiBLbGFzcyB8IEludGVyZmFjZSkge1xyXG4gICAgICAgIHN1cGVyKGRpYWdyYW0uc3ZnRWxlbWVudCk7XHJcblxyXG4gICAgICAgIHRoaXMua2xhc3MgPSBrbGFzcztcclxuXHJcbiAgICAgICAgaWYgKGtsYXNzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5hdHRhY2hUb0NsYXNzKHRoaXMua2xhc3MpO1xyXG4gICAgICAgICAgICB0aGlzLmlzU3lzdGVtQ2xhc3MgPSBrbGFzcy5tb2R1bGUuaXNTeXN0ZW1Nb2R1bGU7XHJcbiAgICAgICAgICAgIHRoaXMud2l0aEF0dHJpYnV0ZXMgPSBmYWxzZTsgLy8hdGhpcy5pc1N5c3RlbUNsYXNzO1xyXG4gICAgICAgICAgICB0aGlzLndpdGhNZXRob2RzID0gZmFsc2U7IC8vICF0aGlzLmlzU3lzdGVtQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLm1vdmVUbyhsZWZ0Q20sIHRvcENtLCB0cnVlKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2VyaWFsaXplKCk6IFNlcmlhbGl6ZWRDbGFzc0JveCB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY2xhc3NOYW1lOiB0aGlzLmNsYXNzTmFtZSxcclxuICAgICAgICAgICAgZmlsZW5hbWU6IHRoaXMuZmlsZW5hbWUsXHJcbiAgICAgICAgICAgIGhhc2hlZFNpZ25hdHVyZTogdGhpcy5oYXNoZWRTaWduYXR1cmUsXHJcbiAgICAgICAgICAgIHdpdGhBdHRyaWJ1dGVzOiB0aGlzLndpdGhBdHRyaWJ1dGVzLFxyXG4gICAgICAgICAgICB3aXRoTWV0aG9kczogdGhpcy53aXRoTWV0aG9kcyxcclxuICAgICAgICAgICAgaXNTeXN0ZW1DbGFzczogdGhpcy5pc1N5c3RlbUNsYXNzLFxyXG4gICAgICAgICAgICBsZWZ0Q206IHRoaXMubGVmdENtLFxyXG4gICAgICAgICAgICB0b3BDbTogdGhpcy50b3BDbVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGlhZ3JhbTogRGlhZ3JhbSwgc2NiOiBTZXJpYWxpemVkQ2xhc3NCb3gpOiBDbGFzc0JveCB7XHJcblxyXG4gICAgICAgIGxldCBjYiA9IG5ldyBDbGFzc0JveChkaWFncmFtLCBzY2IubGVmdENtLCBzY2IudG9wQ20sIG51bGwpO1xyXG4gICAgICAgIGNiLmhhc2hlZFNpZ25hdHVyZSA9IHNjYi5oYXNoZWRTaWduYXR1cmU7XHJcbiAgICAgICAgY2IuY2xhc3NOYW1lID0gc2NiLmNsYXNzTmFtZTtcclxuICAgICAgICBjYi5maWxlbmFtZSA9IHNjYi5maWxlbmFtZTtcclxuICAgICAgICBjYi53aXRoQXR0cmlidXRlcyA9IHNjYi53aXRoQXR0cmlidXRlcztcclxuICAgICAgICBjYi53aXRoTWV0aG9kcyA9IHNjYi53aXRoTWV0aG9kcztcclxuICAgICAgICBjYi5pc1N5c3RlbUNsYXNzID0gc2NiLmlzU3lzdGVtQ2xhc3M7XHJcblxyXG4gICAgICAgIHJldHVybiBjYjtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgYXR0YWNoVG9DbGFzcyhrbGFzczogS2xhc3MgfCBJbnRlcmZhY2UpIHtcclxuXHJcbiAgICAgICAgdGhpcy5rbGFzcyA9IGtsYXNzO1xyXG4gICAgICAgIGxldCBrbGFzc1NpZ25hdHVyZTogbnVtYmVyID0gdGhpcy5nZXRTaWduYXR1cmUoa2xhc3MpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUgIT0ga2xhc3MuaWRlbnRpZmllciB8fCB0aGlzLmhhc2hlZFNpZ25hdHVyZSAhPSBrbGFzc1NpZ25hdHVyZSB8fCB0aGlzLndpZHRoQ20gPCAwLjcgfHwgdGhpcy5kb2N1bWVudGF0aW9uICE9IGtsYXNzLmRvY3VtZW50YXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5pc1N5c3RlbUNsYXNzID0ga2xhc3MubW9kdWxlLmlzU3lzdGVtTW9kdWxlO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlckxpbmVzKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRNb3VzZUV2ZW50cygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5jbGFzc05hbWUgPSBrbGFzcy5pZGVudGlmaWVyO1xyXG4gICAgICAgIHRoaXMuZmlsZW5hbWUgPSBrbGFzcy5tb2R1bGUuZmlsZS5uYW1lO1xyXG4gICAgICAgIHRoaXMuaGFzaGVkU2lnbmF0dXJlID0ga2xhc3NTaWduYXR1cmU7XHJcbiAgICAgICAgdGhpcy5kb2N1bWVudGF0aW9uID0ga2xhc3MuZG9jdW1lbnRhdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBqdW1wVG9EZWNsYXJhdGlvbihlbGVtZW50OiBLbGFzcyB8IEludGVyZmFjZSB8IE1ldGhvZCB8IEF0dHJpYnV0ZSkge1xyXG4gICAgICAgIHRoaXMuZGlhZ3JhbS5tYWluLmp1bXBUb0RlY2xhcmF0aW9uKHRoaXMua2xhc3MubW9kdWxlLCBlbGVtZW50LmRlY2xhcmF0aW9uKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVuZGVyTGluZXMoKSB7XHJcblxyXG4gICAgICAgIHRoaXMuY2xlYXIoKTtcclxuXHJcbiAgICAgICAgbGV0IHBhcmFtZXRlcnNXaXRoVHlwZXMgPSAoPENsYXNzRGlhZ3JhbT50aGlzLmRpYWdyYW0pLmN1cnJlbnRDbGFzc0JveGVzLnBhcmFtZXRlcnNXaXRoVHlwZXM7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkVGV4dExpbmUoe1xyXG4gICAgICAgICAgICB0eXBlOiBcInRleHRcIixcclxuICAgICAgICAgICAgdGV4dDogKHRoaXMua2xhc3MgaW5zdGFuY2VvZiBJbnRlcmZhY2UgPyBcIjw8aW50ZXJmYWNlPj4gXCIgOiAoIHRoaXMua2xhc3MuaXNBYnN0cmFjdCA/IFwiPDxhYnN0cmFjdD4+IFwiIDogXCJcIikpICsgdGhpcy5rbGFzcy5pZGVudGlmaWVyLFxyXG4gICAgICAgICAgICB0b29sdGlwOiBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKHRoaXMua2xhc3MsIFwiXCIsIHRydWUpLFxyXG4gICAgICAgICAgICBhbGlnbm1lbnQ6IEFsaWdubWVudC5jZW50ZXIsXHJcbiAgICAgICAgICAgIGJvbGQ6IHRydWUsXHJcbiAgICAgICAgICAgIGl0YWxpY3M6IHRoaXMua2xhc3MgaW5zdGFuY2VvZiBJbnRlcmZhY2UgfHwgdGhpcy5rbGFzcy5pc0Fic3RyYWN0LFxyXG4gICAgICAgICAgICBvbkNsaWNrOiB0aGlzLmlzU3lzdGVtQ2xhc3MgPyB1bmRlZmluZWQgOiAoKSA9PiB7IHRoaXMuanVtcFRvRGVjbGFyYXRpb24odGhpcy5rbGFzcykgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5rbGFzcyBpbnN0YW5jZW9mIEtsYXNzICYmIHRoaXMud2l0aEF0dHJpYnV0ZXMpIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRUZXh0TGluZSh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImxpbmVcIixcclxuICAgICAgICAgICAgICAgIHRoaWNrbmVzc0NtOiAwLjA1XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBhIG9mIHRoaXMua2xhc3MuYXR0cmlidXRlcykge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB0ZXh0OiBzdHJpbmcgPSB0aGlzLmdldFZpc2liaWxpdHlUZXh0KGEudmlzaWJpbGl0eSkgKyBnZXRUeXBlSWRlbnRpZmllcihhLnR5cGUpICsgXCIgXCIgKyAgYS5pZGVudGlmaWVyO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkVGV4dExpbmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcDogZ2V0RGVjbGFyYXRpb25Bc1N0cmluZyhhKSxcclxuICAgICAgICAgICAgICAgICAgICBhbGlnbm1lbnQ6IEFsaWdubWVudC5sZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMuaXNTeXN0ZW1DbGFzcyA/IHVuZGVmaW5lZCA6ICgpID0+IHsgdGhpcy5qdW1wVG9EZWNsYXJhdGlvbihhKSB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMud2l0aE1ldGhvZHMpIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRUZXh0TGluZSh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBcImxpbmVcIixcclxuICAgICAgICAgICAgICAgIHRoaWNrbmVzc0NtOiAwLjA1XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmtsYXNzLm1ldGhvZHMuZmlsdGVyKG0gPT4gbS5zaWduYXR1cmUgIT0gXCJ0b0pzb24oKVwiKS5mb3JFYWNoKG0gPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRleHQ6IHN0cmluZyA9IHRoaXMuZ2V0VmlzaWJpbGl0eVRleHQobS52aXNpYmlsaXR5KSArIG0uaWRlbnRpZmllciArIFwiKClcIjtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVyc1dpdGhUeXBlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXR1cm5UeXBlOiBzdHJpbmcgPSBtLmlzQ29uc3RydWN0b3IgPyBcIlwiIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgKG0ucmV0dXJuVHlwZSA9PSBudWxsID8gXCJ2b2lkIFwiIDogZ2V0VHlwZUlkZW50aWZpZXIobS5yZXR1cm5UeXBlKSArIFwiIFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGhpcy5nZXRWaXNpYmlsaXR5VGV4dChtLnZpc2liaWxpdHkpICsgcmV0dXJuVHlwZSArIG0uaWRlbnRpZmllciArIFwiKFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbS5wYXJhbWV0ZXJsaXN0LnBhcmFtZXRlcnMubWFwKChwKSA9PiB7IHJldHVybiBnZXRUeXBlSWRlbnRpZmllcihwLnR5cGUpICsgXCIgXCIgKyBwLmlkZW50aWZpZXIgfSkuam9pbihcIiwgXCIpICsgXCIpXCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5hZGRUZXh0TGluZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogdGV4dCxcclxuICAgICAgICAgICAgICAgICAgICB0b29sdGlwOiBnZXREZWNsYXJhdGlvbkFzU3RyaW5nKG0pLFxyXG4gICAgICAgICAgICAgICAgICAgIGFsaWdubWVudDogQWxpZ25tZW50LmxlZnQsXHJcbiAgICAgICAgICAgICAgICAgICAgaXRhbGljczogdGhpcy5rbGFzcyBpbnN0YW5jZW9mIEludGVyZmFjZSB8fCBtLmlzQWJzdHJhY3QsXHJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljazogdGhpcy5pc1N5c3RlbUNsYXNzID8gdW5kZWZpbmVkIDogKCkgPT4geyB0aGlzLmp1bXBUb0RlY2xhcmF0aW9uKG0pIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9IHRoaXMuaXNTeXN0ZW1DbGFzcyA/IFwiI2FhYWFhYVwiIDogXCIjZmZmZmZmXCI7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIoKTtcclxuXHJcbiAgICAgICAgdGhpcy4kZHJvcGRvd25UcmlhbmdsZSA9IHRoaXMuY3JlYXRlRWxlbWVudChcInBhdGhcIiwgdGhpcy4kZWxlbWVudFswXSwge1xyXG4gICAgICAgICAgICBkOiB0aGlzLmdldFRyaWFuZ2xlUGF0aCgpLFxyXG4gICAgICAgICAgICBjbGFzczogXCJkcm9wZG93bi10cmlhbmdsZVwiLFxyXG4gICAgICAgICAgICBzdHlsZTogXCJ0cmFuc2Zvcm06IFwiICsgXCJ0cmFuc2xhdGUoXCIgKyAodGhpcy53aWR0aENtIC0gMC4zNSkgKyBcImNtLDAuMDVjbSlcIiwgLy8gKyAoPFRleHRMaW5lPnRoaXMubGluZXNbMF0pLnRleHRIZWlnaHRDbSArIFwiY20pXCJcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICB0aGlzLmFkZE1vdXNlRXZlbnRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VHJpYW5nbGVQYXRoKCkge1xyXG4gICAgICAgIGlmICh0aGlzLndpdGhNZXRob2RzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIk0gMCA4IEwgMTEgOCBMIDUuNSAyIEwgMCA4XCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiTSAwIDIgTCAxMSAyIEwgNS41IDggTCAwIDJcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gaWYgKHRoaXMud2l0aE1ldGhvZHMpIHtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIFwiTSAzIDYgTCAxMSA2IEwgNyAyIEwgMyA2XCI7XHJcbiAgICAgICAgLy8gfSBlbHNlIHtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIFwiTSAzIDIgTCAxMSAyIEwgNyA2IEwgMyAyXCI7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgfVxyXG5cclxuICAgIGRldGFjaCgpIHtcclxuICAgICAgICB0aGlzLiRlbGVtZW50Py5vZmYoJ21vdXNlZG93bi5kaWFncmFtRWxlbWVudCcpO1xyXG4gICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZXVwLmRpYWdyYW1FbGVtZW50Jyk7XHJcbiAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ21vdXNlbW92ZS5kaWFncmFtRWxlbWVudCcpO1xyXG4gICAgICAgIHN1cGVyLmRldGFjaCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZE1vdXNlRXZlbnRzKCkge1xyXG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLiRkcm9wZG93blRyaWFuZ2xlLm9mZihcIm1vdXNldXAuZHJvcGRvd250cmlhbmdsZVwiKTtcclxuICAgICAgICAgICAgdGhpcy4kZHJvcGRvd25UcmlhbmdsZS5vZmYoXCJtb3VzZWRvd24uZHJvcGRvd250cmlhbmdsZVwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUub24oXCJtb3VzZWRvd24uZHJvcGRvd250cmlhbmdsZVwiLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUub24oXCJtb3VzZXVwLmRyb3Bkb3dudHJpYW5nbGVcIiwgKGUpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgdGhpcy53aXRoTWV0aG9kcyA9ICF0aGlzLndpdGhNZXRob2RzO1xyXG4gICAgICAgICAgICB0aGlzLndpdGhBdHRyaWJ1dGVzID0gIXRoaXMud2l0aEF0dHJpYnV0ZXM7XHJcbiAgICAgICAgICAgIHRoaXMuJGRyb3Bkb3duVHJpYW5nbGUuYXR0cihcImRcIiwgdGhpcy5nZXRUcmlhbmdsZVBhdGgoKSk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyTGluZXMoKTtcclxuICAgICAgICAgICAgKDxDbGFzc0RpYWdyYW0+PGFueT50aGlzLmRpYWdyYW0pLmFkanVzdENsYXNzRGlhZ3JhbVNpemUoKTtcclxuICAgICAgICAgICAgKDxDbGFzc0RpYWdyYW0+PGFueT50aGlzLmRpYWdyYW0pLnVwZGF0ZUFycm93cygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLiRlbGVtZW50Lm9uKCdtb3VzZWRvd24uZGlhZ3JhbUVsZW1lbnQnLCAoZXZlbnQ6IEpRdWVyeS5Nb3VzZURvd25FdmVudCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LmJ1dHRvbiAhPSAwKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBsZXQgeCA9IGV2ZW50LnNjcmVlblg7XHJcbiAgICAgICAgICAgIGxldCB5ID0gZXZlbnQuc2NyZWVuWTtcclxuXHJcbiAgICAgICAgICAgIHRoYXQuJGVsZW1lbnQuZmluZCgncmVjdCcpLmFkZENsYXNzKCdkcmFnZ2luZycpO1xyXG5cclxuICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ21vdXNldXAuZGlhZ3JhbUVsZW1lbnQnKTtcclxuICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ21vdXNlbW92ZS5kaWFncmFtRWxlbWVudCcpO1xyXG5cclxuICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vbignbW91c2Vtb3ZlLmRpYWdyYW1FbGVtZW50JywgKGV2ZW50OiBKUXVlcnkuTW91c2VNb3ZlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBjbVBlclBpeGVsID0gMSAvIDk2ICogMi4zNiAvIHRoaXMuZGlhZ3JhbS56b29tZmFjdG9yO1xyXG4gICAgICAgICAgICAgICAgbGV0IGR4ID0gKGV2ZW50LnNjcmVlblggLSB4KSAqIGNtUGVyUGl4ZWw7XHJcbiAgICAgICAgICAgICAgICBsZXQgZHkgPSAoZXZlbnQuc2NyZWVuWSAtIHkpICogY21QZXJQaXhlbDtcclxuXHJcbiAgICAgICAgICAgICAgICB4ID0gZXZlbnQuc2NyZWVuWDtcclxuICAgICAgICAgICAgICAgIHkgPSBldmVudC5zY3JlZW5ZO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoYXQubW92ZShkeCwgZHksIHRydWUpO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhhdC5pbkRlYm91bmNlKTtcclxuICAgICAgICAgICAgICAgIHRoYXQuaW5EZWJvdW5jZSA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjbGFzc0RpYWdyYW0gPSA8Q2xhc3NEaWFncmFtPjxhbnk+dGhhdC5kaWFncmFtO1xyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzRGlhZ3JhbS51cGRhdGVBcnJvd3MoKTtcclxuICAgICAgICAgICAgICAgIH0sIDIwMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vbignbW91c2V1cC5kaWFncmFtRWxlbWVudCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoYXQubW92ZSgwLCAwLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGxldCBjbGFzc0RpYWdyYW0gPSA8Q2xhc3NEaWFncmFtPjxhbnk+dGhhdC5kaWFncmFtO1xyXG4gICAgICAgICAgICAgICAgY2xhc3NEaWFncmFtLmFkanVzdENsYXNzRGlhZ3JhbVNpemUoKTtcclxuICAgICAgICAgICAgICAgIGNsYXNzRGlhZ3JhbS51cGRhdGVBcnJvd3MoKTtcclxuICAgICAgICAgICAgICAgIHRoYXQuJGVsZW1lbnQuZmluZCgncmVjdCcpLnJlbW92ZUNsYXNzKCdkcmFnZ2luZycpO1xyXG4gICAgICAgICAgICAgICAgalF1ZXJ5KGRvY3VtZW50KS5vZmYoJ21vdXNldXAuZGlhZ3JhbUVsZW1lbnQnKTtcclxuICAgICAgICAgICAgICAgIGpRdWVyeShkb2N1bWVudCkub2ZmKCdtb3VzZW1vdmUuZGlhZ3JhbUVsZW1lbnQnKTtcclxuICAgICAgICAgICAgICAgIGNsYXNzRGlhZ3JhbS5kaXJ0eSA9IHRydWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBnZXRWaXNpYmlsaXR5VGV4dCh2aXNpYmlsaXR5OiBWaXNpYmlsaXR5KSB7XHJcbiAgICAgICAgc3dpdGNoICh2aXNpYmlsaXR5KSB7XHJcbiAgICAgICAgICAgIGNhc2UgVmlzaWJpbGl0eS5wcml2YXRlOiByZXR1cm4gXCItXCI7XHJcbiAgICAgICAgICAgIGNhc2UgVmlzaWJpbGl0eS5wcm90ZWN0ZWQ6IHJldHVybiBcIiNcIjtcclxuICAgICAgICAgICAgY2FzZSBWaXNpYmlsaXR5LnB1YmxpYzogcmV0dXJuIFwiK1wiO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTaWduYXR1cmUoa2xhc3M6IEtsYXNzIHwgSW50ZXJmYWNlKTogbnVtYmVyIHtcclxuXHJcbiAgICAgICAgbGV0IHM6IHN0cmluZyA9IFwiXCI7XHJcblxyXG4gICAgICAgIGlmIChrbGFzcyBpbnN0YW5jZW9mIEtsYXNzICYmIHRoaXMud2l0aEF0dHJpYnV0ZXMgJiYga2xhc3MuYXR0cmlidXRlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGEgb2Yga2xhc3MuYXR0cmlidXRlcykgcyArPSB0aGlzLmdldFZpc2liaWxpdHlUZXh0KGEudmlzaWJpbGl0eSkgKyBhLnR5cGUuaWRlbnRpZmllciArIFwiIFwiICsgYS5pZGVudGlmaWVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMud2l0aE1ldGhvZHMgJiYga2xhc3MubWV0aG9kcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IG0gb2Yga2xhc3MubWV0aG9kcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKG0uaXNDb25zdHJ1Y3RvcikgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgcnQ6IHN0cmluZyA9IG0ucmV0dXJuVHlwZSA9PSBudWxsID8gXCJ2b2lkXCIgOiBtLnJldHVyblR5cGUuaWRlbnRpZmllcjtcclxuICAgICAgICAgICAgICAgIHMgKz0gdGhpcy5nZXRWaXNpYmlsaXR5VGV4dChtLnZpc2liaWxpdHkpICsgcnQgKyBcIiBcIiArIG0uaWRlbnRpZmllciArIFwiKFwiICtcclxuICAgICAgICAgICAgICAgICAgICBtLnBhcmFtZXRlcmxpc3QucGFyYW1ldGVycy5tYXAoKHApID0+IHsgcmV0dXJuIHAudHlwZS5pZGVudGlmaWVyICsgXCIgXCIgKyBwLmlkZW50aWZpZXIgfSkuam9pbihcIiwgXCIpICsgXCIpXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBoYXNoKHMpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBoYXNTaWduYXR1cmVBbmRGaWxlT2Yoa2xhc3M6IEtsYXNzIHwgSW50ZXJmYWNlKSB7XHJcbiAgICAgICAgcmV0dXJuIGtsYXNzLm1vZHVsZS5maWxlLm5hbWUgPT0gdGhpcy5maWxlbmFtZSAmJlxyXG4gICAgICAgICAgICB0aGlzLmdldFNpZ25hdHVyZShrbGFzcykgPT0gdGhpcy5oYXNoZWRTaWduYXR1cmU7XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbn0iXX0=